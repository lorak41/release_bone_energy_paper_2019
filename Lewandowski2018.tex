% !TeX root = ./Lewandowski2018.tex
\documentclass[twocolumn]{svjour3}   
%\usepackage{amssymb,amsthm,mathrsfs,graphicx, bm}
\usepackage{amssymb,mathrsfs,graphicx, bm}
\usepackage{natbib}
\usepackage{subcaption}
% \usepackage{titlesec}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{newtxtext,newtxmath}
\usepackage{hyperref}

\usepackage{color}
\usepackage{amsfonts}
\pagenumbering{arabic}

%Packages for Matlab2TikZ
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{plotmarks}
\usetikzlibrary{arrows.meta}
%\tikzset{every picture/.style={/utils/exec={\boldsymbol{\rm X}}{\sffamily}}}
\usepgfplotslibrary{patchplots}
\usepackage{grffile}

\usepackage{lineno,hyperref}
\usepackage{moreverb}
\usepackage[ruled,slide]{algorithm2e}



\begin{document}

\title{Framework for fracture propagation in heterogeneous and adapting bone}
\subtitle{}
\author{Karol Lewandowski \and
	{\L}ukasz Kaczmarczyk \and
	Ignatios Athanasiadis \and
	John F. Marshall\and 
	Chris J. Pearce 
}

\institute{Karol Lewandowski \at
	Glasgow Computational Engineering Centre, The James Watt School of Engineering, University of Glasgow, Glasgow, G12 8QQ, UK \\
	\email{karol.lewandowski@glasgow.ac.uk}           %  \\
	\and
	John F. Marshall \at
	Weipers Centre Equine Hospital, School of Veterinary Medicine, University of Glasgow, Glasgow, G61 1QH, UK
} 

\date{Received: date / Accepted: date}

\maketitle
% \author[gla,vet]{Karol Lewandowski\corref{cor}}
% \ead{karol.lewandowski@glasgow.ac.uk}
% \author[gla]{{\L}ukasz Kaczmarczyk}
% \ead{lukasz.kaczmarczyk@glasgow.ac.uk}
% \author[gla]{Ignatios Athanasiadis}
% \ead{ignatios.athanasiadis@glasgow.ac.uk}
% \author[vet]{John F. Marshall}
% \ead{john.f.marshall@glasgow.ac.uk}
% \author[gla]{Chris J. Pearce}
% \ead{chris.pearce@glasgow.ac.uk}
% \cortext[cor]{Corresponding author}
% \address[gla]{Glasgow Computational Engineering Centre, The James Watt School of Engineering, University of Glasgow, Glasgow, G12 8QQ, UK.}
% \address[vet]{Weipers Centre Equine Hospital, School of Veterinary Medicine, University of Glasgow, Glasgow, G61 1QH, UK,}

\begin{abstract}
Materials with spatially heterogeneous properties are present in many critical engineering applications such as in nuclear industry, for piezoelectric and thermoelastic components as well as biological systems such as bones.
This paper presents a new energy consistent formulation for brittle crack propagation in heterogeneous elastic solids within the framework of configurational mechanics.
The spatially varying material properties considered are Young's modulus and fracture energy per unit area.
Moreover, the configurational forces and fracture energy release rate, are expressed exclusively in terms of nodal quantities, avoiding the need for post-processing and enabling a fully implicit formulation for modelling the evolving crack front.
The proposed formulation is verified and validated by comparing numerical results with analytical solution for a benchmark test and experimental results, respectively.
Both crack path and load displacement curves presented very good agreement with experiments where crack path was independent of material heterogeneity for those cases.
Finally, this framework was applied to investigate crack propagation within an equine 3rd metacarpal bone for different spatially varying material properties obtained from CT scans taken at different times.
It was found that the differences in material properties between the scans result to changes of both fracture resistance and the resulting crack path.
   


%Bone adapts in response to its mechanical environment and this significantly influences both fracture resistance and propagation of the crack path. This paper presents a new approach to the computational modelling of fracture in heterogeneous and adapting materials, with specific focus on bone. This work is undertaken within the framework of configurational mechanics, extended for the first time to capture the influence of heterogeneous density distribution. The configurational forces, and fracture energy release rate, are expressed exclusively in terms of nodal quantities, avoiding the need for post-processing and enabling a fully implicit formulation for modelling the evolving crack front. The density field is generated from a combination of bone adaptation (remodelling) finite element analysis and subject-specific geometry and material properties obtained from CT scans. It is shown that, in order to correctly evaluate the configurational forces at the crack front, it is necessary to have a spatially smooth density field with high regularity. Therefore, discrete density data is approximated as a smooth density field using a Moving Weighted Least Squares method. Performance of the framework is demonstrated using numerical simulations for bone adaptation and subsequent fracture propagation, including analysis of an equine 3\textsuperscript{rd} metacarpal bone. Critically, the degree of bone adaption and bone density distribution are shown to influence both fracture resistance and the resulting crack path.

\keywords{ Finite element analysis \and bone remodelling  \and fracture  \and moving weighted least squares  \and configurational mechanics  \and heterogeneity}
\end{abstract}


%\linenumbers

\section{Introduction}

This paper presents a new thermodynamically consistent formulation for the computational modelling of brittle crack propagation in heterogeneous materials. Materials with spatially varying mechanical properties are present in many critical engineering applications. Hence, there is an increasing need for understanding the fracture behaviour within bodies with such properties.

A critical example of heterogeneous material is irradiated graphite that is a key component for operation in Advanced Gas-cooled Reactors (AGR)
Reaktor Bolshoy Moshchnosty Kanalny (RBMK) high-power channel reactors.
Graphite bricks are present to form channels for coolant fluid flow and entry and withdrawal of cooling and shutdown components \cite{Tsang2006, Steer2007}.
Through reactors' life-time, defects become present in the bricks due to high temperatures present, 
fast neutron irradiation and radiolytic oxidation, that lead to mass loss and material properties alteration leading to full crack development that can potentially compromise the reactors serviceability \cite{BrockLehurst1970, Babout2005, McNally2017}.
Recent experimental evidence for irradiated and oxidised graphite has indicated that the change of work of fracture is consistent with changes of irradiation and oxidisation levels and Young's modulus \cite{Tzelepi2018}.
Therefore, proper consideration of material properties is essential for numerical models that aim
to aid in the assessment and prediction of the life-span of AGR and RBMK reactors.

Furthermore, Functionally Graded Materials (FGM) is a class of materials whose composition (and therefore material properties) is spatially varying in a smooth fashion \cite{KawasakiWatanabe1997}.
Such materials are present both in nature (bamboo, bones and skin) and they can also be manufactured and used in critical engineering applications \cite{Jha2013, NaebeShirvan2016}.
The advantage of artificial FGMs is that they can be designed to achieve desired mechanical behaviour, for instance, to avoid functionality deterioration of for connections between different materials \cite{Erdogan1995, FinotSuresh1996}. 

In particular, bones naturally present FGM properties partially due to bone adaptation (commonly reference as bone remodelling).
Bone adaptation is the on-going biological process of replacing old bone tissue with new bone, thus repairing fatigue damage~\cite{hughes2017role}.
This ability to repair bone micro-damage caused by cyclic loading is essential for maintaining mechanical integrity. 
Therefore, different configurations of bone tissue quality and hence material properties can be observed at different times of bone life. 
Consequently, there is a strong correlation between stress fractures and the adaptation process~\cite{hughes2017role}. 
Furthermore, bone repair can be overwhelmed by load-induced bone densification that also increases brittleness and reduces fracture resistance~\cite{loughridge2017qualitative}.

Numerical have been proposed models to investigate crack propensity and stress intensity factors in FGMs,
for instance \cite{KimPaulino2002, Ayhan2009, ZhangBEM2011, ShiMan2014, ShojaeeDaneshmand2015} and found that....
However, despite the breadth and importance of applications where irradiated graphite and FGMs are present, 
numerical modelling of crack propagation within such bodies is still at early stage.
The majority of well validated models available are limited to 2D analysis \cite{KimPaulino2004,Bayesteh2013, Ooi2015, Chafi2019}.
For 3D case, a phase field model has also been proposed \cite{Hirshikesh2019}.
However, such approach is strongly mesh-size and step-size dependent that could be increasingly computationally challenging for full scale engineering applications.
Therefore, the need is still present for developing an energetically consistent model for crack propagation in heterogeneous materials.
%ChengPeriDynamics2018

This paper extends the authors' previous work on modelling fracture propagation \cite{kaczmarczyk2014three,kaczmarczyk2017energy} to incorporate the influence of spatially varying Young's modulus and fracture resistance.
To the best of author's knowledge there has been no other work to resolve crack propagation within heterogeneous bodies within the ALE framework.
This model offers computationally efficient 3D analysis tool for complicated materials by means of a monolithic approach with relatively small number of elements.
The general applicability of this work is presented by validating the model with experimental results for FGMs and then applying it to a full-scale model of equine bones using clinically available CT-scanning data.
The motivation of the present work is to develop a numerical model that can offer means to better understand crack propagation within irradiated graphite brick as well as bones at different times of their life.

This article is structured as follows. After establishing the kinematic preliminaries in Section~\ref{preliminaries}, the mathematical framework for bone adaptation is briefly presented in Section~\ref{sec:bone_remodel}. Section~\ref{sec:fracture} extends the authors' previous work for evolving crack propagation in the context of configurational mechanics. The method is utilised to calculate fracture resistance and crack propagation under quasi-static loading during different stages of adaptation. Section \ref{sec:fem_modelling} describes the finite element method implementation and Section~\ref{sec:fem_modelling} describes a special element for capturing the singular stress field at the crack front.  
All the above components are brought together into a single framework and its performance is demonstrated using a series of numerical examples in Section~\ref{sec:numerical_examples}.



%This paper presents a framework for the computational modelling of bone adaptation (commonly referred to as bone remodelling) and bone fracture, and their inter-relationship.
%Bone adaptation is the on-going biological process of replacing old bone tissue with new bone, thus repairing fatigue damage~\cite{hughes2017role}.
%This ability to repair bone micro-damage caused by cyclic loading is essential for maintaining mechanical integrity. Consequently, there is a strong correlation between stress fractures and the adaptation process~\cite{hughes2017role}. Furthermore, bone repair can be overwhelmed by load-induced bone densification that also increases brittleness and reduces fracture resistance~\cite{loughridge2017qualitative}.

%One of the first mathematical theories for bone adaptation~\cite{cowin1976bone}, based on open system thermodynamics, has its foundation in the theory of poroelasticity. 
%In this approach (unlike classical closed systems), energy, mass, momentum and entropy can be exchanged with the environment. It has been adopted and enhanced over the years
%~\cite{harrigan1996bone, jacobs1995numerical, weinans1992behavior}.
%This process of density evolution requires a~mechanical stimuli as a trigger for bone adaptation. This stimulus may take the form of stress~\cite{beaupre1990approach, carter1996mechanical, doblare2002anisotropic}, strains~\cite{cowin1976bone} or strain energy density~\cite{weinans1992behavior, kuhl2003theory,kaczmarczyk2011efficient, Connor2017bone}. 


%The use of computational tools to describe bone behaviour has gained a tremendous importance over the last decade. 
%In particular, the Finite Element Method (FEM) has been used to improve understanding of the fracture behaviour of bones and the relationships between load conditions and bone architecture~\cite{podshivalov2014road, poelert2013patient}. However, there are only a few examples of the numerical analysis of both bone adaptation and fracture, e.g.~\cite{hambli2013integrated}. This paper presents a new computational framework based on FEM in order to predict bone density profiles 
%(bone adaptation) due to exercise, quantify fracture resistance and simulate fracture propagation. This will improve understanding of the interrelationship between these phenomena and enable subject-specific simulations to be undertaken.

%A schematic of the modelling framework is presented in Figure~\ref{fig:framework}. This paper extends the authors' previous work on modelling fracture propagation \cite{kaczmarczyk2014three,kaczmarczyk2017energy} to incorporate the influence of spatially varying bone density. Furthermore, it combines this with bone adaptation \cite{kaczmarczyk2011efficient,lewandowski2017}. 

%Although this work is generic in nature and applicable to both human and animal bone, this paper focuses the numerical examples on equine bone. 

%To the best of the authors' knowledge, to date there is only one report of equine bone adaptation in a FEM framework~\cite{Wang2016}. 
%In that work, a mechanostat micro-scale model of three-dimensional cortical bone remodelling, informed by \emph{in~vivo} equine data, was presented. 
%The model used the von Mises stress as a stimulus to control microstructural cortical bone remodelling.
%In contrast, the current paper presents a full macro-scale model of equine bone response to mechanical loading, testing a hypothesis that micro-damage and fracture can be modelled at the macroscale by using clinically available CT-scanning data.
%The motivation for this work is to generate subject-specific simulations to acquire meaningful insight into bone resistance
% for veterinary practitioners.

%This article is structured as follows. After establishing the kinematic preliminaries in Section~\ref{preliminaries}, the mathematical framework for bone adaptation is briefly presented in Section~\ref{sec:bone_remodel}. Section~\ref{sec:fracture} extends the authors' previous work for evolving crack propagation in the context of configurational mechanics. The method is utilised to calculate fracture resistance and crack propagation under quasi-static loading during different stages of adaptation. Section \ref{sec:fem_modelling} describes the finite element method implementation and Section~\ref{sec:fem_modelling} describes a special element for capturing the singular stress field at the crack front.  
%All the above components are brought together into a single framework and its performance is demonstrated using a series of numerical examples in Section~\ref{sec:numerical_examples}.

\begin{figure}[h]
	   \begin{tikzpicture}
		\node at (0,0) {\includegraphics[width=7cm]{Figures/framework.png}};
	    \node at(0,-1.6){a) \hspace{2cm} b)   \hspace{1.5cm} c)   };
\end{tikzpicture}
\caption{Framework for estimating bone fracture resistance in MoFEM~\cite{mofemJoss2020}. a) Density derived from Quantitative Computed Tomography (qCT) is mapped onto finite element mesh; (b) bone adaptation analysis; (c) assessment of fracture resistance and crack propagation analysis.}
\label{fig:framework}
\end{figure}

 
\section{Preliminaries}
\label{preliminaries}
Figure~\ref{fig:domains4} shows a section of bone with an initial crack in the reference domain $\mathscr{B}_{0}$. As a result of loading, the crack extends and the body deforms elastically. Working within the framework of configurational mechanics \cite{kaczmarczyk2014three,kienzler2014configurational}, it is convenient to decompose this behaviour into an extension of the crack in the material domain  $\mathscr{B}_t$ followed by elastic deformation  in the spatial domain $\Omega_t$. The former is described by the mapping from the reference  domain to the material domain ${\boldsymbol\Xi}$, whilst the latter is described by the mapping from the material to the spatial domain ${\boldsymbol\varphi}$ - Figure~\ref{fig:domains4}.

\begin{figure}[th] 
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.7\textwidth]{Figures/domains4.eps} // by Chris (keep as a reference)
%\def\svgwidth{15cm} 	\input{Figures/Configurations.pdf_tex} 
\includegraphics[width=7cm]{Figures/domains5.pdf} 
\end{center}
\caption{Kinematics of crack propagation in elastically deforming bone.}
\label{fig:domains4}
\end{figure}

The material coordinates $\mathbf{X}$ are mapped onto the spatial coordinates $\mathbf{x}$ via the
familiar deformation map $\boldsymbol\varphi(\mathbf{X},t)$. The physical displacement is:
\begin{equation}
\mathbf{u}=\mathbf{x}-\mathbf{X}
\end{equation}
The reference material domain describes the body before crack extension. ${\boldsymbol\Xi}(\boldsymbol\chi,t)$ maps the reference material coordinates $\boldsymbol\chi$ on to the current material coordinates $\mathbf{X}$, representing a configurational change, i.e. extension of the crack due to advancement of the crack front. ${\boldsymbol\Phi}$ maps the reference material coordinates $\boldsymbol\chi$ on to the spatial coordinates $\mathbf{x}$. The current material and spatial displacement fields are given as
\begin{equation}
\mathbf{W} = \mathbf{X} - {\boldsymbol\chi}\quad\textrm{and}\quad
\mathbf{w} = \mathbf{x} - {\boldsymbol\chi}
\end{equation}
$\mathbf{H}$ and $\mathbf{h}$ are the gradients of the material and spatial maps and $\mathbf{F}$ the deformation gradient~\cite{kaczmarczyk2014three}, defined as:
\begin{equation}
\mathbf{H}=\frac{\partial {\boldsymbol\Xi}}{\partial {\boldsymbol\chi}},\quad\mathbf{h}=\frac{\partial {\boldsymbol\Phi}}{\partial {\boldsymbol\chi}},\quad\mathbf{F} = \frac{\partial \boldsymbol\varphi}{\partial \mathbf{X}} = \mathbf{h}\mathbf{H}^{-1}
\end{equation}


The time derivative of the physical displacement $\mathbf{u}$ and the deformation gradient $\mathbf{F}$ (material time derivative) are given as~\cite{kaczmarczyk2014three}:
\begin{equation}\label{eq:phy_vel}
\dot{\mathbf{u}}= \dot{\mathbf{w}}-\mathbf{F}\dot{\mathbf{W}} \qquad 
\dot{\mathbf{F}} = \nabla_\mathbf{X} \dot{\mathbf{x}} = \nabla_\mathbf{X} \dot{\mathbf{u}} = 
\nabla_\mathbf{X} \dot{\mathbf{w}} - \mathbf{F} \nabla_\mathbf{X} \dot{\mathbf{W}}
\end{equation}
 
\section{Bone adaptation} \label{sec:bone_remodel}
In this paper, the modelling of bone adaptation is based on the work of Kuhl and Steinmann~\cite{kuhl2003theory} in which bone is considered an elastic porous material. The model is stable~\cite{kuhl2003computational}, efficient~\cite{kaczmarczyk2011efficient} and capable of 
producing bone mineral density profiles that are quantitatively comparable with DEXA scans following gait analysis~\cite{pang2012computational}. 
Using this approach, bone adaptation in human scapula~\cite{liedtke2017computational}, 
tibia~\cite{pang2012computational}, humerus~\cite{taylor2009phenomenon} and femur with various surgical implants~\cite{ambrosi2011perspectives, Connor2017bone} have been simulated and its potential in topology optimization~\cite{waffenschmidt2012application} has been explored. 
One of the advantages of such a phenomenological approach is that only a small number of parameters are required, which can be experimentally
determined from, for example, CT imaging~\cite{zadpoor2013open}.


 \subsection{Conservation of mass}

Following Kuhl and Steinmann~\cite{kuhl2003computational}, it is assumed that
the rate of change of the time-dependent material density is in equilibrium
with mass flux, expressed as:
\begin{equation} \label{eq:mass_balance}
\frac{\partial\rho}{\partial t}  + \dot{\mathbf{W}} \cdot  \nabla_\mathbf{X} \rho = 
\nabla_{\boldsymbol {\rm X}} \cdot \mathbf{R} + \mathcal{R}_0
\end{equation}
where $\rho$ is mass density and $\mathcal{R}_0$ is the locally created mass.
It is worth noting that, comparing to Kuhl and Steinmann, we require a material time derivative since the reference material configuration is changing, leading to the addition of the second term in Eq.~\ref{eq:mass_balance}. This is only a kinematic extension of the formulation and does not change the description of the physical problem. 

Furthermore, $\mathbf{R}$ is the mass flux defined as:
% 
\begin{equation}
\mathbf{R} = \mathcal{R} \nabla_\mathbf{X} \rho
\label{eq:mass_flux}
\end{equation}
% 
where $\mathcal{R}$ is mass conductivity. The term on the right hand side of Eq. \ref{eq:mass_balance}
is the material time derivative associated with the evolving current material
configuration. 
However, in the present work it is assumed that the mass flux $\mathbf{R}$ is zero and hence only the local mass source $\mathcal{R}_0$ contributes to the changes in density.


\subsubsection{Constitutive relationship for bone adaptation}

\label{sec:constitutive_eq}

In the context of bone mechanics, the constitutive law for the mass source $\mathcal{R}_{0}$ is commonly in the form proposed by Harrigan and Hamilton~\cite{Harrigan1993}. This well established approach has been used e.g. in \citep{harrigan1996bone, taylor2009phenomenon, pang2012computational, hambli2013integrated, kuhl2003computational}. 
It is assumed that the local increase/decrease in density is governed by the elastic energy as follows:
\begin{equation}
\mathcal{R}_{0}=c\left[\Biggl[\frac{\rho}{\rho_{0}^{\ast}}\Biggr]^{-m}\Psi
-\Psi^{\ast}\right]
\label{eq:mass_source}
\end{equation}
where $\rho_0^\ast$ and $\Psi^\ast$ represent reference values of the
density, $\rho$ and free energy, $\Psi$, respectively. The driving term
$\left[ \rho / \rho_0^\ast \right]^{-m}\Psi$ tends to converge to
$\Psi^\ast$ (see Eq.~(\ref{eq:mass_source})) when density saturation is
achieved and local generation of bone ceases. The exponent $m$ is a
dimensionless scalar introduced to guarantee uniqueness and
stability~\cite{Harrigan1993}. The coefficient $c$ controls
the rate of the adaptation process with units~$[\rm{s/cm^2}]$. 
% As proposed in~\cite{Waffenschmidt2012}, it can be beneficial to prescribe an upper and
% lower bound for bone density, thereby avoiding spurious or non-physical
% values (lower than zero or greater than observed maximum). In this paper, the parameter $c$, which is conventionally considered 
% to be constant, is replaced by a bell function
% defined as:
% \begin{equation}
% \begin{aligned}
% c(\rho) = & \frac{1}{1 + \left[  (\rho - \rho^{\mathrm{mid}}) / 
% (\rho{^\mathrm{max}} - \rho{^\mathrm{mid})} \right]^{2 b}}\\
% & \mathrm{with} \quad \rho^{\mathrm{mid}} = 
% \frac{\rho{^\mathrm{max}} + \rho{^\mathrm{min}}}{2}
% \end{aligned}
% \label{eq:bell_function}
% \end{equation}
% $\rho^\mathrm{max}$ and $ \rho{^\mathrm{min}}$ where $\rho^\mathrm{max}$
% and $\rho^\mathrm{min}$ are the maximum and minimum values of $\rho$, and
% $\rho^{\rm {mid}}$ is their average. The bell function
% (\ref{eq:bell_function}) is illustrated in Figure~\ref{fig:bell_func} for
% different values of the integer exponent, $b$. Its application and influence
% on the overall results are elaborated in
% Section~\ref{sec:numerical_examples}.
% \begin{figure}[!htb]
% 	\centering
% 		\input{Figures/tikz/myfile_bell.tex}
% 		\caption{Bell function for parameter $c$ for different values of the integer exponent $b$. 
% 		As $b \rightarrow \infty$, the bell-shape curve becomes infinitely steep at 
% 		$\rho{^\mathrm{min}}$ and $ \rho{^\mathrm{max}}$.}
% 		\label{fig:bell_func}
% \end{figure}

In most cases, the values of parameters for bone adaptation models are chosen using trial and error approach based on the outcome of the predictions. Ideally, these values should be obtained by solving an inverse model based on bone anatomy, loading, and density data, as proposed in \citep{zadpoor2013open}. However, it still remains an open challenge in computational biomechanics. In this work, the parameters are based on previously validated investigations of human tibia \cite{pang2012computational}, together with an adjustment for the higher stiffness measured in equine bones \cite{Les1994}.

\subsection{Elastic constitutive relationship}
As an elastic cellular material, the free energy $\Psi (\mathbf F, \rho)$ for bone is typically weighted by the relative density \citep{gibson1982mechanics,Kuhl2003a,pang2012computational,Waffenschmidt2012} as follows:
\begin{equation}
\Psi=\left[\frac{\rho}{\rho_{0}^{\ast}}\right]^{n}\Psi^{\mathrm{neo}},
\label{eq:free_energ}
\end{equation}
where $\Psi^{\rm {neo}}$ is the Helmholtz free energy for a Neo-hookean material, which is expressed in terms of the right Cauchy-Green deformation tensor $\boldsymbol{\rm{C}}$:
\begin{equation}
\Psi^{\mathrm{neo}}=\frac{\mu}{2}\left[\textrm{tr}(\mathbf{C})-3\right]-\mu\ln(\sqrt{\det\mathbf{C}})+\frac{\lambda}{2}\ln^{2}(\sqrt{\det\mathbf{C}})
\end{equation}
where $\mu$ and $\nu$ are the Lam\'e constants. Moreover, the exponent $n$ is a
non-physical parameter that typically varies as $1 \leq n \leq 3.5$, 
depending on the porosity of the material~\cite{Gibson2005}. 
%This isotropic constitutive law can be extended for the case of anisotropy, if required, using the micro-sphere framework~\cite{Waffenschmidt2012}.

Bone adaptation is a mechanically driven process, whereby the density field evolves in response to the mechanical environment. Likewise, the material stiffness is directly dependent on the density and this, in turn, influences the mechanical response. Therefore, the equation for conservation of mass \ref{eq:mass_balance} is coupled with the equation for linear momentum balance:
\begin{equation} \label{eq:linear_momentum}
\nabla_{\mathbf X} \cdot \mathbf P = 0
\end{equation}
where $\mathbf P$ is the the first Piola-Kirchhoff stress:  
\begin{equation}
\mathbf P = \frac{\partial \Psi (\mathbf F, \rho)}{\partial \mathbf F}
\end{equation}
% 
This coupled system of equations is solved using the finite element method - see Section \ref{sec:numerical_examples:bone_adap}.

\section{Fracture resistance and fracture propagation}
\label{sec:fracture}
Various theories exist in the literature regarding failure criteria for bone tissue and it is now common practice for researchers to estimate fracture resistance within the framework of FEM. In particular, subject-specific FEM models can potentially quantify the risk of failure under a given loading scenario. However, this still remains an open challenge.

In recent years, the main focus in bone mechanics was in the use of different strength criteria for the onset of failure. 
The most commonly adopted ones were based on stress~\cite{keyak2005predicting} or strain measures~\cite{schileo2008subject} assuming bone failure is determined by a yield criterion~\cite{yosibash2010predicting}. 
Experimental validation of such simplified models show that there is a significant spread in the predicted failure, with errors between 10\% and 20\%~\cite{van2014accurately}.
This variation is explained perhaps by the focus on the local initiation of failure, rather than the complete failure mechanism. 
The fracture process of bone is very important,  particularly in the case of fatigue fractures~\cite{gupta2008fracture}. 
Limitations in previous studies (e.g. use of 2D geometry~\cite{bettamer2017using}, assuming homogeneous bone properties~\cite{gasser2007numerical}), 
can also explain why an appropriate model for bone fracture has not been developed previously.

This paper builds on the authors' computational framework~\cite{kaczmarczyk2017energy} for brittle fracture within the context of configurational mechanics, extending it here to include the influence of heterogeneous materials such as bone.
The concept of configurational forces was originally introduced by Eshelby~\cite{eshelby1951force}. 
Unlike physical forces, configurational forces act on the material manifold and represent the tendency of imperfections like cracks, voids or material inhomogeneities to move relative to the surrounding material. 
The past two decades have seen a growing interest in this approach for analysis of material imperfections~\cite{maugin2016configurational} and in particular for evaluating the forces driving crack advancement~\cite{kaczmarczyk2017energy,steinmann2001application, ozencc2016configurational}. 
However, until recently this approach has never been used to effectively assess configurational forces in heterogeneous bodies with cracks. 

In the current study, additional configurational forces arising from inhomogeneities~\cite{kienzler2014configurational}
associated with spatially varying bone density are introduced into the formulation. This allows for the accurate assessment of the likelihood of a crack to propagate and to simulate  the subsequent propagation of fractures in bone. 
An additional goal is to investigate bone fracture at different stages of bone adaptation, utilising either the results from bone adaptation analysis (Section~\ref{sec:bone_remodel}) or data directly taken from CT scans. 
Similar concepts of combined adaptation and fracture analyses has been presented before~\cite{hambli2013integrated}. 
However, it utilised a different adaptation model and continuum damage mechanics approach for fracture, both of which require many more parameters to calibrate. 
% 
\subsection{First and second laws of thermodynamics}

The first law of thermodynamics can be expressed as 
\begin{equation}
\label{eq::first_law}
\int_{\partial \mathcal B_t} {\dot {\boldsymbol {\rm u} } } 
\cdot \mathbf t \mathrm d S = \int_{\partial \Gamma } \gamma(\rho) \dot A_\Gamma +
{\frac{\mathrm d}{\mathrm d t }} 
\int_{\mathcal B_t} \Psi(\mathbf F, \rho) \mathrm d V
\end{equation}
where the left hand side is the power of external work, the first term on the
right hand side is the rate of crack surface energy and the last term is
the rate of internal energy. $\mathbf t$ is the external
traction vector, $\gamma $ is the surface energy $[ {\rm{N m}}^{-1} ]$, $\dot{A}_\Gamma$ is the change in the
crack surface area and
$\Psi$ is the volume specific free energy. The crack surface $\Gamma$ comprises two crack faces and a crack front $\partial\Gamma$ - see Figure~\ref{fig:crac_surf_construct}.

\begin{figure}[th]
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.8\textwidth]{Figures/crack3.eps} 
\def\svgwidth{7cm} 	\input{Figures/CrackSurface.pdf_tex} 
\end{center}
\caption{Crack construction. In 2D (left) and in more detail in 3D (right).}
\label{fig:crac_surf_construct} 
\end{figure}


The power of external work on the elastic body with the use of Eq.~(\ref{eq:phy_vel}) is given as: 
\begin{equation} \label{eq:extern_pow}
	\mathscr{P} =\int_{\partial \mathscr{B}_{t}} \dot{\mathbf{u}} \cdot \mathbf{t} \operatorname{d} S=\int_{\partial \mathscr{B}_{t}}\left\{\dot{\mathbf{w}} \cdot \mathbf{t}-\dot{\mathbf{W}} \cdot \mathbf{F}^{\mathrm{T}} \mathbf{t}\right\} d S
\end{equation}

In~\cite{kaczmarczyk2017energy}, a kinematic relationship between the change in the
crack surface area $\dot{A}_\Gamma$ and the crack front velocity $\dot{\mathbf{W}}$ was derived that is given as:
\begin{equation}
\label{eq::Agamma2}
\dot{A}_\Gamma
 =
\int_{\partial\Gamma}
\mathbf{A}_{\partial\Gamma} \cdot \dot{\mathbf{W}} \textrm{d}L
\end{equation}
where 
$\mathbf{A}_{\partial\Gamma}$ is a dimensionless kinematic state variable that defines the orientation of the current crack front that can be considered a unit vector normal to the crack front and tangential to the crack surface. In deriving this expression, it was recognised that any change in the crack surface area $\dot{A}_\Gamma$ in the current material space can only occur due to motion of the crack front.

% following the reviewers suggestion we put a more detailed derivation
Assuming that no dissipation of energy occurs within the volume of the body (i.e. restricted to the creation of new crack surfaces) and given that $\mathrm d \dot V = \nabla _{\mathbf X} \cdot \mathbf{\dot W} \mathrm d V$, the change of the specific free energy can be expressed as:
\begin{equation} \label{eq:psi_time}
	\begin{aligned}
		\frac{\mathrm{d}}{\mathrm{d} t} \int_{\Omega} & \Psi(\mathbf{F}, \rho) \mathrm{d} \Omega =& \\
		& \int_{\Omega} \nabla_{\mathbf{X}} \dot{\mathbf{w}}: \mathbf{P} 
		+ \nabla_{\mathbf{X}} \dot{\mathbf{W}}: \Sigma 
		+ \mathbf f^\mathrm{inh} \cdot \dot{\mathbf{W}} \mathrm{d} \Omega
	\end{aligned}
	\end{equation}
where
\begin{equation}
\begin{aligned}
{\bm {\Sigma}} =
\Psi(\mathbf F, \rho) \mathbf  1 - \mathbf F^{\rm T} 
\mathbf P(\mathbf F, \rho),
%\mathrm{and} \quad
\end{aligned}
\end{equation}
${\bm {\Sigma}}$ is the Eshelby stress tensor and
$\mathbf f^{\mathrm {inh}}$ is an additional fictitious force that arises from variations in the density field and drives the crack front from dense to less dense material. $\mathbf f^{\mathrm {inh}}$  is computed as follows:
\begin{equation}
	\mathbf f^{\mathrm{inh}} =  \left(\frac{\partial \Psi}{\partial \mathbf{X}}\right)_{\mathrm{expl.}}
\end{equation}
where the explicit derivative of $\Psi$ is defined by 
\begin{equation}
	\left(\frac{\partial \Psi}{\partial \mathbf{X}}\right)_{\mathrm{expl.}} = 
	\left.
	\frac{\partial \Psi}{\partial \rho}
	\right|_{(\mathbf{F} = {\rm{const}})}
	\frac{\partial \rho}{\partial \mathbf X} 
\end{equation}
% 
Making use of Equations~(\ref{eq:extern_pow}), (\ref{eq::Agamma2}) and (\ref{eq:psi_time}), Equation~(\ref{eq::first_law}) can be reformulated as:
% 
\begin{equation}\label{eq:crack_first_law}
\begin{aligned}
\int_{\partial \mathcal B_t} \big( {\dot {\boldsymbol {\rm w} } } \cdot \mathbf t - 
{\dot {\boldsymbol {\rm W} } } \cdot \mathbf F^{\rm T} \mathbf t \big) \mathrm d S = 
\int_{\partial \Gamma } \gamma \mathbf A_{\partial \Gamma} 
\cdot {\dot {\boldsymbol {\rm W} } } \mathrm d L \\
+ \int_{\mathcal B_t} 
\big( \mathbf P\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm w} } } + 
{\bm  \Sigma}\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm W} } } 
+  \mathbf f^{\mathrm {inh}} \cdot \dot{\mathbf{W}}
\big) \mathrm d V 
\end{aligned}
\end{equation}

The spatial conservation law of linear momentum balance is repeated here:
\begin{equation} \label{eq:linear_momentum2}
\nabla_{\mathbf X} \cdot \mathbf P = 0
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
\mathbf{P}\mathbf{N} = \mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
where $\partial\mathcal B_t^\sigma$ is the region of the boundary where tractions are applied. 

The equivalent material momentum balance is expressed as:
\begin{equation}
\nabla_{\mathbf X } \cdot {\bm {\Sigma}}= \mathbf f^{\mathrm {inh}}
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
{\bm {\Sigma}}\mathbf{N} = \mathbf{F}^\textrm{T}\mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
It is important to note that $\mathbf f^{\mathrm {inh}}=\mathbf{0}$ in the case of homogeneous materials, with uniform density distribution.

After applying the divergence theorem to Eq.~(\ref{eq:crack_first_law}) and recognising the momentum balance laws, we follow~\cite{kaczmarczyk2017energy} to establish a local form of Eq.~(\ref{eq:crack_first_law}), which represents an expression for equilibrium of the crack front as
%Following, the divergence theorem is applied to gradient terms. Considering the volume and boundary integrals, and grouping together terms that are work conjugate to the spatial and material velocities, the local conservation laws are obtained. 
%Furthermore, the surface $\mathcal C$ (Figure~\ref{fig:frac_crack_con})
%collapses to the crack front $\partial \Gamma $ and integrals over the crack
%front are simplified as follows [REF]:
%\begin{equation}
%\lim_{\mathcal C \to 0} \int_{\mathcal C} (\cdot ) \mathrm d S = \lim_{\mathcal C \to 0} \int_{{\mathcal L}_{\rm t}} \int_{ {\mathcal L}_{\rm n}} (\cdot) \mathrm d S = \int_{\partial \Gamma} \lim_{|\mathcal{ L }|\to 0} \int_{{\mathcal L}_{\rm n} } (\cdot ) \mathrm d S
%\end{equation}
%with the integrals at crack front:
%Following \cite{kaczmarczyk2017energy}, the an expression for equilibrium of the crack front is expressed as
\begin{equation}\label{eq:crack_local_first_law}
	{\dot {\boldsymbol {\rm W} } } \cdot 
	\left( \gamma \mathbf A_{\partial \Gamma} - \mathbf G \right) = 0
\end{equation}
where the configurational force $\mathbf{G}$ is the driving force for crack propagation:  
\begin{equation}
	\mathbf G = \lim_{|\mathcal{ L }|\to 0} 
	\int_{ {{\mathcal L}_{\rm n}} } {\bm {\Sigma}}\mathbf{N}\, \mathrm d L 
	\label{eq:crack_configuration_force}
\end{equation}
From this equation, it is clear that the crack front is in equilibrium when the crack is not propagating, i.e. material
velocity $\dot{\mathbf{W}}$ at the crack front is zero, or when the crack front is propagating and the configurational force
is in equilibrium with the material resistance $\gamma \mathbf A_{\partial \Gamma}$. 

It should be noted that crack front equilibrium is unaffected by material heterogeneities and does not depend on $\mathbf f^{\mathrm {inh}}$. All terms in Eq.~\ref{eq:crack_local_first_law} are only evaluated at the crack front. However, it will be shown in Section~\ref{sec:fem_fracture_prop} that, in a discrete setting, calculation of the nodal configurational forces involves a volume integral of the density gradient.

Since Eq.~(\ref{eq:crack_local_first_law}) has more than one solution at equilibrium, depending on whether the crack 
does or does not propagate, the formulation is supplemented by a straightforward criterion for crack growth, equivalent to Griffith's  criterion~\cite{kaczmarczyk2017energy}:
\begin{equation} \label{eq:grif1}
\phi(\mathbf{G}) = 
\mathbf{G} \cdot \mathbf{A}_{\partial\Gamma} - g_c/2 \leq 0
\end{equation} 
where $g_c=2\gamma(\rho)$ is a material parameter specifying the critical threshold of energy release
per unit area of the crack surface $\Gamma$, also known as the Griffith energy. Note that in context of inhomogeneous materials it may depend on the density $\rho$. For a point on the crack front to satisfy the crack growth criterion, 
either $\phi<0$ and $\dot{\mathbf{W}}=0$, or $\phi=0$, $\dot{\mathbf{W}}\ne 0$ and $\gamma\mathbf{A}_{\partial\Gamma}=\mathbf{G}$. 


The direction of fracture propagation is
constrained by the second law of thermodynamics. Here we assume that fracture takes place
relatively fast compared to the process of adaptation (with no healing), 
such that non-negative dissipation at the crack front can be expressed as
\begin{equation}
	\mathcal{D} = \gamma \dot{\mathbf{W}} \cdot \mathbf{A}_{\partial\Gamma}= \dot{\mathbf{W}} \cdot \mathbf{G}\ge0
\end{equation}

% It should be noted that the well-established stress intensity factors are not applicable 
% in the case of heterogeneous materials, since it requires the existence of
% an analytical solution for the stress field in the vicinity of the crack front that is
% independent of arbitrary distribution of density. 
% Similarly, the use of
% J-integrals requires integration over the closed surface without
% inhomogeneities (including heterogeneous density distribution), except for the crack front itself and therefore not applicable in this case.
Finally, it is worth noting that the current framework is formulated within 
the realm of large displacements and large strains, hence it 
is generally valid under any assumption for strains and displacements. 

\subsection{Density field}
\label{sec:dens_mapping}
The previous subsections have shown that  fracture modelling of bone is influenced by the density distribution in the material configuration. This density field can be generated from either (a) a bone adaptation analysis, solving both Eqs~(\ref{eq:mass_balance}) and (\ref{eq:linear_momentum2}), or (b) subject-specific data (geometry and material properties) available from, for example, computed tomography (CT) scans. Previous examples in the literature of subject-specific modelling to assess the stresses and fracture resistance of bones can be found in~\cite{poelert2013patient,Helgason2008b,yosibash2010predicting}. Most algorithms that use voxel data have simply averaged~\cite{zannoni1999material} or integrated data onto finite elements, thereby supplying a constant density within their volume~\cite{taddei2007material, schileo2008subject}. In this paper, radiopacity associated with each 3D voxel from CT scan data is spatially approximated. 

In the numerical examples described later, both sources of density data are used. It will be shown in the next section that, in order to evaluate the configurational forces at the crack front, it is necessary to have a spatially smooth density field. Therefore, discrete density data will need to be approximated as a smooth density field, and this will be achieved by adopting the Moving Weighted Least Squares (MWLS) method. This mapping approach was chosen since it offers higher regularity (i.e. higher derivatives exist) than when the field is
directly approximated on the finite element mesh. Full details are given in \cite{karol_lewandowski_moving_2019}.  %LINK TO ZENODO


\section{Finite element modelling} \label{sec:fem_modelling}

This section considers the sequential analysis of bone adaptation and fracture propagation, although it is recognised that the density field could be obtained directly from subject-specific data, in which case it may not be necessary to undertake the bone adaptation analysis. A sequential approach is justified since the process of bone adaptation takes place at a much longer time scales than fracture.

Three-dimensional domains are discretised with tetrahedral finite elements. 
Fields are approximated in the current material and current spatial spaces with 
hierarchical basis functions of arbitrary polynomial order, following the work of Ainsworth and Coyle~\cite{Ainsworth2003}.  
\begin{eqnarray}
	\rho^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) {\tilde{\pmb\uprho}}(t) \\
	\mathbf{ X}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) \tilde {\mathbf{ X}}(t), 
	\quad \mathbf{x}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}) {\tilde{\mathbf{x}}}(t) \\
	\mathbf{ W}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm \upchi}}) {\dot { \tilde {\boldsymbol {\rm W} } }}(t), 
	\quad \mathbf{w}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}){\dot { \tilde {\boldsymbol {\rm w} } }}(t)
	\label{eq:discretisation}
\end{eqnarray}
where $\mathbf{\Phi}$ are shape functions, superscript $h$ indicates approximation and $(\tilde \cdot)$ nodal
values. Moreover, the smoothed density field is approximated by MWLS shape functions
\begin{equation}
	\rho^{h,\textrm{MWLS}}(\mathbf{X},t) = \Phi^\textrm{MWLS}(\mathbf{X}) 
	\tilde{\pmb\uprho}^h(\Xi({\boldsymbol {\rm \upchi}}),t) 
\end{equation}
It should be noted that shape functions $\Phi^\textrm{MWLS}(\mathbf{X})$ are evaluated at
current material points, $\mathbf{X}$, rather than reference points, $\pmb\upchi$, as presented in Eq.~(\ref{eq:discretisation}) with the property of partition of unity.
Since the density field is evaluated at $\mathbf{X}$, the approximation is independent of changes of the material configuration (i.e.
changing mesh).
% 
\subsection{Bone adaptation}
The bone adaptation problem is solved with a staggered approach, the material configuration is fixed
such that:
\begin{equation}
	\tilde {\mathbf{ X}}(t)	= \tilde {{\boldsymbol {\rm \upchi}}} =  \textrm{const}
	\;\;\textrm{and}\;\;
	\dot{\tilde {\mathbf{X}}}(t) = \dot{\tilde {\mathbf{W}}}(t) = 0
\end{equation}
where $\tilde {{\boldsymbol {\rm \upchi}}}$ is vector of nodal positions. The semi-discrete
form of equations (\ref{eq:mass_balance}) and (\ref{eq:linear_momentum}) take
the form of residuals
\begin{equation}
	\left\{
	\begin{aligned}
		\mathbf{r}^\rho(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) &=
		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\dot{\tilde{\pmb\uprho}}^h({\boldsymbol {\rm \upchi}},t) 
		\textrm{d}V \\
		&+ 
		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T} 
		\mathcal{R} \nabla_\mathbf{X}\pmb{\Phi} \tilde{\pmb\uprho}
		\textrm{d}V \\
		&-	
		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} \mathcal{R}^h_0 
		\textrm{d}V	 \\
		&-
		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} 
		\mathbf{q}^\textrm{external} 
		\textrm{d}S	
		= \mathbf{0}\\
		\mathbf{r}^x(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) &=
		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X}\pmb{\Phi}^\textrm{T}\mathbf{P}^h\textrm{d}V \\
		&-
		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\mathbf{f}^\textrm{ext, adapt}\textrm{d}S	
		= \mathbf{0}
	\end{aligned}
	\right.
\end{equation}
where $\mathbf{r}^\rho$ is the vector of residuals related to mass density flux 
equilibrium, $\mathbf{q}^\textrm{external}$ is influx of mass across the boundary, 
$\mathbf{r}^x$ is the vector of residuals associated with balance of linear momentum and
$\mathbf{f}^\textrm{ext, adapt}$ are averaged long term forces
mimicking mechanical load on the bone over long time period and $\mathcal{R}$ is mass conductivity. A truncated Taylor series expansion leads to the  semi-discrete form, expressed as:
\begin{equation}
\begin{split}
	\left[
		\begin{array}{c}
			\mathbf{r}^\rho(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))\\
			\mathbf{r}^x(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))
		\end{array}
	\right]
	+
	\left[
	\begin{array}{cc}
		\mathbf{M}_{\rho\rho} & \mathbf{0}\\
		\mathbf{0} & \mathbf{0}
	\end{array}
	\right]
	\left\{
		\begin{array}{c}
		\delta\dot{\tilde{\pmb\uprho}}_{i+1}(t)\\
		\delta\dot{\tilde{\mathbf{x}}}_{i+1}(t)
		\end{array}
	\right\}
	\\ + 
	\left[
		\begin{array}{cc}
			\mathbf{K}_{\rho\rho} & \mathbf{K}_{\rho x}\\
			\mathbf{K}_{x\rho} & \mathbf{K}_{xx}
		\end{array}
		\right]
		\left\{
			\begin{array}{c}
			\delta\tilde{\pmb\uprho}_{i+1}(t)\\
			\delta\tilde{\mathbf{x}}_{i+1}(t)
			\end{array}
		\right\}
		=
		\left[
			\begin{array}{c}
				\mathbf{0}\\
				\mathbf{0}
			\end{array}
		\right]
		\end{split}
		\label{eq:tangent_remodelling}
\end{equation}
with
\begin{equation}
\begin{split}
\mathbf{M}_{\rho\rho} = 
\left.
\frac{\partial \mathbf{r}^\rho}{\partial \dot{\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
\mathbf{K}_{\rho\rho} = 
\left. 
\frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\, \\
\mathbf{K}_{\rho x} = 
\left.
\frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\mathbf{x}}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
\mathbf{K}_{x \rho} = 
\left.
\frac{\partial \mathbf{r}^x}{\partial {\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\, \\
\mathbf{K}_{x x} = 
\left.
\frac{\partial \mathbf{r}^x}{\partial {\tilde{\mathbf{x}}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},
\end{split}
\end{equation}
and 
\begin{equation}
\begin{split}
	\tilde{\pmb\uprho}_{i+i}(t) =
	\tilde{\pmb\uprho}_{i}(t) + \delta\tilde{\pmb\uprho}_{i+i}(t),\\
	\tilde{\mathbf{x}}_{i+i}(t) =
	\tilde{\mathbf{x}}_{i}(t) + \delta\tilde{\mathbf{x}}_{i+i}(t)
\end{split}
\end{equation}
where $(\cdot)_i$ is quantity at Newton iteration $i$. Finally, the
above semi-discrete problem is discretised in time using implicit Euler scheme:
\begin{equation}
	\dot{\tilde{\pmb\uprho}}_{i+i}^{n+1}(t) =
	\frac{
	\tilde{\pmb\uprho}_{i+i}^{n+1}-\tilde{\pmb\uprho}^{n}
	}{\Delta t}
\end{equation}
where $\Delta t$ is length of time step, and $n$ is time step number.

Note that the density field variables are approximated using polynomial bases functions that are one order less than those used for the spatial position variables, thereby ensuring a stable solution without oscillations.

The discretised balance equations are solved iteratively using the Newton-Raphson method for the displacements and density.

%NECESSARY??
%
%Two approaches have been implemented regarding evaluations of tangent stiffness,
%i.e by either analytically evaluating the higher dimensional derivatives of the residuals of $\mathbf{r}_{x}$ and $\mathbf{r}_{\rho}$ as 
%presented in Eq.~(\ref{eq:tangent_remodelling}) or by means of automatic differentiation using the ADOL-C 
%library~\cite{Walther2009}. At this point, it is interesting to note that analyses presented in this paper using automatic 
%differentiation are about 25~$\%$ slower than the analytical formulation due to increased assembly time.
%Nevertheless, ADOL-C significantly simplifies the implementation process, it is then reasonable to use it at the early stages of development.
%
\subsection{Fracture propagation} \label{sec:fem_fracture_prop}

Given that the bone adaptation and fracture propagation problems have different boundary conditions and geometry they are solved as 
a staggered coupled problem. Initially bone adaptation is simulated under 
long-term effective loads applied without initial crack. Subsequently, an 
initial crack is inserted to compute the effect 
of short-term loads or extreme cyclic loading. The two different meshes for bone adaptation and fracture propagation 
are tailored for the specific analysis at hand. As
a consequence, the approximated Piola stress tensor for bone
adaptation is expressed as follows:
\begin{equation}
	\mathbf{P}^\textrm{h} = 
		\mathbf{P}(\mathbf{F}^\textrm{h}, \rho^h)
\end{equation}
whereas, for the fracture propagation problem, it is approximated as
\begin{equation}
	\mathbf{P}^{\textrm{h},\textrm{MWLS}} = 
		\mathbf{P}(
		\mathbf{F}^\textrm{h}, \rho^{h,\textrm{MWLS}})
\end{equation}

The residual force vector in the discretised spatial domain is expressed in the classical way as:
\begin{equation}
\begin{aligned}
\label{spatial_residual}
	\mathbf{r}_\textrm{s}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) =& \tau\mathbf{f}^\textrm{h}_\textrm{ext,s}-\mathbf{f}^\textrm{h}_\textrm{int,s}= \\
	&\tau \int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}
	\mathbf{f}^\textrm{ext}
	\textrm{d}S\\
	&- \int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T}
	\mathbf{P}^{h,\textrm{MWLS}}\textrm{d}V=\mathbf{0}
	\end{aligned}
\end{equation}
where $\tau$ is the unknown scalar load factor, $\mathbf{f}^\textrm{h}_\textrm{ext,s}$ is the vector of externally applied forces and $\mathbf{f}^\textrm{h}_\textrm{int,s}$ is the vector of internal forces. 

Discretisation of Eq.~\ref{eq:crack_local_first_law} establishes the material counterpart to Eq.~\ref{spatial_residual}, expressed as
\begin{equation}
\label{material_residual}
\mathbf{r}_\textrm{m}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) = \mathbf{f}^\textrm{h}_\textrm{res}-\tilde{\mathbf{G}}^\textrm{h}=\mathbf{0}
\end{equation}
$\tilde{\mathbf{G}}^\textrm{h}$ is the vector of nodal configurational forces only on nodes on the crack front, with the integration restricted to elements adjacent to the crack front:
\begin{equation}
\begin{aligned}
	\tilde{\mathbf{G}}^\textrm{h} =&
	\int_{\mathcal{B}^h_t}
		\nabla_\mathbf{X}\pmb{\Phi}^\textrm{T} {\pmb\Sigma}^{h,\textrm{MWLS}}
	\textrm{d}V \\
	+&
	\int_{\mathcal{B}^h_t}
		\pmb{\Phi}^\textrm{T} \dfrac{\partial {\Psi}^{h,\textrm{MWLS}} }{\partial \rho^{h,\rm{MWLS}}}
		\left(
			\frac{\partial 
			\rho^{h,\textrm{MWLS}}}{\partial \mathbf{X}}
		\right)
	\textrm{d}V
	\label{eq:mat_int_front}
	\end{aligned}
\end{equation}
These configurational forces are the driving force for crack propagation. It should be noted that the second term of $\tilde{\mathbf{G}}^\textrm{h}$ reflects the influence of the spatially varying density. In the case of a homogeneous material, this second term would be zero. It should also be noted that this is only the case for the discretised configurational forces and that the continuum equivalent (Eq.~\ref{eq:crack_configuration_force}) is unaffected by variation in the density field.

$\mathbf{f}^\textrm{h}_\textrm{res}$ is the vector of nodal material resistance forces, given as:
\begin{equation}
\mathbf{f}^\textrm{h}_\textrm{res}=\frac{1}{2}\left(\tilde{\mathbf{A}}_\Gamma^\textrm{h}\right)^\textrm{T}\mathbf{g}_\textrm{c}(\rho^{h,\textrm{MWLS}})
\end{equation}
where $\mathbf{g}_\textrm{c}$ is a vector of size equal to the number of nodes on the crack front. $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ defines the current orientation of the crack front and is a matrix comprising direction vectors along the crack front that are normal to the crack front and tangent to the crack surface:
\begin{equation}
\tilde{\mathbf{A}}_\Gamma^\textrm{h} = 
\int_{S^h_\Gamma}
\pmb{\Phi}^\textrm{T} 
\frac{\partial {A}^h_{\Gamma}}{
\partial \tilde{\mathbf{X}}}
\textrm{d}L
\end{equation}
$\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ is evaluated by only integrating over $S_\Gamma^\textrm{h}$ that defines the area of those triangular finite elements that discretise the crack surface $\Gamma^\textrm{h}$ adjacent to the crack front $\partial\Gamma^\textrm{h}$.
$A^\textrm{h}_{\Gamma}$ is calculated as:
\begin{equation}
A^\textrm{h}_{\Gamma} = 	
	\| \mathbf{N}(\tilde{\mathbf{X}}) \|
=
\left\| 
\epsilon_{ijk}
\frac{\partial \Phi^\alpha}{\partial \xi_0}  
\frac{\partial \Phi^\beta}{\partial \xi_1} 
\tilde{X}^\alpha_j
\tilde{X}^\beta_k
\right\|
\end{equation}
where $\alpha, \beta \in \{0, 1, 2\}$ are the number of nodes of the triangle,
$i,j,k \in \{0,1,2\}$ are material indices and $\boldsymbol{\upepsilon}$~is the Levi-Civita tensor, $\xi_0$ and $\xi_1$ are the directions of the parent coordinate system of the triangular element. 
Moreover, the total number of degrees of freedom on element is $3(N_{\rm{base}}+1)$ and the units of $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ are $[{\rm m}^{-1}]$. $\mathbf{N}$ are the normals to the crack surface $\Gamma$.


\section{Singularity element}
\label{sec:singularity}
For the purposes of determining parameters such as stress intensity factors, it can be useful to reproduce the singular stress field at the crack front. However, conventional finite elements that adopt polynomial approximation functions are unable to do this. 
In this paper a new type of finite element with hierarchical approximation functions that overcome this problem is utilised. This is inspired by the so-called quarter-point elements, originally developed in the 1970s, whereby the mid-node of all edges connected to the crack tip node were shifted to the quarter-point~\cite{barsoum1976use,henshell1975crack}. 

The result of such a shift is a nonlinear mapping between natural (isoparametric) and local coordinates $\xi \rightarrow \mathbf x$ which produces the square root singularity. Stress and strain fields are dependent on the radial function of the crack tip, reaching infinity as $ r \rightarrow 0$. 

In this work, all bodies are discretised using 3D tetrahedral elements. A detailed derivation of the Jacobian for three-dimensional quarter-point elements can be found in, for example in~\citep{nejati2015use}. 
The influence of this approach is investigated in Section~\ref{sec:release_energy_rate}.
% However, for simplicity, we present the main attributes in this paper in 1D.

% For elements adjacent to the crack tip in the material configuration, the approximated material displacement field, using hierarchical shape functions (up to 2nd order), is expressed as:
% \begin{equation}
% \label{eq:hierarchical_u}
% \begin{split}
% W(\xi) =& \sum_{a=0}^2 N_a (\xi) W^{(a)} = \\
% & (1 -\xi)W^{(0)} + \xi W^{(1)} + \kappa (1 - \xi) \xi W^{(2)}
% \end{split}
% \end{equation}
% where the natural coordinate $0\le \xi \le 1$ and $N_2 = \kappa N_0 N_1 =  \kappa\xi(1 - \xi)$. The parameter $\kappa$ is introduced, resulting in a nonlinear mapping between the natural and physical coordinates and leading to the desired singular stress and strain field at the crack tip. 

% Adopting an isoparametric formulation, the element geometry can also be interpolated using the same approximation functions as for $W$. Thus, the physical distance from the crack tip is expressed as:
% \begin{equation}\label{eq:hierarchical_r}
% r_{\rm q}(\xi) = \sum_{a=0}^2 N_a (\xi) r_{\rm q}^{(a)} = \xi l + \kappa \xi(1-\xi)  l 
% \end{equation}
% where $r_{\rm q}(\xi=0)=0$ at the crack tip and $r_{\rm q}(\xi=1)=l$. Setting $\kappa=-1$ results in the following relationship:
% \begin{equation}
% r_{\rm q}= \xi l - \xi(1-\xi)l= \xi l \quad \Rightarrow \quad \xi = \sqrt{\frac{r_{\rm q}}{l}},
% \end{equation}
% This  yields the following radial dependence for displacements and strains:
% \begin{equation}\label{eq:singstrain}
% \begin{aligned}
% W(r_{\rm q}) &= W^{(0)} - W^{(2)} \frac{r_{\rm q}}{l} \\ 
% &+ \left( -W^{(0)} + W^{(1)} - W^{(2)} \right) \sqrt \frac{r_{\rm q}}{l} \\
% \varepsilon(r_{\rm q}) &= \frac{\partial W}{\partial r_{\rm q}} =  W^{(2)} \frac{1}{l} \\
% & + \left( W^{(0)}  + W^{(1)} - W^{(2)}  \right) \frac{1}{2} \sqrt \frac{l}{r_{\rm q}} \\
% \end{aligned}
% \end{equation}
% Eq.~(\ref{eq:singstrain}) has the necessary terms to reproduce rigid body motion and pass the patch tests, as well as the desired singularity at the crack tip due the existence of the term $1 / \sqrt r_{\rm q}$. This will enable the elements adjacent to the crack front to reproduce the strain singularity resulting in an accurate finite element solution~\cite{nejati2015use}. 
% The influence of this approach for tetrahedral elements will be investigated in Section~\ref{sec:release_energy_rate}.

\section{Numerical examples}
\label{sec:numerical_examples}
Several numerical examples are presented to illustrate each aspect of the proposed framework. 
The first set of analyses, presented in Subsection~\ref{sec:numerical_examples:bone_adap}, considers bone adaptation, using an equine 3rd metacarpal bone as a case study.
The performance of the singularity element formulation is demonstrated in Subsection~\ref{sec:release_energy_rate} using a finite plate with through thickness crack subjected to uniaxial stress. In the penultimate subsection, the framework is used to investigate the likelihood of fracture at different  stages of adaptation. The final example considers fracture propagation at different stages of adaptation.

\subsection{Bone adaptation examples}
\label{sec:numerical_examples:bone_adap}
This subsection considers the bone adaptation of an equine 3rd metacarpal bone. 
In the UK, approximately 60\% of horse fatalities at racecourses are directly or indirectly associated with a fracture, with the distal limb the most commonly affected site \cite{parkin2004risk}.
Most of these fractures occur due to the accumulation of tissue fatigue, as a result of repetitive loading~\cite{Parkin2005}, rather than a specific traumatic event. 
Intense exercise and excessive loading of the metacarpal bones results in maladaptation. 
The location of 3rd metacarpal fractures is remarkably consistent across a large number of racehorses,  with crack initiation presenting from 
the lateral para-sagittal groove of the distal condyle of the leading forelimb~\cite{jacklin2012frequency, parkin2006analysis}.
Despite considerable research in the field, including applying diagnostic methods such as radiography 
\cite{bogers2016quantitative, crijns2014intramodality, loughridge2017qualitative}, magnetic resonance imaging 
\cite{tranquille2017MRI} and biomarkers~\cite{mcilwraith2005use}, it still remains a challenge to accurately predict the fracture risk 
and prevent this type of significant injury.

The p-convergence is studied, using the material parameters presented in Table~\ref{tab:parameters_mc3}. The elastic properties for both cortical and trabecular bone are approximated using power law derived from mechanical tests of MC3 bone~\cite{Les1994}. 
Such empirical elasticitydensity relationships are commonly adopted in finite element investigations of bones \citep{helgason2008mathematical}.
Parameters regarding bone adaptation are from previous studies of human tibia~\cite{pang2012computational,Waffenschmidt2012}. 
% Each case considers a different function for the parameter $c$ that defines the rate of bone adaptation and is used to compute the mass source, $\mathcal{R}_0$, according to Eq.~(\ref{eq:mass_source}).
% In Case~1, $c$ is constant. For Case~2 and Case~3 different bell functions (Eq.~(\ref{eq:bell_function})) are used. The parameters for each case are presented in Table~\ref{tab:three_cases}. 
The finite element mesh used in all cases comprises 17041 tetrahedral elements and was generated by discretising the segmented geometry of a full-scale model of an equine 3rd metacarpal bone derived from CT scan data - see Figure~\ref{fig:mc3_BC}.

For each analysis, the initial density is chosen to be homogeneous since, in the thermodynamic-based model, the starting density does not have a significant effect on the final bone density distribution (similar to other models at biological equilibrium~\cite{kuhl2003theory}). % is not sensitive to the initial density
Boundary conditions are simplified to two representative forces (5~$\text{[kN]}$~each) spanning over a small area based on pressure film studies~\cite{Brama2001}, as demonstrated in Figure~\ref{fig:mc3_BC}. 
The two forces are often considered in the literature as an equivalent of joint peak force at the mid-stance of a horse gait. Obviously, with such simplified loading case the analysis is not sufficient to produce any quantitative results regarding remodelling of the metacarpal but rather to demonstrate the potential of this approach. 
An adaptive time stepping scheme (using PETSc~\cite{petsc-web}) is used in all the simulations with an initial time step $\Delta t = 0.5$~$[\text{days (d)}]$, maximum time step of $\Delta t_{\text{max}} = 50$~$[\text d]$ and minimum of $\Delta t_{\text {min}} = 0.05$~$[\text d]$.
\begin{table}[h]
	\centering
	\begin{tabular}{lll}
		\hline
		 Param.             & Description                  & Value  \\ \hline
		$E  $                 & Young's modulus              & $4700 \,\mathrm{ [MPa]}$ ~\cite{Les1994} \\
		$\nu  $               & Poisson ratio                & $0.3 \,\mathrm{ [-]}$ \\
		$\rho_0 ^\ast  $      & Initial density              & $1.0 \,\mathrm{[ g/cm^{3}]}$  \\
		$\psi_{0}^\ast $      & Target energy density        & $0.0275\,\mathrm{ [MPa]}$  ~\cite{Waffenschmidt2012}  \\
		$c$                   & Density growth velocity      & $1.0 \,\mathrm{ [d/cm^{2}]}$   \\
		$m$                   & Algorithmic exponent         & $ 3.25 \,\mathrm{ [-]}$          \\
		$n$                   & Porosity exponent            & $2.25 \,\mathrm{ [-]}$     ~\cite{Les1994}   \\ 
		\hline
	\end{tabular} 
	\caption{Material parameters used for the simulations of 3rd metacarpal bone adaptation.}
	\label{tab:parameters_mc3}
\end{table}
% 
% \begin{table}[h]
% 	\centering
% 	\begin{tabular}{lllll}
% 		\hline
% 		Case                  & $c$              				       & $b$     &$\rho^\mathrm{max}$               &$\rho^\mathrm{min}$ \\ \hline
% 		1                     & 1              								 & -       & -                                & -\\
% 		2                     & Eq.~(\ref{eq:bell_function})   & 1000    & 2.5~$[{\text{g/cm}}^3]$          & 0.3~$[{\text{g/cm}}^3]$\\
% 		3                     & Eq.~(\ref{eq:bell_function})   & 30      & 1.8~$[{\text{g/cm}}^3]$          &1.0~$[{\text{g/cm}}^3]$ \\
% 		\hline
% 	\end{tabular} 
% 	\caption{Presentation of three cases input parameters for the evaluation of coefficient $c$ to compute mass source, $\mathcal{R}_0$, as presented in Eq.~(\ref{eq:mass_source}). All cases have common material input parameters presented in Table~\ref{tab:parameters_mc3}.}
% 	\label{tab:three_cases}
% \end{table}
% 
\begin{figure}[h]
	\begin{center}
		   \begin{tikzpicture}
				\node at (0,0) {\includegraphics[width=7cm]{Figures/mc3_BC.png}};
				\node at(-2.5,-1.8){$F = 5 \mathrm{kN}$ };
				\node at(-3.1,-0.3){ $F = 5 \mathrm{kN}$ };
				\node at(2.5,-0.3){ Fixed end };
	\end{tikzpicture}
		\caption{Finite element mesh of the equine 3rd metacarpal bone. The mesh consists of 14,041 quadratic tetrahedral elements and 70,901 degrees of freedom. To simulate the peak load of a gallop, 5 kN forces are applied on the lateral and medial side of the distal condyle.}
		\label{fig:mc3_BC}
	\end{center}
\end{figure}
% 
Results of bone adaptation analysis for three consecutive p-refinements are presented in Figure~\ref{fig:mc3_density} where density maps at five different points in time $(\text{0, 10, 40, 100, 500})$~$[\text d]$ are visualised. 
Significant densification occurred immediately after reaching the maximum level of the loading, particularly in the proximity of the applied forces, associated with high levels of strain energy. Conversely, areas with low levels of strain energy experience a reduction in density.
After 100~$[{\text d}]$, biological equilibrium was achieved and no further changes in density took place. 
The resulting maximum density is 2.8~$[{\text {g/cm}}^3]$ and the minimum is close to zero.
\begin{figure*}[h]
	\centering
	\def\svgwidth{3cm} \input{Figures/scale_bars/scale_bar_density_rainbow_horiz.pdf_tex}  
\end{figure*}
\begin{figure*}[h]
	% \captionsetup{font=normalsize,labelfont={bf,sf}}
	\captionsetup[sub]{font=small}
	\centering
	\begin{subfigure}[b]{0.475\textwidth}
		\begin{tikzpicture}
			\node at (0,0) {	\input{Figures/tikz/mc3_density.tex} };
			\node at(0.5,0.9){ \includegraphics[width=4.5cm]{Figures/tikz/mc3_density_fig.png}};
			% \node at(3,3){                    	\def\svgwidth{5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
			\end{tikzpicture}
		\caption{ }
		\label{fig:mc3_density}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.475\textwidth}  
		\begin{tikzpicture}
			\node at (0,0) {	\input{Figures/tikz/mc3_density_heter.tex} };
			\node at(0.5,0.9){ \includegraphics[width=4.5cm]{Figures/tikz/mc3_density_heter_fig.png}};
			\end{tikzpicture}

		\caption{  }    
		\label{fig:density_het_vs_hom}
	\end{subfigure}
	\caption{Convergence study. Evolution of the total mass of the bone using 1\textsuperscript{st} and 3\textsuperscript{rd} order tetrahedral elements. b)~Density evolution using constant initial density $\rho_0 ^\ast$ (homogeneous) and heterogeneous initial density obtained from CT-scan data.
	} 
	\label{fig:density_changes_}
\end{figure*}

The comparison of the results in Figure~\ref{fig:mc3_density} shows the minimal difference between p-refinements, which indicates sufficient discretisation.
However, the obtained maximum density is noticeably higher than in the actual equine bones~\cite{yamada2015experimental} and the minimum density is unrealistically close to zero. In the future considerations, it might be beneficial to enforce bounds on density levels by using mass influx in the mass balance equation~\cite{sharma2013adaptive} or by introducing density dependent growth rate $c$ \citep{waffenschmidt2012application}. 

In the next example, instead of using constant initial density $\rho_0 ^\ast$, the example density data from CT-scan is mapped onto the mesh using MWLS approximation method described in~\ref{sec:dens_mapping}. The results in Figure~\ref{fig:density_het_vs_hom} show, as expected, that in the equilibrium, the resulting mass is almost exactly the same as in the homogeneous case. Thereby proving that the used phenomenological model is insensitive to the initial density state. 

% For Case~3, a more moderate value for the exponent in the bell function was chosen along with a narrower density range than those chosen for Case~2 (see Table~\ref{tab:three_cases}).
% The plot presented in Figure~\ref{fig:density_bell2} demonstrates how these values influence the results of the analysis. 
% It is evident that with a much lower value for exponent, $b$, the algorithm no longer has problems converging. 
% Furthermore,  reducing the range between the upper and lower bounds of density has a significant impact on the results. 
% The dense cortical shaft on the dorsal side of the bone is less dense and covers a much larger region. 
% Furthermore, unrealistically low values of densities have been eliminated. 
% However, as with the previous case, the overall solution converges to the same mass as in Case~1, albeit requiring significantly more time steps. \\

\subsection{Stress intensity calculations}
\label{sec:release_energy_rate}
To examine the calculation of configurational forces at the crack front in bodies with both homogeneous and heterogeneous density distributions, five numerical examples are presented.
First, a simple quasi-two-dimensional plate with homogeneous material distribution is considered.  The convergence study utilises an approximate solution from literature as a reference.
Second, the proposed singularity elements are included for the same plate problem and their influence on the rate of convergence is presented. 
Third, the same problem is considered again but with a heterogeneous material distribution.
The final two examples demonstrate the calculation of configurational forces for a more representative bone.
 
\subsubsection{Finite plate with a horizontal crack}\label{sec:plate_section}
A finite plate with height, $h_{\rm {pl}} = 10$, thickness $t_{\rm {pl}}=1$ and half width $b_{\rm{pl}} = 2.5$ and a horizontal through-thickness crack with half width $a_{\rm {pl}} = 1$, as presented in Figure~\ref{fig:plate_load_mesh}(a), is considered. All input parameters presented are dimensionless. 
The  plate is spatially discretised using 1384 tetrahedral elements and subjected to uniaxial stress in the longitudinal direction, as indicated in Figure~\ref{fig:plate_load_mesh}(b). 
Displacements are constrained on three vertices of the plate to prevent rigid body motion. 

\begin{figure}[h!]
\begin{center}
\begin{tabular}{c}
{\def\svgwidth{8cm} \input{Figures/InfSlab.pdf_tex}}\\
\end{tabular}
\caption{Finite plate with a horizontal crack. a) Plate geometry with through thickness crack. b) Finite element mesh - grey elements have approximation order $p_{\rm g}$ and yellow elements have vertices at crack tip and have approximation order $p_{\rm l}+p_{\rm g}$. }
\label{fig:plate_load_mesh}
\end{center}
\end{figure}

The purpose of this analysis is to calculate the Mode I stress intensity factor $ K_{\rm I} $ directly from the configurational and compare with the solution~\cite{rooke1976compendium} for an infinite plate:
\begin{equation}\label{eq:frac_analytical}
K_{\rm I}=\sigma \sqrt{\pi a_{\rm {pl}}} \left[  \frac{1 - \frac{a_{\rm {pl}}}{2b_{\rm {pl}}} + 0.326 (\frac{a_{\rm {pl}}}{b_{\rm {pl}}})^2 }{\sqrt{1-\frac{a_{\rm {pl}}}{b_{\rm {pl}}}}}  \right]
\end{equation}
where $\sigma $ is the applied stress. 
Young's modulus $E$ and Poisson's ratio $\nu$ are $1000$ and $0.3$, respectively. 


Hierarchical approximation functions allow for global and local p-refinment without changing the mesh.
In general, all tetrahedrons of the mesh have a global order of approximation, $p_{\rm g}$, with some elements subjected to local refinement of order $p_{\rm{l}}$.
All analyses presented were run using the same mesh with p-refinement varying from 1\textsuperscript{st}-order to 6\textsuperscript{th}-order so that $p_{\rm l} + p_{\rm g} \leq 7$.
The Mode I stress intensity factor, $K_{\rm I}$, was calculated directly from the output configurational forces as: 
\begin{equation}
K_{\rm I} = \sqrt{GE}
\end{equation}
where $G$ is the change of elastic strain energy per unit area of crack growth.
From Figure~\ref{fig:plate_conv}(a), it is evident that, for the same coarse mesh and number of nodes, the solution can improve drastically when the order of approximation is increased. 
The well known shear locking associated with first-order approximation is observed. 
The minimum error achieved is $0.50\%$ for all the cases with total order of approximation  $p_{\rm l} + p_{\rm g} = 7$. 
Therefore, it can be observed that using a low order of global approximation plus local p-refinement 
can achieve the same level of accuracy as using high order approximation globally, but with fewer degrees of freedom and lower computational cost.
\begin{figure}[h]
	\centering

	\input{Figures/tikz/legend1.tex}
	\begin{minipage}{.45\textwidth}
		% \hspace{-0.5cm}
		\begin{tikzpicture}
			\node at (0,0)   {		\input{Figures/tikz/plate_conv_no_sing.tex} };
			\node at (-1.2,-1.1){$0.50\%$};
			\node at (0,0) {};
			\end{tikzpicture}
		\begin{centering} (a) \end{centering}
	\end{minipage}%
	\\
	% \quad \quad \quad
	\begin{minipage}{.45\textwidth}
		% \vspace{-0.25cm}
		\begin{tikzpicture}
			\node at (0,0){	\input{Figures/tikz/plate_conv_singularity.tex} };
			\node at (-1.2,-1.0){$0.028\%$};
	\end{tikzpicture}
\begin{centering} (b) \end{centering}
	\end{minipage}
				% \begin{centering} (a)\hspace{7cm}(b) \end{centering}
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$. Relative error (\%) versus no. of DOF (log10) for (a) using hierarchical approximation functions and (b) using singularity elements.}
			\label{fig:plate_conv}
\end{figure}


Based on the results in Figure~\ref{fig:plate_conv}(b), it is evident that using singularity elements improves the convergence rate significantly and lowers the error by an order of magnitude, from 0.50\% down to 0.028\%. 
However, it can also be seen that for each combination of p-refinement, the error increases with further refinement after it reaches the minimum value. 
This suggests that the solution cannot be further improved by enhancing the order of approximation alone. 
Reducing the the elements size and increasing the plate width (to better replicate the infinite plate used to determine the approximate solution, the error would probably decrease further. 
Nevertheless, the results are considered sufficiently accurate for the purpose at hand. 

Overall, these results indicate that it is of great benefit to use the singularity elements, since they improve the accuracy of the solution with no extra cost.
Furthermore, the difference in execution time for the analysis with and without their inclusion was negligible. 

\subsubsection{Heterogeneous material}
So far the numerical examples have assumed homogenous material properties. Here we consider the effect of a heterogeneous density distribution. 
Considering the same problem of the finite plate with horizontal crack, a density field $\mathbf{\rho}(x,y,z) = 0.125y + 1$ is directly assigned to the integration (Gauss) points of each tetrahedral element.
As expected, configurational forces are induced at the crack tip under load and, as explained in Section \ref{sec:fem_fracture_prop}, these forces are influenced by the non-uniform density distribution. 

However, the stress intensity factors or J-integral in the case of heterogeneous materials are difficult to calculate or obtain experimentally \citep{fischer_problems_2014}. Due to the inhomogeneities the J-integral becomes path dependent and require special correction terms to be computed \citep{eischen_fracture_1987, chang_extension_2002}. There is no agreed approach to validate either configurational forces or stress intensity factors for such cases (except for the special case of functionally graded materials~\cite{kim2002finite}).
%, by using MWLS method, demonstrated in Section~\ref{sec:mwls}.

A straightforward verification can be performed by using a central difference numerical integration. The energy release rate for crack growth can be calculated as the change in elastic strain energy per unit area of crack growth~\cite{Griffith163}:
\begin{equation}
G = \frac{\partial \psi}{\partial a_{\rm {pl}}}
\end{equation}
where $\psi$ is the elastic energy of the system, and $a_{\rm{pl}}$ is the crack length. This derivative can be approximated as:
\begin{equation}
 \frac{\partial \psi}{\partial a_{\rm {pl}}} = \lim_{\Delta a_{\rm {pl}} \to 0} \frac{\psi(a_{\rm {pl}} + \Delta a_{\rm {pl}}) - \psi(a_{\rm {pl}} -\Delta a_{\rm {pl}})}{2\Delta a_{\rm {pl}}}
\end{equation}
where the elastic strain energies $\psi(a_{\rm {pl}} \pm \Delta a_{\rm {pl}})$ is obtained from two additional analyses with horizontal cracks of lengths: ($a + \Delta a_{\rm {pl}}$) and ($a - \Delta a_{\rm {pl}}$), where $\Delta a_{\rm {pl}}$ is a very small value. 
Next, knowing the resulting release energy with the crack length of $a_{\rm {pl}}$, a relative error can be calculated. 
Twenty-four analyses, for different levels of $p$~-~refinement and values of $\Delta a_{\rm {pl}}$, have been undertaken in order to determine the error in the release energy. 
The results are presented in Figure~\ref{fig:covergencefdm}, where it is apparent that the error in fracture energy release rate is converging to 0.3\% 
with increasing levels of refinement. It is worth noting that a similar level of accuracy was attained for the homogeneous case.  Achieving higher precision with this means of validation is difficult due to the accumulation of truncation, approximation and discretisation errors.
Therefore, it can be concluded that the proposed estimation of fracture energy release rate for heterogeneous materials is obtained with a satisfactory level of accuracy.
\begin{figure}[h]
	\centering
%	\includegraphics[width=0.7\linewidth]{Figures/tikz/covergence_FDM.png}
	\begin{tikzpicture}
		\node at (0,0){\input{Figures/tikz/covergence_FDM.tex}};
		\node at (-1.8,-0.7) {	\includegraphics[width=1cm]{Figures/tikz/gradient.png}};
		\node at (-0.2,-1.5){$0.3\%$};
		\end{tikzpicture}
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$ for heterogeneous density distribution. Relative error (\%) versus no. of DOF (log10).}
	\label{fig:covergencefdm}
\end{figure}

\subsubsection{Fracture energy release rate for metacarpal bone} 
\label{sec:mc3_release_eng}
This numerical example considers the same bone as presented in Section~\ref{sec:numerical_examples:bone_adap}. 
An initial crack was generated in the mesh using a cutting plane, as shown in Figure~\ref{fig:bone_ct_mesh_cut}. A notch is situated at the origin of the most common location of a lateral condyle fracture~\cite{jacklin2012frequency}. 
The numerical analyses were undertaken using three meshes consisted of 6069, 10032 and 21189 tetrahedrons and repeated for 1\textsuperscript{st}, 2\textsuperscript{nd} and 3\textsuperscript{rd}-order of global $p$~-~refinement and local $p$~-~refinement at the crack tip. 
Boundary conditions and material parameters remain the same as in Table~\ref{tab:parameters_mc3}. 
Using a $\mathrm {K_2 HPO_4}$ calibration phantom, grey scale values from CT scans are converted to bone mineral density using five tubes with reference densities. 
The mechanical material properties were mapped onto the integration points of the mesh of the metacarpal bone using the MWLS method described earlier. 
The application of load induces configurational forces at the crack front, as shown in Figure~\ref{fig:crackfrontforce}. 
The direction of the vectors also indicates the direction of crack propagation.
%When these forces, attain the critical value, crack growth is spontaneous and catastrophic.  
The values of numerically predicted maximal nodal fracture energy release rates in Mode I (crack opening) for subsequent meshes are plotted in Figure~\ref{fig:max_g1_convergece}. 
It can be seen that, for the same mesh, as the order of approximation increases, the energy release rate converges. 
%with increasing order of approximation material forces converge.
\begin{figure}[h]
	\centering
		\def\svgwidth{7cm}
		\input{Figures/bone_ct_mesh_cut.pdf_tex}
	\caption{Bone geometry with density mapped from CT using MWLS. Initial crack introduced by cutting the mesh with a circular surface.}
	\label{fig:bone_ct_mesh_cut}
\end{figure}

\begin{figure}[h!]
	\centering
	\def\svgwidth{7cm}
	\input{Figures/crack_front_force.pdf_tex}
	\caption{Crack surface and configurational forces at the crack front.}
	\label{fig:crackfrontforce}
\end{figure}

\begin{figure}[h!]
	\centering
	\input{Figures/tikz/max_g1_convergece.tex}
	\caption{Convergence plot of fracture energy release rate versus no of DOF (log10) for subsequent discretisations and $p$~-~refinements.}
	\label{fig:max_g1_convergece}
\end{figure}
A crack will propagate when the energy release rate $G$ equals the material's resistance to crack extension, $g_{\rm c}$. Assuming $g_{\rm c} = 2.0\,[\mathrm{ kJ/m^2}]$~\cite{gasser2007numerical} it can be estimated that this particular metacarpal bone with this initial crack can sustain loading of approximately 2.2 times greater before a fracture starts to propagate. 

\subsubsection{Fracture energy release rate for adapted bone}
The previous example is extended to investigate the likelihood of fracture in an equine metacarpal bone at different phases of adaptation during training.
However, this time, densities from a bone adaptation analysis (Section~\ref{sec:numerical_examples:bone_adap}) are mapped onto the coarse mesh, as shown in Figure~\ref{fig:frackmeshcutting}. 
\begin{figure}[h]
	\centering
			\def\svgwidth{7cm}
		\input{Figures/frack_mesh_cutting.pdf_tex}
	\caption{Density distribution from bone adaptation analysis mapped onto fracture analysis mesh. Initial crack created using the cutting plane shown.}
	\label{fig:frackmeshcutting}
\end{figure}
The resulting energy release rate at different points in time of bone adaptation are illustrated in Figure~\ref{fig:crackmc3release} for three different local $p$~-~refinements. It can be seen that the variation in energy release rate for increased orders of approximation at the crack front is very small. 
\begin{figure}[h!]
	\centering
%	\includegraphics[width=1\linewidth]{Figures/tikz/crack_mc3_release.png}
		\begin{tikzpicture}
			\node at(0,0){	\input{Figures/tikz/crack_mc3_release.tex}};
			\node at(0.2,0){ \includegraphics[width=5cm]{Figures/tikz/density_for_g1_conv.png}};
			\node at(1.5,-0.5){                    	\def\svgwidth{2.5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
		\end{tikzpicture}
	\caption{Fracture energy release rate over time during bone adaptation for three local $p$~-~refinements.}
	\label{fig:crackmc3release}
\end{figure}
It can be seen that there is a trend of increasing release energy rate over time and that by introducing a notch in the resorption zone, where no loading is applied, the configurational force attains larger values. This indicates that over time the bone becomes more prone to fracture in this specific region. 

\subsection{Crack propagation in bone}
In this section, we move the analysis further by simulating the process of crack propagation for different levels of bone adaptation. The magnitude of applied forces (Figure \ref{fig:mc3_BC}) is controlled by the increment in crack area during each load step using an arc-length technique. The initial finite element mesh is the same as previously, although it is locally refined as the crack front advances. Due to lack of experimental data, the fracture energy is assumed constant for the entire domain, $g_{\text c} = 2.0\,[\mathrm{ kJ/m^2}]$. 
All five cases (time snapshots) are solved using 2nd-order approximation functions.
The numerically predicted crack paths are shown in Figure~\ref{fig:crack_snapshots}. 
It can be seen that the crack has an initially planar shape and then curves towards the lateral side of the bone. This simulated crack path compares well with fractures observed in radiographs \cite{whitton2010third}, especially considering the simplified loading conditions. The load factor versus crack area plots are shown in Figure~\ref{fig:crack_remodel_frac_compar}. Consistent with the previous analysis in Section~\ref{sec:mc3_release_eng}, the metacarpal bone shows a decreased resistance to fracture - i.e. for the same crack area, the remodelled bone requires much lower force (load factor) to induce crack propagation. Low density levels at biological equilibrium ($t=90$ and $t=200$) also influences the crack path, with the crack curving earlier than in the initial stages of remodelling. 
\begin{figure}[h!]
	\centering
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fracture/remodel_frac_compar.tex} };
	\node at (0.9,1) {	\includegraphics[width=4.5cm]{Figures/pngs/crack_surfaces_adapt.png}};
	\node at (1.8,-0.3) {	Crack surfaces};
	\end{tikzpicture}
	\caption{Load factor versus crack area for different moments in time during bone adaptation analysis. Bone density distribution influenced both load factor and the resulting crack surface.}
	\label{fig:crack_remodel_frac_compar}
\end{figure}

\begin{figure*}[h!]
	\centering
	\begin{centering}
			\begin{tikzpicture}
				\node at (0,0) {			\includegraphics[width=10cm]{Figures/pngs/crack_spatial_conf.png} };
				% \node at(1,-2.5){a) \hspace{2.5cm} b)  \hspace{2.5cm}  c)  \hspace{2.5cm}  d)  \hspace{2.5cm}  };
		\end{tikzpicture}
	\end{centering}		
		\caption{Crack surface evolution in equine 3rd metacarpal.}
		\label{fig:crack_snapshots}
\end{figure*}


As previously demonstrated (Figure~\ref{fig:plate_conv}(b)) modelling singularity can significantly improve the accuracy of the configurational forces at the crack front. In the next example we considered bone with heterogeneous density distribution mapped from CT scan data. 
In the Figure~\ref{fig:load_factor1}(a) results from crack analysis with and without Quarter Point elements are depicted. It is evident that accurate stress state at the tip has a negligible impact on the full crack propagation analysis and the resulting load factor.  

\begin{figure*}[h]
	\centering
	\begin{minipage}{.45\textwidth}
	\begin{tikzpicture}
		\node at(0.,0){  	\input{Figures/tikz/fracture/remod_heter_singular.tex} };
	\end{tikzpicture}
\end{minipage}%
\quad
\begin{minipage}{.45\textwidth}
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fracture/homo_vs_het.tex} };
	\node at (1.1,0.35) {	\includegraphics[width=3.5cm]{Figures/pngs/crack_surf_heter_compar.png}};
	\end{tikzpicture}
\end{minipage}

(a) \hspace{5cm} (b)
	\caption{Load factor versus crack area for (a) with and without singularity element and (b) homogeneous versus heterogeneous density distribution.}
	\label{fig:load_factor1}
\end{figure*}
From the load-crack area curves in Figure~\ref{fig:load_factor1}(b) it can be observed that including density data from CT scans have a significant impact on the predicted load factor and crack path as well. 


Finally, we investigated the h and p convergence. The results presented on the Figures \ref{fig:load_factor2}(a) and \ref{fig:load_factor2}(b) show good numerical convergence for consecutive refinements. It can be concluded that our formulation predicts crack path accurately with minimal effect from original mesh or order of approximation. 

\begin{figure*}[h]
	\centering
	\begin{minipage}{.45\textwidth}
		\begin{tikzpicture}
			\node at(0.,0){ \input{Figures/tikz/fracture/real_fract_ct_h_ref.tex} };
		 \end{tikzpicture}
	\end{minipage}%
	\begin{minipage}{.45\textwidth}
		\begin{tikzpicture}
			\node at(0,0){         \input{Figures/tikz/fracture/real_fract_ct_p_ref.tex} };
		\end{tikzpicture}
	\end{minipage} \\
	(a)\hspace{5cm} (b)
			 \caption{Load factor versus crack area (a) $h$~-~refinement). (b) $p$~-~refinement.}
		 \label{fig:load_factor2}
	\end{figure*}

The simulated crack path using density data from CT scans compare well with fractures observed in radiographs \cite{whitton2010third}, especially considering oversimplified loading conditions. The direct comparison of the numerically predicted crack with a crack segmented from a different CT scan data, with developed MC3 fracture, fracture can be found in Figure~\ref{fig:real_fractures}
% 
\begin{figure}
	\centering
	\begin{tikzpicture}
		\node at(0.,0){\includegraphics[width=4cm]{Figures/ct_vs_fem_rad} };
		\node at(-0.5, -1.2){  a) \hspace{1.8cm} b) \hspace{1cm} };
\end{tikzpicture} \\%
	\caption{a) Numerically predicted crack. b)~Bone with fracture segmented from CT scan data. }
\label{fig:real_fractures}
\end{figure}


\section{Discussion}\label{sec:discussion}
This paper has presented a FEM computational modelling framework to investigate the influence of bone adaptation, and associated bone density distribution, on fracture resistance and fracture propagation. 
The influence of the heterogeneous density distribution was captured using an extension of the authors' previous work on configurational mechanics for fracture. 
Configurational forces are the driver for crack propagation and it was shown that in order to evaluate correctly these forces at the crack front it is necessary to have a spatially smooth density field, with higher regularity than if the field is directly approximated on the finite element mesh. 
Therefore, density data is approximated as a smooth field using a Moving Weighted Least Squares method. 
In this paper, the bone density field was generated from both bone adaptation analyses and from subject-specific geometry and material properties obtained from CT scans. 
It is important to note that the adoption of configurational mechanics avoids the need for post-processing, since configurational forces, and the fracture energy release rate, are expressed exclusively in terms of nodal quantities.

% The constitutive model for bone adaptation included a bell function to define the rate of adaptation. 
% This did not enforce rigid bounds on density levels, but merely slowed down the rate of convergence to biological equilibrium. 
% This approach will be useful when trying fit model parameters to the actual density data from CT scans in defined periods of time. 
% It is also possible to enforce bounds on density levels by introducing and calibrating mass influx in the mass balance equation~\cite{sharma2013adaptive}. 

Numerical examples demonstrated the performance and accuracy of the proposed framework. 
Numerical convergence was demonstrated for all examples and the use of singularity elements was shown to further improve the rate of convergence. However, it was also confirmed that improved accuracy of the stress at the tip had no impact on the crack propagation analysis and the resulting crack path.  The final example, demonstrated how mechanical loading and subsequent adaptation influence the resistance to bone fracture. Therefore, this framework will be a useful tool in understanding fractures in bone and ultimately preventing catastrophic fractures. 

All analyses were undertaken using MoFEM library \cite{mofemJoss2020} that has been developed to support scalability and ensure robustness. The entire framework can be executed on parallel computer systems. Supplementary data (CT scans, mesh files, command lines) necessary to reproduce the results of all numerical examples can be found in~\cite{karol_lewandowski_2019_dataset}. The bone adaptation and fracture mechanics are both submodules in the MoFEM~\cite{mofemJoss2020}, which can be installed using the flexible package manager, Spack~\cite{spack2015}. 

% \newpage
\bibliographystyle{abbrv}
%\bibliographystyle{numeric}
%\bibliographystyle{spbasic}

\bibliography{bibfile}

\end{document}