% !TeX root = ./Lewandowski2018.tex
\documentclass[review]{elsarticle}
\usepackage{amssymb,amsthm,mathrsfs,graphicx, bm}
\usepackage{natbib}
\usepackage{subfigure}
\usepackage{titlesec}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{newtxtext,newtxmath}
\usepackage{hyperref}

\usepackage{amsmath}
\usepackage{color}
\usepackage{amsfonts}
%\DeclareMathOperator*{\Aoperator}{ \mathlarger{\mathlarger{\mathlarger{\boldsymbol{\mathsf{A}}}}} }
% \DeclareMathOperator*{\aoperator}{ \text{\huge${\mathsf{A}}$}}
\pagenumbering{arabic}


%Packages for Matlab2TikZ
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{plotmarks}
\usetikzlibrary{arrows.meta}
%\tikzset{every picture/.style={/utils/exec={\boldsymbol{\rm X}}{\sffamily}}}
\usepgfplotslibrary{patchplots}
\usepackage{grffile}


\setlength{\parindent}{0pt}
\setlength{\parskip}{5pt plus 2pt minus 1 pt}

\numberwithin{equation}{section}
%\topmargin  -25mm
%\evensidemargin 0mm
%\oddsidemargin  0mm
%\textwidth  160mm
%\textheight 267mm
\renewcommand{\baselinestretch}{1.0}
\frenchspacing
\sloppy
\titlespacing{\section}{0pt}{\parskip}{0.01\parskip}
\renewcommand{\headrulewidth}{0pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{lineno,hyperref}
\usepackage{moreverb}
\usepackage{bm,color,soul,transparent,amsmath, amsmath,amssymb,amsthm,fancyhdr,mathrsfs,graphicx,setspace,stmaryrd,psfrag}
\usepackage[ruled,slide]{algorithm2e}
%\usepackage[nomarkers,notablist,nofiglist] %{endfloat}
%
%\modulolinenumbers[5]


\newcommand\BibTeX{{\rmfamily B\kern-.05em \textsc{i\kern-.025em b}\kern-.08em
T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

\def\volumeyear{2010}

\DeclareMathOperator*{\A}{ \raisebox{-2pt}{$\mathlarger{\mathlarger{\mathlarger{\mathlarger{\mathlarger{\mathsf{A}}}}}}$} }


\journal{CMAME}

\bibliographystyle{elsarticle-num}

\begin {document}
%\setcounter{page}{3}

\begin{frontmatter}

\title{Numerical investigation into fracture risk of bone following adaptation}

\author[gla]{Karol Lewandowski\corref{cor}}
\ead{karol.lewandowski@glasgow.ac.uk}
\author[gla]{{\L}ukasz Kaczmarczyk}
\ead{lukasz.kaczmarczyk@glasgow.ac.uk}
\author[gla]{Ignatios Athanasiadis}
\ead{zahur.ullah@glasgow.ac.uk}
\author[gla]{John F. Marshall}
\ead{john.f.marshall@glasgow.ac.uk}
\author[gla]{Chris J. Pearce}
\ead{chris.pearce@glasgow.ac.uk}
\cortext[cor]{Corresponding author}
\address[gla]{The James Watt School of Engineering, University of Glasgow, Glasgow, G12 8QQ, UK.}

\begin{abstract}
	
\textcolor{red} NEW VERSION (work in progress):

	Bone is able to adapt its density to changes in external conditions. This property is one of the most important mechanisms for developement of resistance to fracture. In this work we present a finite element framework for simulating bone adaptive changes, commonly called bone remodelling, followed by a novel method of quantifying propensity for fracture. Many modern fracture mechanics methods are limited to homogeneous domains. To estimate the ultimate loading factors and model discrete crack propagation in complex materials like bones, we propose an extension to the authorsâ€™ previous formulation within the context of configurational mechanics. The local form of the first law of thermodynamics provides an equilibrium condition for the crack front, expressed in terms of the configurational forces and material resistance. Applying the principle of maximal energy dissipation, the direction of crack propagation is given by the direction of the configurational forces. The main advantage of the presented approach is that crack release energy is expressed exclusively in terms of nodal quantities, which enables fully implicit formulation for evolving crack.
	Performance of the framework is demonstrated by means of a representative numerical simulations for bone remodelling and subsequent crack propagation in an equine 3rd metacarpal bone. Accurate representation of subject-specific geometry and material properties are obtained from CT scans. A new approach to assign bone density from CT scan data to the finite element models, using moving weighted least squares is utilised. 
	The resulting framework provides a robust and energy consistent method for quantifying the influence of heterogeneity (resulting from bone adaptation) on fracture propensity. 

	

\textcolor{red} ABSTRACT TO BE REWRITTEN:

Fractures of the metacarpal condyle are a common orthopaedic injury in thoroughbred racehorses.  
	Fractures of the metacarpal condyle are a common orthopaedic injury in thoroughbred racehorses.  
Fractures of the metacarpal condyle are a common orthopaedic injury in thoroughbred racehorses.  
A large proportion of injuries occur in the absence of a specific traumatic event and show typical characteristics of stress fractures. 
	A large proportion of injuries occur in the absence of a specific traumatic event and show typical characteristics of stress fractures. 
A large proportion of injuries occur in the absence of a specific traumatic event and show typical characteristics of stress fractures. 
This paper presents a finite element framework for simulating both bone remodelling of equine 3rd metacarpal bones and the associated propensity for fracture. 
	This paper presents a finite element framework for simulating both bone remodelling of equine 3rd metacarpal bones and the associated propensity for fracture. 
This paper presents a finite element framework for simulating both bone remodelling of equine 3rd metacarpal bones and the associated propensity for fracture. 
The proposed approach can improve the understanding of the correlation between high exercise intensity, bone adaptation and fracture 
	The proposed approach can improve the understanding of the correlation between high exercise intensity, bone adaptation and fracture 
The proposed approach can improve the understanding of the correlation between high exercise intensity, bone adaptation and fracture 
	risk, ultimately improving the welfare of the racehorse. 
	The remodelling analysis uses a well known phenomenological approach for the macroscopic behaviour of bone, based on open system thermodynamics.  
	The subsequent assessment of fracture propensity is conducted by evaluating the strain release energy rate within the context of configurational mechanics, enabling the influence of spatially varying bone density to be captured.
	Furthermore, new finite elements are developed to accurately resolve the the stress singularity in linear elastic fracture mechanics. This means that analyses can be undertaken efficiently and accurately, utilising relatively coarse finite element meshes and adopting multigrid algebraic solvers.
	Accurate representation of subject-specific geometry and material properties, obtained from CT scans, are utilised. A new approach to assign bone density from CT scans to the finite element models, using moving weighted least squares is presented. 
	The resulting framework provides a robust and energy consistent method for quantifying the influence of bone adaptation on the
	 fracture propensity. Performance, verification, convergence and validation of the presented method are demonstrated by numerical examples.
	The promising results of this study offer a~novel framework to simulate changes in the bone structure in response to exercise and 
	quantify the likelihood of fracture .
\end{abstract}

	%Bone is able to adapt to changes in its mechanical environment. Studies of the Thoroughbred racehorse show modification of the geometric properties of the third metacarpal bone in response to training. These modifications are associated with reduced bone strains. Intense training before the adaptive response is completed and bone strain reduced increases the risk of fatigue damage. Bone adaptation in response to different loads is known to increase the resistance to fracture. The development of computational models to describe bone behavior has gained tremendous importance over the last decade. In particular, computational modelling for bone growth and resorption processes followed by fracture analysis can be a useful tool to determine crack propensity. Therefore,, this study aims to develop an efficient framework which will help to understand the relationship between exercise loading, bone density and ultimately fracture risk. This case study highlights the development of subject-specific FE analyses to simulate exercise loading on equine bone and subsequently quantify changes in the fracture propensity in open source code - MoFEM.

\begin{keyword}	
Finite element analysis\sep bone remodelling \sep fracture \sep 3rd metacarpal \sep moving weighted least squares \sep configurational mechanics \sep heterogeneity
\end{keyword}
%
\end{frontmatter}

\linenumbers

\section{Introduction}
Bone remodelling is the on-going complex biological process of replacing old bone tissue by new bone and thus repairing fatigue damage~\citep{hughes2017role}.
The ability to repair bone micro-damage caused by cyclic loading is essential for maintaining mechanical integrity and, consequently, there is a strong correlation between stress fractures and the adaptation process~\citep{hughes2017role}. Bone repair can be overwhelmed by load-induced bone densification that also increases brittleness~\citep{loughridge2017qualitative}.

One of the first mathematical theories for bone adaptation~\citep{cowin1976bone}, based on open system thermodynamics, has foundations in the theory of poroelasticity. 
Since this concept was introduced in the 1970s, it has become a popular area of interest within the field of modelling biomechanical processes. 
In this approach (unlike classical closed systems), energy, mass, momentum and entropy can cross the boundary of the body and 
be exchanged with its environment. 
Many derivations and enhancements of this approach have been developed over the years. 
For example, researchers were able to capture the functional adaptation of the bones by means of optimisation/ theory
~\citep{harrigan1996bone, jacobs1995numerical, weinans1992behavior}.
The general concept for density evolution within these approaches is to establish a~mechanical stimuli as a trigger for bone adaptation. 
The stimulus may take the form of stress~\citep{beaupre1990approach, carter1996mechanical, doblare2002anisotropic}, strains~\citep{cowin1976bone} or strain energy density~\citep{weinans1992behavior, kuhl2003theory,kaczmarczyk2011efficient, Connor2017bone}. 

This paper focuses on the use of computational tools to quantify bone adaptation and resistance to fracture, thereby providing the basis for a 
viable and robust solution.
The use of computational tools to describe bone behaviour has gained a tremendous importance over the last decade. 
In particular, the Finite Element Method (FEM) has been used to improve understanding of the fracture behaviour of bones and the relationships between load conditions and bone architecture~\citep{podshivalov2014road, poelert2013patient}. However, there are only a few example of the numerical analysis of both bone remodelling and fracture, e.g.~\citep{hambli2013integrated}. This paper presents a new computational framework based on FEM to predict bone density profiles 
(bone adaptation) due to exercise and subsequently quantify the fracture resistance of 
adapted bones using linear elastic fracture mechanics. 

A schematic of the modelling framework is presented in Figure~\ref{fig:framework}. The work presented builds on the authors' previous work in the modelling of fracture propagation \citep{kaczmarczyk2014three,kaczmarczyk2017energy} and bone remodelling \citep{kaczmarczyk2011efficient,lewandowski2017}. Furthermore, this paper develops the work on fracture to capture the influence of spatially varying bone density and combines this with bone remodelling. 
To the best of the authors' knowledge, to date there is only one report of equine bone adaptation in a FEM framework~\citep{Wang2016}. 
In that work, a mechanostat micro-scale model of three-dimensional cortical bone remodelling, informed by \emph{in~vivo} equine data, was presented. 
The model used the von Mises stress as a stimulus to control microstructural cortical bone remodelling.
In contrast, the current paper presents a full macro-scale model of equine bone response to mechanical loading, testing a hypothesis that micro-damage and fracture can be modelled at the macroscale by using clinically available CT-scanning data.
The motivation for this work is to generate subject-specific simulations to acquire meaningful insight into bone resistance
 for veterinary practitioners.

%(The aim for this study is the establishment and implementation of FEM based framework suitable for clinical practice that will help to simulate density evolution, quantify current and future fracture risk based on CT scanning data derived from horses in training.) 
%Bone adaptation process, within the developed framework, is incorporated by using computational algorithm in open system thermodynamics 
%\citep{Kuhl2003a}.


This article is structured as follows. The mathematical framework for bone remodelling is briefly presented in Section~\ref{sec:bone_remodel}.
Section~\ref{sec:dens_mapping} describes a novel approach to assign heterogeneous mechanical bone properties, derived from CT scans,
to the finite element model by means of the Moving Weighted Least Squares (MWLS) method.
Thereafter, Section~\ref{sec:release_energy} presents an extension of a recently established approach 
for evolving crack propagation in the context of configurational mechanics. The method is utilised to calculate the energy release rate of bones under quasi-static loading during different stages of adaptation. 
Section~\ref{sec:numerical_examples} brings together all the developments of the framework in the form of numerical examples. 
Finally, a brief summary of the work is presented in Section~\ref{sec:discussion} and areas for further research are identified.

\begin{figure}[h]
	\centering
	   \begin{tikzpicture}
		\node at (0,4) {\includegraphics[width=14cm]{Figures/framework.png}};
		\node at(0,0.6){\hspace{1cm} a) Density mapping. \hspace{1.3cm} b) Bone adaptation.  \hspace{1cm} c) Crack propagation analysis.  };
\end{tikzpicture}
\caption{Framework for estimating bone fracture resistance in MoFEM~\citep{mofem2017}. a) Density derived from Quantitative Computed Tomography (qCT) is mapped onto finite element mesh; (b) bone adaptation analysis; (c) fracture mechanics to evaluate the fracture energy release rate of an initial crack at different time steps~c).}
\label{fig:framework}
\end{figure}

 
 \section{Preliminaries}
 
Figure~\ref{fig:domains4} shows a section of bone with an initial crack in the reference domain $\mathscr{B}_{0}$. As a result of loading, the crack extends and the body deforms elastically. Working within the framework of configurational mechanics \citep{kienzler2014configurational,kaczmarczyk2014three}, it is convenient to decompose this behaviour into solely an extension of the crack in the material domain  $\mathscr{B}_t$ followed by elastic deformation only in the spatial domain $\Omega_t$. The former is described by the mapping from the reference  domain to the material domain ${\boldsymbol\Xi}$, whilst the latter is described by the mapping from the material to the spatial domain ${\boldsymbol\varphi}$. 

\begin{figure}[th] \label{fig:domains4}
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.7\textwidth]{Figures/domains4.eps} // by Chris (keep as a reference)
\def\svgwidth{15cm} 	\input{Figures/Configurations.pdf_tex} 
\end{center}
\caption{Decomposition of crack propagation in elastically deforming bone.}
\end{figure}

The material coordinates $\mathbf{X}$ are mapped onto the spatial coordinates $\mathbf{x}$ via the
familiar deformation map $\boldsymbol\varphi(\mathbf{X},t)$. The physical displacement is:
\begin{equation}
\mathbf{u}=\mathbf{x}-\mathbf{X}
\end{equation}
The reference material domain describes the body before crack extension. ${\boldsymbol\Xi}(\boldsymbol\chi,t)$ maps the reference material coordinates $\boldsymbol\chi$ on to the current material coordinates $\mathbf{X}$, representing a configurational change, i.e. extension of the crack due to advancement of the crack front. ${\boldsymbol\Phi}$ maps the reference material coordinates $\boldsymbol\chi$ on to the spatial coordinates $\mathbf{x}$. The current material and spatial displacement fields are given as
\begin{equation}
\mathbf{W} = \mathbf{X} - {\boldsymbol\chi}\quad\textrm{and}\quad
\mathbf{w} = \mathbf{x} - {\boldsymbol\chi}
\end{equation}
$\mathbf{H}$ and $\mathbf{h}$ are the gradients of the material and spatial maps and $\mathbf{F}$ the deformation gradient~\cite{kaczmarczyk2014three}, defined as:
\begin{equation}
\mathbf{H}=\frac{\partial {\boldsymbol\Xi}}{\partial {\boldsymbol\chi}},\quad\mathbf{h}=\frac{\partial {\boldsymbol\Phi}}{\partial {\boldsymbol\chi}},\quad\mathbf{F} = \frac{\partial \boldsymbol\varphi}{\partial \mathbf{X}} = \mathbf{h}\mathbf{H}^{-1}
\end{equation}


The time derivative of the physical displacement $\mathbf{u}$ and the deformation gradient $\mathbf{F}$ (material time derivative) are given as~\cite{kaczmarczyk2014three}:
\begin{equation}\label{eq:phy_vel}
\dot{\mathbf{u}}= \dot{\mathbf{w}}-\mathbf{F}\dot{\mathbf{W}} \qquad 
\dot{\mathbf{F}} = \nabla_\mathbf{X} \dot{\mathbf{x}} = \nabla_\mathbf{X} \dot{\mathbf{u}} = 
\nabla_\mathbf{X} \dot{\mathbf{w}} - \mathbf{F} \nabla_\mathbf{X} \dot{\mathbf{W}}
\end{equation}
 
\section{Bone adaptation} \label{sec:bone_remodel}
In this paper, functional adaptation of bone is modelled based on an approach proposed by Kuhl and Steinmann~\citep{kuhl2003theory}. 
It is based on the theory of poroelasticity and open system thermodynamics, with the modification of constitutive equations proposed in Harrigan et al. \citep{harrigan1996bone}. 
It has been shown that the model is stable~\citep{kuhl2003computational}, efficient~\citep{kaczmarczyk2011efficient} and capable of 
producing bone mineral density profiles that are quantitatively comparable with DEXA scans following gait analysis~\citep{pang2012computational}. 
Researchers have been able to simulate bone adaptation in human scapula~\citep{liedtke2017computational}, 
tibia~\citep{pang2012computational}, humerus~\citep{taylor2009phenomenon} and femur with various surgical implants~\citep{ambrosi2011perspectives, Connor2017bone} 
and even explore its potential in topology optimization~\citep{waffenschmidt2012application}. 
One of the advantages of these phenomenological models is that they often require a small number of parameters which can be experimentally
determined from, for example, CT imaging~\citep{zadpoor2013open}.


 \subsection{Conservation of mass}

%Density is a field that evolves in the current material configuration and is defined as:
%\begin{equation}
%	\rho = \rho(\mathbf{X},t) 
%	= \rho\left(
%		\mathbf \Xi( { \boldsymbol {\rm \upchi}}, t), t
%	\right)
%\label{eq:density_material}	
%\end{equation}
%
Following Kuhl and Steinmann~\citep{kuhl2003computational}, it is assumed that
the rate of change of the time-dependent material density is in equilibrium
with mass flux, expressed as:
\begin{equation} \label{eq:mass_balance}
\frac{\partial\rho}{\partial t}  + \dot{\mathbf{W}} \cdot  \nabla_\mathbf{X} \rho = 
\nabla_{\boldsymbol {\rm X}} \cdot \mathbf{R} + \mathcal{R}_0
\end{equation}
where $\rho$ is mass density and $\mathcal{R}_0$ is the locally created mass.
Furthermore, $\mathbf{R}$ is the mass flux defined as:

\begin{equation}
\mathbf{R} = \mathcal{R} \nabla_\mathbf{X} \rho
\label{eq:mass_flux}
\end{equation}

where $\mathcal{R}$ is mass conductivity. The term on the right hand side of Eq. \ref{eq:mass_balance}
is the material time derivative associated with the evolving current material
configuration, as a result of changing topology due to crack propagation. 
However, in the present work it is assumed that the mass flux $\mathbf{R}$ is zero and hence only the local mass source $\mathcal{R}_0$ contributes to the changes in density.


\subsubsection{Constitutive relationship for bone adaptation}

\label{sec:constitutive_eq}

Following Harrigan and Hamilton~\citep{Harrigan1993}, the constitutive
relation for the mass source is:
\begin{equation}
\mathcal{R}_{0}=c\left[\Biggl[\frac{\rho}{\rho_{0}^{\ast}}\Biggr]^{-m}\Psi
-\Psi^{\ast}\right]
\label{eq:mass_source}
\end{equation}
where $\rho_0^\ast$ and $\Psi^\ast$ represent reference values of the
density, $\rho$ and free energy, $\Psi$, respectively. The driving term
$\left[ \rho / \rho_0^\ast \right]^{-m}\Psi$ tends to converge to
$\Psi^\ast$ (see Eq.~(\ref{eq:mass_source})) when density saturation is
achieved and locally generated bone mass ceases. The exponent $m$ is a
dimensionless scalar introduced to guarantee uniqueness and
stability~\citep{Harrigan1993} . Furthermore, the coefficient $c$ controls
the rate of the adaptation process with units~$[\rm{s/cm^2}]$. As proposed
in~\citep{Waffenschmidt2012}, it can be beneficial to prescribe an upper and
lower bound for bone density, thereby avoiding spurious or non-physical
values. In this paper, the parameter $c$, which is conventionally considered 
to be constant, is replaced by a bell function
defined as:
\begin{equation}
\begin{aligned}
c(\rho) = & \frac{1}{1 + \left[  (\rho - \rho^{\mathrm{mid}}) / 
(\rho{^\mathrm{max}} - \rho{^\mathrm{mid})} \right]^{2 b}}\\
& \mathrm{with} \quad \rho^{\mathrm{mid}} = 
\frac{\rho{^\mathrm{max}} + \rho{^\mathrm{min}}}{2}
\end{aligned}
\label{eq:bell_function}
\end{equation}
$\rho^\mathrm{max}$ and $ \rho{^\mathrm{min}}$ where $\rho^\mathrm{max}$
and $\rho^\mathrm{min}$ are the maximum and minimum values of $\rho$, and
$\rho^{\rm {mid}}$ is their average. The bell function
(\ref{eq:bell_function}) is illustrated in Figure~\ref{fig:bell_func} for
different values of the integer exponent, $b$. Its application and influence
on the overall results are elaborated in
Section~\ref{sec:numerical_examples:bone_adap}.
\begin{figure}[!htb]
	\centering
		\input{Figures/tikz/myfile_bell.tex}
		\caption{Bell function plotted for different values of the integer exponent $b$. 
		As $b \rightarrow \infty$, bell-shape curve becomes infinitely steep at 
		$\rho{^\mathrm{min}}$ and $ \rho{^\mathrm{max}}$.}
		\label{fig:bell_func}
\end{figure}

\subsection{Elastic constitutive relationship}
As a porous material, the free energy $\Psi (\mathbf F, \rho)$, for bone is taken as
\begin{equation}
\Psi=\left[\frac{\rho}{\rho_{0}^{\ast}}\right]^{n}\Psi^{\mathrm{neo}},
\label{eq:free_energ}
\end{equation}
where $\Psi^{\rm {neo}}$ is the Helmholtz free energy for a Neo-hookean material, which is expressed in terms of the right
Cauchy-Green deformation tensor $\boldsymbol{\rm{C}}$:
\begin{equation}
\Psi^{\mathrm{neo}}=\frac{\mu}{2}\left[\textrm{tr}(\mathbf{C})-3\right]-\mu\ln(\sqrt{\det\mathbf{C}})+\frac{\lambda}{2}\ln^{2}(\sqrt{\det\mathbf{C}})
\end{equation}
where $\mu$ and $\nu$ are the Lam\'e constants. Moreover, the exponent $n$ is a
non-physical parameter that typically varies as $1 \leq n \leq 3.5$, 
depending on the porosity of the material~\citep{Gibson2005}. 
%This isotropic constitutive law can be extended for the case of anisotropy, if required, using the micro-sphere framework~\citep{Waffenschmidt2012}.

It is clear that bone adaptation is a mechanically driven process, whereby the density field evolves in response to the mechanical environment. Likewise, the material stiffness is directly dependent on the density and this, in turn, influences the mechanical response. Therefore, the equation for conservation of mass \ref{eq:mass_balance} is coupled with the equation for linear momentum balance:
\begin{equation} \label{eq:linear_momentum}
\nabla_{\mathbf X} \cdot \mathbf P = 0
\end{equation}
where $\mathbf P$ is the the first Piola-Kirchhoff stress:  
\begin{equation}
\mathbf P = \frac{\partial \Psi (\mathbf F, \rho)}{\partial \mathbf F}
\end{equation}

This coupled system of equations is solved using the finite element method - see Section \ref{sec:numerical_examples:bone_adap}.





%. MWLS provides additionally a high regularity
%of the field which is a necessity for crack propagation (as will emerge in the following equations).
%That enables to map bone density and its
%gradients onto finite element mesh integration points and
%account for moving background current material mesh, as is shown in following
%sections.

%\subsection{Crack front kinematics}
%
%\begin{figure}
%	\begin{centering}
%	%	\includegraphics[width=12cm]{Figures/CrackSurface.pdf}
%		\def\svgwidth{12cm}
%		\input{Figures/CrackSurface.pdf_tex}
%		\caption{Crack construction~\citep{kaczmarczyk2017energy}.}
%		\label{fig:frac_crack_con}
%	\end{centering}
%\end{figure}
%
%The crack surface is denoted by $\Gamma$ (having two sides distinguished through superscripts $+$ and $-$) with a crack front $\partial
%\Gamma$, see Figure~\ref{fig:frac_crack_con}. 
%Moreover, unit vector, $\mathbf N$, is defined to be normal along the body boundary $\partial {\mathcal{B}}_t$ and the crack boundary $\Gamma^{+} \cup \Gamma^{+} \cup \partial \Gamma$.
%Following~\citep{kaczmarczyk2014three}, a kinematic relationship between the
%change in crack surface area $\dot A_\Gamma$ and the crack front velocity
%$\mathbf{\dot W}$ can be defined as:
%\begin{equation}\label{eq:crack_front}
%\dot A_\Gamma = 
%\int_{\partial \Gamma} \mathbf A_{\partial \Gamma} \cdot 
%{\dot {\boldsymbol {\rm W} } } \mathrm d L 
%\end{equation}
%where $\mathbf A_{\partial \Gamma}$ is a kinematic state variable that
%defines the current crack front orientation. $\mathbf A_{\partial \Gamma}$
%could be seen as a unit vector normal to crack front and tangential to crack
%surface.


\section{Fracture risk and fracture propagation}\label{sec:release_energy}
Various theories exist in the literature regarding failure criteria for bone tissue and it is now common practice for researchers to estimate fracture risk within the framework of FEM. In particular, subject-specific FEM models can potentially quantify the risk of failure under a given loading scenario. However, this still remains an open challenge.

In recent years, the main focus in bone mechanics was in the use of different strength criteria for onset of failure. 
The most commonly adopted ones were based on stress~\citep{keyak2005predicting} or strain measures~\citep{schileo2008subject} assuming the bone failure under the von Mises, the Drucker-Prager or maximum principal strain and maximum principal stress yield criteria~\citep{yosibash2010predicting}. 
The experimental validations for such simplified models show that they have a significant spread in the predicted failure. 
The percentage error in the majority of studies report is between 10\% and 20\%~\citep{van2014accurately}.
This variation is explained perhaps by their focus on the local initiation of failure, rather than the complete failure mechanism. 
The fracture process of bone is very important,  particularly in the case of fatigue fractures~\citep{gupta2008fracture}. 
Limitations in previous studies (e.g. use of 2D geometry~\citep{bettamer2017using}, assuming homogeneous bone properties~\citep{gasser2007numerical}), 
can also explain why an appropriate model for bone fracture has not been developed previously.

%There are many methods available to numerically simulate fracture initiation and growth. 
%They can be divided into two categories: discrete and smeared approaches. 
%Discrete crack models originally were limited to describe crack formation only on element boundaries~\citep{Scordelis1967}. 
%More recently, in the presence of automatic mesh generators, the extended finite element method (xFEM) separated the crack path from the underlying mesh, see e.g.~\citep{Belytschko1999} where xFEM was applied to model brittle fracture. 
%Lattice element approach (also known as rigid body spring networks) have also been used to model discrete crack paths for concrete at computational low cost~\citep{bolanderSaito1998, grassl2010}.  
%Another novel approach in isogeometric analysis that introduces knot insertions that lower the order of continuity to introduce cracks in solids~\citep{Hosseini2014}. 
%The continuum damage, or diffused crack approach, incorporates a damage parameter into the model that controls the strength of the material. An advantage of this approach is that it does not require interface tracking since the damage parameter varies continuously over the domain (see, e.g.~\citep{deBorst2004}). 
%Closely related to continuum damage models are the phase-field models which have become extremely popular over the last decade. 
%The numerical solution of these models is based on an approximate potential developed by Mumford~\citep{Mumford1989}. 
%The main advantage is that the fracture problem can be described purely by partial differential equations~\citep{Miehe2010a,Borst2014}. \\

This paper presents builds on the authors' computational framework~\citep{kaczmarczyk2017energy} for brittle fracture within the context of configurational mechanics, extending it here to include the influence of heterogeneous materials such as bone.
The concept of configurational forces was originally introduced by Eshelby~\citep{eshelby1951force}. 
Unlike physical forces, configurational forces act on the material manifold and represent the tendency of imperfections like cracks, voids or material inhomogeneities to move relative to the surrounding material. 
The past two decades have seen a growing interest in this approach for analysis of material imperfections~\citep{maugin2016configurational} and in particular for evaluating the forces driving crack advancement~\citep{kaczmarczyk2017energy,steinmann2001application, ozencc2016configurational}. 
However, until recently this approach has never been used to effectively assess configurational forces in heterogeneous bodies with cracks. 

In the current study, additional configurational forces arising from inhomogeneities~\citep{kienzler2014configurational}
associated with spatially varying bone density are introduced into the formulation. This allows for the accurate assessment of the likelihood of a crack to propagate and to simulate  the subsequent propagation of fractures in bone. 
An additional goal is to investigate bone fracture at different stages of bone adaptation, utilising the results from bone adaptation analysis or data directly taken from CT scans. 
Similar concepts of combined adaptation and fracture analyses has been presented before~\citep{hambli2013integrated}. 
However, it utilised a different adaptation model and continuum damage mechanics approach for fracture, both of which require many more parameters to calibrate. 

%\section{Brittle fracture in heterogeneous bone}\label{sec:release_energy}

% \subsection{Kinematics}\label{sec:Kinematics}

%In the context of configurational mechanics, an elastic body with an initial
%crack, as visualised in Figure~\ref{fig:frac_kinematics}, is considered. To
%independently observe the deformation of the material in physical space
%$\Omega_t$ and the evolution of the crack surface in material space $\mathcal
%B_t$, it is convenient to decompose the problem into separate configurations.
%First, propagation of the crack is described by the mapping from the
%reference configuration to the current material domain, $\Xi$. Next, purely
%elastic deformation is mapped from the current material to current spatial domain,
%$\mathbf \varphi$. Let $\mathbf x = \varphi(\mathbf X,t)$ describe the motion
%of the body, which transforms material positions, $\mathbf X$, to their
%spatial counterparts, $\mathbf x$. The physical displacements are derived as
%follows:
%\begin{equation}
%\mathbf u = \mathbf x - \mathbf X
%\end{equation}
%
%The reference configuration represents the body before crack extensions with
%mapping $\Xi( { \boldsymbol {\rm \upchi}}, t)$ of the reference
%coordinates, ${ \boldsymbol {\rm \upchi}}$, on to the current material coordinates,
%$\mathbf X$. This mapping describes a material structural change, i.e.
%extensions of the crack, as a result of the crack front movement.
%\begin{figure}[h!]
%	\begin{centering}
%	%	\includegraphics[width=10cm]{Figures/Configurations.pdf}
%	\def\svgwidth{15cm}
%	\input{Figures/Configurations.pdf_tex}
%		\caption{Decomposition of crack propagation in an elastically deforming body.}
%		\label{fig:frac_kinematics}
%	\end{centering}
%\end{figure}
%
%Finally, mapping $\mathbf \Phi ({ \boldsymbol {\rm \upchi}},t)$ transforms
%reference coordinates on to the spatial coordinates, ${\boldsymbol {\rm x}}$.
%The current material and spatial displacements are:
%\begin{equation}
%\mathbf W = \mathbf X - { \boldsymbol {\rm \upchi}} \quad 
%\mathrm{and} \quad \mathbf w = \mathbf x - { \boldsymbol {\rm \upchi}}
%\end{equation}
%$\mathbf H$ and $\mathbf h$ gradients of the material and spatial maps are
%defined as:
%\begin{equation}
%\mathbf H = \nabla_{\boldsymbol {\rm \upchi}} {\boldsymbol {\rm \Xi}}, 
%\quad \mathbf  h =   \nabla_{\boldsymbol {\rm \upchi}} {\boldsymbol {\rm \Phi}}
%\end{equation}
%Corresponding deformation gradient $\mathbf F$ is derived as follows:
%\begin{equation}
%\mathbf F = \nabla_{\mathbf{X}} \varphi = \mathbf h \mathbf H^{-1}
%\end{equation}
%Moreover, the right Cauchy-Green deformation tensor $\boldsymbol
%{\rm C}$ is denoted by:
%\begin{equation}
%\mathbf{C}=\mathbf{F}^{\rm T}\mathbf{F}
%\end{equation}
%
%Moving on, the velocity of a material point $\mathbf X$ and the time
%derivative of the deformation gradient have the following form:
%\begin{equation}\label{eq:crack_disp}
%{\dot {\boldsymbol {\rm u} } } = {\dot {\boldsymbol {\rm w} } } - \mathbf F{\dot {\boldsymbol {\rm W} } }
%\end{equation}
%and
%\begin{equation}\label{eq:crack_def_grad}
%{\dot {\boldsymbol {\rm F} } } = 
%\nabla_{\mathbf X} {\dot {\boldsymbol {\rm w} } } - 
%\mathbf F \nabla_{\mathbf X } {\dot {\boldsymbol {\rm W} } }
%\end{equation}


\subsection{First and second laws of thermodynamics}

The first law of thermodynamics can be expressed as 
\begin{equation}
\label{eq::first_law}
\int_{\partial \mathcal B_t} {\dot {\boldsymbol {\rm u} } } 
\cdot \mathbf t \mathrm d S = \int_{\partial \Gamma } \gamma \dot A_\Gamma +
{\frac{\mathrm d}{\mathrm d t }} 
\int_{\mathcal B_t} \Psi(\mathbf F, \rho) \mathrm d V
\end{equation}
where the left hand side is the power of external work, the first term on the
right hand side is the rate of crack surface energy and the last term is
the rate of internal energy. $\mathbf t$ is the external
traction vector, $\gamma $ is the surface energy $[ {\rm{N m}}^{-1} ]$, $\dot{A}_\Gamma$ is the change in the
crack surface area and
$\Psi$ is the volume specific free energy. The crack surface $\Gamma$ comprises two crack faces and a crack front $\partial\Gamma$ - see Figure~\ref{fig:crac_surf_construct}.

\begin{figure}[th]
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.8\textwidth]{Figures/crack3.eps} 
\def\svgwidth{12cm} 	\input{Figures/CrackSurface.pdf_tex} 
\end{center}
\caption{Crack construction. In 2D (left) and in more detail in 3D (right).}
\label{fig:crac_surf_construct} 
\end{figure}


In~\citep{kaczmarczyk2017energy}, a kinematic relationship between the change in the
crack surface area $\dot{A}_\Gamma$ and the crack front velocity $\dot{\mathbf{W}}$ was derived that is given as:
\begin{equation}
\label{eq::Agamma2}
\dot{A}_\Gamma
 =
\int_{\partial\Gamma}
\mathbf{A}_{\partial\Gamma} \cdot \dot{\mathbf{W}} \textrm{d}L
\end{equation}
where 
$\mathbf{A}_{\partial\Gamma}$ is a dimensionless kinematic state variable that defines the orientation of the current crack front that can be considered a unit vector normal to the crack front and tangential to the crack surface. In deriving this expression, it was recognised that any change in the crack surface area $\dot{A}_\Gamma$ in the current material space can only occur due to motion of the crack front.

Making use of Equations~\ref{eq:phy_vel}) and (\ref{eq::Agamma2}),
and given that $\mathrm d \dot V = \nabla _{\mathbf X} \cdot \mathbf{\dot W}
\mathrm d V$, Eq~\ref{eq::first_law} can be reformulated as:

\begin{equation}\label{eq:crack_first_law}
\int_{\partial \mathcal B_t} \big( {\dot {\boldsymbol {\rm w} } } \cdot \mathbf t - 
{\dot {\boldsymbol {\rm W} } } \cdot \mathbf F^{\rm T} \mathbf t \big) \mathrm d S = 
\int_{\partial \Gamma } \gamma \mathbf A_{\partial \Gamma} 
\cdot {\dot {\boldsymbol {\rm W} } } \mathrm d L + \int_{\mathcal B_t} 
\big( \mathbf P\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm w} } } + 
{\bm  \Sigma}\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm W} } } 
+  \mathbf f^{\mathrm {inh}} \cdot \dot{\mathbf{W}}
\big) \mathrm d V 
\end{equation}
where
\begin{equation}
{\bm {\Sigma}} = \Psi(\mathbf F, \rho) \mathbf  1 - \mathbf F^{\rm T} 
\mathbf P(\mathbf F, \rho),
\, \mathrm{and} \quad
\mathbf f^{\mathrm {inh}} = 
\left.
\frac{\partial \Psi}{\partial \rho}
\right|_{(\mathbf{F} = {\rm{const}})}
\frac{\partial \rho}{\partial \mathbf X} 
\end{equation}
${\bm {\Sigma}}$ is the Eshelby stress tensor and
$\mathbf f^{\mathrm {inh}}$ is an additional fictitious force that drives the crack front from dense to less dense 
material as a result of variations in the density field. 

The
spatial conservation law of linear momentum balance is repeated here:
\begin{equation} \label{eq:linear_momentum}
\nabla_{\mathbf X} \cdot \mathbf P = 0
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
\mathbf{P}\mathbf{N} = \mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
where $\partial\mathcal B_t^\sigma$ is the region of the boundary where tractions are applied. 

The equivalent material momentum balance is expressed as:
\begin{equation}
\nabla_{\mathbf X } \cdot {\bm {\Sigma}}= \mathbf f^{\mathrm {inh}}
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
{\bm {\Sigma}}\mathbf{N} = \mathbf{F}^\textrm{T}\mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
It is important to note that $\mathbf f^{\mathrm {inh}}=\mathbf{0}$ in the case of homogeneous materials, with uniform density distribution.

After applying the divergence theorem to Eq.~\ref{eq:crack_first_law} and recognise the momentum balance laws, we follow~\citep{kaczmarczyk2017energy} to establish a local form of Eq.~\ref{eq:crack_first_law}, which represents an expression for equilibrium of the crack front is expressed as

%Following, the divergence theorem is applied to gradient terms. Considering the volume and boundary integrals, and grouping together terms that are work conjugate to the spatial and material velocities, the local conservation laws are obtained. 
%Furthermore, the surface $\mathcal C$ (Figure~\ref{fig:frac_crack_con})
%collapses to the crack front $\partial \Gamma $ and integrals over the crack
%front are simplified as follows [REF]:
%\begin{equation}
%\lim_{\mathcal C \to 0} \int_{\mathcal C} (\cdot ) \mathrm d S = \lim_{\mathcal C \to 0} \int_{{\mathcal L}_{\rm t}} \int_{ {\mathcal L}_{\rm n}} (\cdot) \mathrm d S = \int_{\partial \Gamma} \lim_{|\mathcal{ L }|\to 0} \int_{{\mathcal L}_{\rm n} } (\cdot ) \mathrm d S
%\end{equation}
%with the integrals at crack front:


%Following \citep{kaczmarczyk2017energy}, the an expression for equilibrium of the crack front is expressed as
\begin{equation}\label{eq:crack_local_first_law}
	{\dot {\boldsymbol {\rm W} } } \cdot 
	\left( \gamma \mathbf A_{\partial \Gamma} - \mathbf G \right) = 0
\end{equation}
where the configurational force $\mathbf{G}$ is the driving force for crack propagation:  
\begin{equation}
	\mathbf G = \lim_{|\mathcal{ L }|\to 0} 
	\int_{ {{\mathcal L}_{\rm n}} } {\bm {\Sigma}}\mathbf{N}\, \mathrm d L 
	\label{eq:crack_configuration_force}
\end{equation}
From this equation, it is clear that the crack front is in equilibrium when the crack is not propagating, i.e. material
velocity $\dot{\mathbf{W}}$ at the crack front is zero, or when the crack front is propagating and the configurational force
is in equilibrium with the material resistance $\gamma \mathbf A_{\partial \Gamma}$. 

It should be noted that crack front equilibrium is unaffected by material heterogeneities and does not depend on $\mathbf f^{\mathrm {inh}}$. All terms in Eq.~\ref{eq:crack_local_first_law} are only evaluated at the crack front. However, it will be shown in Section~\ref{sec:fem_fracture_prop} that, in a discrete setting, calculation of the nodal configurational forces involves a volume integral of the density gradient.

%Second, crack front equilibrium takes
%a similar form to that presented in \citep{kaczmarczyk2017energy}, that, as will be
%shown later, justifies the use of the Griffith criterion, originally proposed
%for homogenous materials.

%In this work, energy is only dissipated due to topology evolution. 
%It is possible to extend the formulation to include other dissipative processes, such as related to cohesive forces.
%
%\subsection{Constitutive equations}
%
%\subsubsection{Fracture}
%In the present work, bone is considered to be perfectly brittle. The likelihood of fracture is evaluated
%for the direction of crack propagation that results in maximum energy dissipation.  
%However, 

Since Eq.~(\ref{eq:crack_local_first_law}) has more than one solution at equilibrium, depending on whether the crack 
does or does not propagate, the formulation is supplemented by a straightforward criterion for crack growth, equivalent to Griffith's  criterion~\citep{kaczmarczyk2017energy}:
\begin{equation} \label{eq:grif1}
\phi(\mathbf{G}) = 
\mathbf{G} \cdot \mathbf{A}_{\partial\Gamma} - g_c/2 \leq 0
\end{equation} 
where $g_c=2\gamma$ is a material parameter specifying the critical threshold of energy release
per unit area of the crack surface $\Gamma$, also known as the Griffith energy. For a point on the crack front to satisfy the crack growth criterion, 
either $\phi<0$ and $\dot{\mathbf{W}}=0$, or $\phi=0$, $\dot{\mathbf{W}}\ne 0$ and $\gamma\mathbf{A}_{\partial\Gamma}=\mathbf{G}$. 


%The crack will propagate only when crack release energy is equal to material
%toughness (and will be arrested when it is lower than toughness). The condition 
%that the crack release energy is greater than the material toughness is an inadmissible state.

The direction of fracture propagation is
constrained by the second law of thermodynamics. Here we assume that fracture takes place
relatively fast compared to the process of adaptation (with no healing), 
such that non-negative dissipation at the crack front can be expressed as
\begin{equation}
	\mathcal{D} = \gamma \dot{\mathbf{W}} \cdot \mathbf{A}_{\partial\Gamma}= \dot{\mathbf{W}} \cdot \mathbf{G}\ge0
\end{equation}
%For brittle fracture, from all possible crack propagation directions, the one which
%maximises dissipation of energy is chosen, leading to the following equation:
%\begin{equation}
%	\gamma \mathbf{A}_{\partial\Gamma} = \mathbf{G}
%\end{equation} 
%where the magnitude of $\mathbf{G}$ can be interpreted as the crack release
%energy $g = 2\gamma$,
%	\begin{equation}
%	 g/2 = \mathbf{G} \cdot \mathbf{A}_{\partial\Gamma}
%\end{equation}

It should be noted that the well-established stress intensity factors are not applicable 
in the case of heterogeneous materials, since it requires the existence of
an analytical solution for the stress field in the vicinity of the crack front that is
independent of arbitrary distribution of density. 
Similarly, the use of
J-integrals requires integration over the closed surface without
inhomogeneities (including heterogeneous density distribution), except for the crack front itself and therefore not applicable in this case.
Finally, it is worth noting the current framework is formulated within 
the realm of large displacements and large strains, hence it 
is generally valid under any assumption for strains and displacements.




\subsection{Density field}
\label{sec:dens_mapping}
The previous subsections have shown that  fracture modelling of bone is influenced by the density distribution in the material configuration. This density field can be generated from either (a) a bone adaptation analysis, solving Eq~(\ref{eq:mass_flux,eq:linear_momentum}), or (b) subject-specific data (geometry and material properties) available from, for example, computed tomography (CT) scans. Previous examples in the literature of subject-specific modelling to assess the stresses and fracture risk of bones can be found in~\citep{poelert2013patient,Helgason2008b,Yosibash2010}. Most algorithms that use voxel data have simply averaged~\citep{zannoni1999material} or integrated data onto finite elements, thereby supplying a constant density within their volume~\citep{taddei2007material, schileo2008subject}. In this paper, radiopacity associated with each 3D voxel from CT scan data is spatially approximated. 

In the numerical examples described later, both sources of density data are used. It will be shown in the next section that, in order to evaluate the configurational forces at the crack front, it is necessary to have a spatially smooth density field. Therefore, discrete density data will need to be approximated as a smooth density field, and this will be achieved by adopting the Moving Weighted Least Squares (MWLS) method. This mapping approach was chosen since it offers higher regularity (i.e. higher derivatives exist) than when the field is
directly approximated on the finite element mesh. Full details are given in Appendix ??. 
%The higher regularity is essential for the crack propagation problem, whereby the second derivative of the density field $\partial^2 \rho^h / \partial \mathbf{X}^2$ appears in the tangent stiffness.







%The density field is described as a discrete field, $v({\boldsymbol{\rm x}}_i)$, where ${\boldsymbol{\rm x}}_i$ is the position vector of each voxel.
%Thereafter, $v({\boldsymbol{\rm x}}_i)$ is mapped onto target points (e.g. mesh nodes or integration points) by means of the Moving Weighted Least Squares (MWLS) method. 
%The main advantage of adopting MWLS is that it provides a smooth density field and gradient over the entire domain leading to significant reduction of noise and a more accurate representation of the data. 


\section{Finite element modelling} \label{sec:fem_modelling}

This section considers the sequential analysis of bone adaptation and fracture propagation. It is recognised that the density field could be obtained directly from subject-specific data, in which case it may not be necessary to undertake the bone adaptation analysis. A sequential approach is justified since the process of bone adaptation takes place at a much longer time scales than fracture.
%Initially, the bone remodelling problem is solved using the finite element method. Then the calculated densities are mapped onto another mesh for solving the fracture propagation problem.
%Mapping of the density field from the first to the second mesh is achieved by using a Moving Weighted Least Squares (MWLS) approach that is described later in Section~\ref{sec:mwls}. 
%This mapping approach was chosen since it offers higher regularity (i.e. higher derivatives exist) than when the field is
%directly approximated on the mesh. The higher regularity is essential for the
%crack propagation problem, whereby the second derivative of the density field 
%$\partial^2 \rho^h / \partial \mathbf{X}^2$ 
%appears in the tangent stiffness.



Three-dimensional domains are discretised with tetrahedral finite elements. 
Fields are approximated in the current material and current spatial spaces with 
hierarchical basis functions of arbitrary polynomial order, following the work of Ainsworth and Coyle~\citep{Ainsworth2003}.  
\begin{eqnarray}
	\rho^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) {\tilde{\pmb\uprho}}(t) \\
	\mathbf{ X}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) \tilde {\mathbf{ X}}(t), 
	\quad \mathbf{x}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}) {\tilde{\mathbf{x}}}(t) \\
	\mathbf{ W}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm \upchi}}) {\dot { \tilde {\boldsymbol {\rm W} } }}(t), 
	\quad \mathbf{w}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}){\dot { \tilde {\boldsymbol {\rm w} } }}(t)
	\label{eq:discretisation}
\end{eqnarray}
where $\mathbf{\Phi}$ are shape functions, superscript $h$ indicates approximation and $(\tilde \cdot)$ nodal
values. Moreover, the smoothed density field is approximated by MWLS shape functions
\begin{equation}
	\rho^{h,\textrm{MWLS}}(\mathbf{X},t) = \Phi^\textrm{MWLS}(\mathbf{X}) 
	\tilde{\pmb\uprho}^h(\Xi({\boldsymbol {\rm \upchi}}),t) 
\end{equation}
It should be noted that shape functions $\Phi^\textrm{MWLS}(\mathbf{X})$ are evaluated at
current material points, $\mathbf{X}$, rather than reference points, $\pmb\upchi$, as presented in Eq.~(\ref{eq:discretisation}) with the property of partition of unity.
Since the density field is evaluated at $\mathbf{X}$, the approximation is independent of changes of the material configuration (i.e.
changing mesh).
%and degrees of freedom $\tilde{\pmb\uprho}^h(\Xi({\boldsymbol {\rm \upchi}}),t)$ are values of density at evaluated points.

\subsection{Bone adaptation}
The bone adaptation problem is solved with a staggered approach, the material configuration is fixed
such that:
\begin{equation}
	\tilde {\mathbf{ X}}(t)	= \tilde {{\boldsymbol {\rm \upchi}}} =  \textrm{const}
	\;\;\textrm{and}\;\;
	\dot{\tilde {\mathbf{X}}}(t) = \dot{\tilde {\mathbf{W}}}(t) = 0
\end{equation}
where $\tilde {{\boldsymbol {\rm \upchi}}}$ is vector of nodal positions. The semi-discrete
form of equations (\ref{eq:mass_balance}) and (\ref{eq:linear_momentum}) takes
the form of residuals
\begin{equation}
	\left\{
	\begin{split}
		\mathbf{r}^\rho(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) =
		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\dot{\tilde{\pmb\uprho}}^h({\boldsymbol {\rm \upchi}},t) 
		\textrm{d}V 
		+
		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T} 
		\mathcal{R} \nabla_\mathbf{X}\pmb{\Phi} \tilde{\pmb\uprho}
		\textrm{d}V
		-	
		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} \mathcal{R}^h_0 
		\textrm{d}V	
		-
		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} 
		\mathbf{q}^\textrm{external} 
		\textrm{d}S	
		= \mathbf{0}\\
		\mathbf{r}^x(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) =
		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X}\pmb{\Phi}^\textrm{T}\mathbf{P}^h\textrm{d}V
		-
		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\mathbf{f}^\textrm{external, remodelling}\textrm{d}S	
		= \mathbf{0}
	\end{split}
	\right.
\end{equation}
where $\mathbf{r}^\rho$ is the vector of residuals related to mass density flux 
equilibrium, $\mathbf{q}^\textrm{external}$ is influx of mass through boundary, 
$\mathbf{r}^x$ is the vector of residuals associated with balance of linear momentum and
$\mathbf{f}^\textrm{external, remodelling}$ are averaged long term forces
mimicking mechanical load on the bone over long time period and $\mathcal{R}$ is mass conductivity. After expanding
residuals in Taylor series, and truncating after linear term, i.e.
linearisation, the algebraic system in semi-discrete form is obtained:
\begin{equation}
	\left[
		\begin{array}{c}
			\mathbf{r}^\rho(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))\\
			\mathbf{r}^x(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))
		\end{array}
	\right]
	+
	\left[
	\begin{array}{cc}
		\mathbf{M}_{\rho\rho} & \mathbf{0}\\
		\mathbf{0} & \mathbf{0}
	\end{array}
	\right]
	\left\{
		\begin{array}{c}
		\delta\dot{\tilde{\pmb\uprho}}_{i+1}(t)\\
		\delta\dot{\tilde{\mathbf{x}}}_{i+1}(t)
		\end{array}
	\right\}
	+
	\left[
		\begin{array}{cc}
			\mathbf{K}_{\rho\rho} & \mathbf{K}_{\rho x}\\
			\mathbf{K}_{x\rho} & \mathbf{K}_{xx}
		\end{array}
		\right]
		\left\{
			\begin{array}{c}
			\delta\tilde{\pmb\uprho}_{i+1}(t)\\
			\delta\tilde{\mathbf{x}}_{i+1}(t)
			\end{array}
		\right\}
		=
		\left[
			\begin{array}{c}
				\mathbf{0}\\
				\mathbf{0}
			\end{array}
		\right]
		\label{eq:tangent_remodelling}
\end{equation}
with
\begin{equation}
\begin{split}
\mathbf{M}_{\rho\rho} = 
\left.
\frac{\partial \mathbf{r}^\rho}{\partial \dot{\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
\mathbf{K}_{\rho\rho} = 
\left.
\frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
\mathbf{K}_{\rho x} = 
\left.
\frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\mathbf{x}}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,\\
\mathbf{K}_{x \rho} = 
\left.
\frac{\partial \mathbf{r}^x}{\partial {\tilde{\pmb\uprho}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
\mathbf{K}_{x x} = 
\left.
\frac{\partial \mathbf{r}^x}{\partial {\tilde{\mathbf{x}}}}
\right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},
\end{split}
\end{equation}
and 
\begin{equation}
\tilde{\pmb\uprho}_{i+i}(t) =
\tilde{\pmb\uprho}_{i}(t) + \delta\tilde{\pmb\uprho}_{i+i}(t),\;
	\tilde{\mathbf{x}}_{i+i}(t) =
	\tilde{\mathbf{x}}_{i}(t) + \delta\tilde{\mathbf{x}}_{i+i}(t)
\end{equation}
where $(\cdot)_i$ is quantity at Newton iteration $i$. Finally, the
above semi-discrete problem is discretised in time using implicit Euler scheme:
\begin{equation}
	\dot{\tilde{\pmb\uprho}}_{i+i}^{n+1}(t) =
	\frac{
	\tilde{\pmb\uprho}_{i+i}^{n+1}-\tilde{\pmb\uprho}^{n}
	}{\Delta t}
\end{equation}
where $\Delta t$ is length of time step, and $n$ is time step number.

It is worth noting that density is approximated by base  function of one polynomial less than spatial positions in
order to produce stable solution without oscillations.

The nonlinear equations (mass
balance~Eq.~(\ref{eq:mass_balance}) and momentum
balance~Eq.~(\ref{eq:linear_momentum})) are discretised and solved iteratively by
using the Newton-Raphson method for the displacements and density.

%NECESSARY??
%
%Two approaches have been implemented regarding evaluations of tangent stiffness,
%i.e by either analytically evaluating the higher dimensional derivatives of the residuals of $\mathbf{r}_{x}$ and $\mathbf{r}_{\rho}$ as 
%presented in Eq.~(\ref{eq:tangent_remodelling}) or by means of automatic differentiation using the ADOL-C 
%library~\citep{Walther2009}. At this point, it is interesting to note that analyses presented in this paper using automatic 
%differentiation are about 25~$\%$ slower than the analytical formulation due to increased assembly time.
%Nevertheless, ADOL-C significantly simplifies the implementation process, it is then reasonable to use it at the early stages of development.
%
\subsection{Fracture propagation} \label{sec:fem_fracture_prop}

The problem of bone adaptation and crack propagation or calculation of crack
release energy has different boundary conditions and geometry. 
To solve the staggered coupled problem, initially bone adaptation is simulated under 
long-term effective loads applied without initial crack. Subsequently, an 
initial crack is placed to the resulting mesh to compute the effect 
of short-term loads or extreme cycling loading. The two different remodelling and crack propagation 
meshes are tailored for the each type of problem analysed, respectively. As
a consequence, the approximated Piola stress tensor for bone
adaptation is expressed as follows:
\begin{equation}
	\mathbf{P}^\textrm{h} = 
		\mathbf{P}(\mathbf{F}^\textrm{h}, \rho^h)
\end{equation}
whereas for the fracture propagation problem, it is approximated as
\begin{equation}
	\mathbf{P}^{\textrm{h},\textrm{MWLS}} = 
		\mathbf{P}(
		\mathbf{F}^\textrm{h}, \rho^{h,\textrm{MWLS}})
\end{equation}

%Note that in the presented approach, one can load initial density from CT
%scans, run bone adaptation analysis and subsequently introduce crack to calculate the 
%release energy. It is also possible to load densities directly onto mesh with a prescribed fracture as presented on Figure \ref{fig:framework}.
%In each case, initial density is approximated using MWLS and then projected on current 
%material configuration.

The residual force vector in the discretised spatial domain is expressed in the classical way as:
\begin{equation}
\label{spatial_residual}
	\mathbf{r}_\textrm{s}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) = \tau\mathbf{f}^\textrm{h}_\textrm{ext,s}-\mathbf{f}^\textrm{h}_\textrm{int,s}=\tau \int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}
	\mathbf{f}^\textrm{ext}
	\textrm{d}S-
	\int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T}
	\mathbf{P}^{h,\textrm{MWLS}}\textrm{d}V=\mathbf{0}
\end{equation}
where $\tau$ is the unknown scalar load factor, $\mathbf{f}^\textrm{h}_\textrm{ext,s}$ is the vector of externally applied forces and $\mathbf{f}^\textrm{h}_\textrm{int,s}$ is the vector of internal forces. 

Discretisation of Eq.~\ref{eq:crack_local_first_law} establishes the material counterpart to Eq.~\ref{spatial_residual}, expressed as
\begin{equation}
\label{material_residual}
\mathbf{r}_\textrm{m}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) = \mathbf{f}^\textrm{h}_\textrm{res}-\tilde{\mathbf{G}}^\textrm{h}=\mathbf{0}
\end{equation}
$\tilde{\mathbf{G}}^\textrm{h}$ is the vector of nodal configurational forces only on nodes on the crack front, with the integration restricted to elements adjacent to the crack front:
\begin{equation}
	\tilde{\mathbf{G}}^\textrm{h} = 
	\int_{\mathcal{B}^h_t}
		\nabla_\mathbf{X}\pmb{\Phi}^\textrm{T} {\pmb\Sigma}^{h,\textrm{MWLS}}
	\textrm{d}V
	+
	\int_{\mathcal{B}^h_t}
		\pmb{\Phi}^\textrm{T} \dfrac{\partial {\Psi}^{h,\textrm{MWLS}} }{\partial \rho^{h,\rm{MWLS}}}
		\left(
			\frac{\partial 
			\rho^{h,\textrm{MWLS}}}{\partial \mathbf{X}}
		\right)
	\textrm{d}V
	\label{eq:mat_int_front}
\end{equation}
These configurational forces are the driving force for crack propagation. It should be noted that the second term of $\tilde{\mathbf{G}}^\textrm{h}$ reflects the influence of the spatially varying density. In the case of a homogeneous material, this second term would be zero. It should also be noted that this is only the case for the discretised configurational forces and that the continuum equivalent (Eq.~\ref{eq:crack_configuration_force}) is unaffected by variation in the density field.

$\mathbf{f}^\textrm{h}_\textrm{res}$ is the vector of nodal material resistance forces, given as:
\begin{equation}
\mathbf{f}^\textrm{h}_\textrm{res}=\frac{1}{2}\left(\tilde{\mathbf{A}}_\Gamma^\textrm{h}\right)^\textrm{T}\mathbf{g}_\textrm{c}
\end{equation}
where $\mathbf{g}_\textrm{c}=\mathbf{1}g_\textrm{c}$ is a vector of size equal to the number of nodes on the crack front. $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ defines the current orientation of the crack front and is a matrix comprising direction vectors along the crack front that are normal to the crack front and tangent to the crack surface:
\begin{equation}
\tilde{\mathbf{A}}_\Gamma^\textrm{h} = 
\int_{S^h_\Gamma}
\pmb{\Phi}^\textrm{T} 
\frac{\partial {A}^h_{\Gamma}}{
\partial \tilde{\mathbf{X}}}
\textrm{d}L
\end{equation}
$\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ is evaluated by only integrating over $S_\Gamma^\textrm{h}$ that defines the area of those triangular finite elements that discretise the crack surface $\Gamma^\textrm{h}$ adjacent to the crack front $\partial\Gamma^\textrm{h}$.
$A^\textrm{h}_{\Gamma}$ is calculated as:
\begin{equation}
A^\textrm{h}_{\Gamma} = 	
	\| \mathbf{N}(\tilde{\mathbf{X}}) \|
=
\left\| 
\epsilon_{ijk}
\frac{\partial \Phi^\alpha_p}{\partial \xi_i}  
\frac{\partial \Phi^\beta_r}{\partial \xi_j} 
\tilde{X}^\alpha_p
\tilde{X}^\beta_r
\right\|
\end{equation}
where $\alpha, \beta \in \{0, \dots, N_{\rm{base}}\}$ are numbers of base functions,
$i,j,k,l,p,r \in \{0,1,2\}$ are material indices and $\boldsymbol{\upepsilon}$ is the Levi-Civita tensor. 
Moreover, the total number of degrees of freedom on element is $3(N_{\rm{base}}+1)$ and the units of $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ are $[{\rm m}^{-1}]$. $\mathbf{N}$ are the normals to the crack surface $\Gamma$.




%Let the whole surface ${\partial\mathcal{B}^h_t}$ of the body domain, ${\mathcal{B}^h_t}$, at current material
%configuration be discretised by non overlapping triangles $\mathcal{T}_i$ whose collection is defined as:
%\begin{equation}
%	\mathcal{T} := \left\{ 
%		\mathcal{T} \in {\partial\mathcal{B}^h_t} : 
%		\mathcal{T}_i \cap \mathcal{T}_j  = \emptyset \;\;
%		\textrm{and}\;\;
%		{\partial\mathcal{B}^h_t} = \sum_i^\tau \mathcal{T}_i 
%	\right\}
%\end{equation}
%where $\tau$ is the total number of triangles on ${\partial\mathcal{B}^h_t}$.
%Furthermore, crack front is approximated by edges $\Gamma^h$, defined similarly to
%triangles, but with one dimension lower. With the above at hand, the triangulated domain can be defined with triangles that are part of body boundary and
%adjacent to the crack front as:
%\begin{equation}
% S^h_\Gamma :=
% \left\{
%	 \mathbf{X} \in \mathcal{T}
%	 : \partial \mathcal{T} \cap \Gamma^h \neq \emptyset
% \right\}
%\end{equation}
%Next, a matrix of crack tangent vectors can be defined as follows:

%Therefore, multiplication of $\mathbf{Z}^{\rm{front}}$ with nodal crack release energy ${\tilde{\mathbf{g}}}^h$ results in
%evaluation of crack configurational forces:
%
%
%\begin{equation}
%\mathbf{f}^\textrm{material,internal,crack}	= \dfrac{1}{2} {(\mathbf{Z}^\textrm{front})}^{\rm{T}} {\tilde{\mathbf{g}}}^h 
%	\label{eq:mat_int_crack}
%\end{equation}
%
%Combining Eqs.(\ref{eq:mat_int_crack}) and (\ref{eq:mat_int_front}) equilibrium at the crack front can be evaluated through the residual:
%
%\begin{equation}
%\mathbf{r}^h_{\textrm{material,crack}} = \dfrac{1}{2} {(\mathbf{Z}^\textrm{front})}^{\rm{T}} {\tilde{\mathbf{g}}}^h - \tilde{\mathbf{G}}^\textrm{h} = \mathbf{0}
%	\label{eq:residual_crack}
%\end{equation}
%
%Subsequently. by multiplying Eq.~(\ref{eq:residual_crack}) on both sides with $\mathbf{Z}^\textrm{front}$ and solving for ${\tilde{\mathbf{g}}}^h$ the expression below is obtained:
%
%
%\begin{equation}
%	{\tilde{\mathbf{g}}}^\textrm{h}
%	= 2
%	\left[
%	\left(\mathbf{Z}^{\rm{front}}{(\mathbf{Z}^{\rm{front}})}^\textrm{T}\right)^{-1}
%	\mathbf{Z}^{\rm{front}}
%	\right]
%	\tilde{\mathbf{G}}^\textrm{h}	
%\label{eq:gc_lagrange}
%\end{equation}
%
%
%which leads 
%immediately to fracture. %spontaneous and catastrophic
%Since the scope of this paper is limited to the calculation crack release
%energy only, the nodal internal configurational forces on front crack nodes are
%calculated as follows:
%where $\tilde{\mathbf{G}}^\textrm{h}$ is a vector of degrees of
%freedom only on crack front nodes and integration takes place only on
%tetrahedrons adjacent to crack front nodes, similarly to integration of the crack
%area tangent vectors matrix presented in the next subsection.

% \subsection{Material problem for crack release energy}
%
% The nodal configurational forces 
% $\tilde{\mathbf{G}}^\textrm{h}$ are evaluated at
% the crack front nodes. 
% %Moreover, the dimension of configurational nodal force is
%% $[\rm{J/m}]$, but Griffith cracks release energy should be in units $[{\rm{J/m}}^2]$.
%% That discrepancy disappears in-plane stress analysis, where configurational
%% forces are divided by the thickness of the body. 
% The magnitude of nodal configurational forces at the crack front node is the value of J-integral. 
%% In the case of 3D analysis, to remove that discrepancy in units some researchers
%% divide adjacent edges into half \citep{GuersesMiehe2009}. However, that gives the
%% correct value for crack release energy only for straight crack fronts.
%
%
%It can be noticed that by comparison of Eq.~({\ref{eq:gc_lagrange}}) with Theorem 1(3.) in \citep{AinsworthEssential} 
%nodal Griffith surface energy ${\tilde{\mathbf{g}}}^h$ could be interpeted as a Lagrange multiplier constraining the crack area growth.
%Furthermore, dimension term in square brackets on left hand side of Eq.~(\ref{eq:gc_lagrange}) is $[\rm{1/m}]$ which multiplied by dimension
%of configurational force $[\rm{J/m}]$ gives dimension of crack release energy, i.e.
%$[{\rm{J/m^2}}]$. Thereby, the main advantage of the presented approach is that crack release 
%energy is expressed exclusively in terms of nodal quantities, which enables
%implicit formulation of crack propagation algorithm, however this is 
%out of the scope of this work.

\section{Singularity element}
%\section{Approximation}
%\subsection{Quarter point elements} %should that be in appendix?

%Following bone adaptation or using subject-specific data from CT scans, it can be useful to assess the likelihood of fracture without undertaking a full fracture propagation analysis. In such cases it is 
It can be useful to reproduce the singular stress field at the crack front. However, conventional finite elements that adopt polynomial approximation functions are unable to do this. 
In this paper we briefly present a new type of finite element with hierarchical approximation functions that overcome this problem. This is inspired by the so-called quarter-point elements, originally developed in the 1970s, whereby the mid-node of all edges connected to the crack tip node were shifted to the quarter-point~\citep{barsoum1976use,henshell1975crack}. In this work, all bodies are discretised using 3D tetrahedral elements. However, for simplicity, we present the main attributes in this paper in 1D.

%The results is a nonlinear mapping between natural (isoparametric) and local coordinates $\xi \rightarrow x$ which produces  the square root singularity. Stress and strain fields are dependent on the radial function of the crack tip, reaching infinity as $ r \rightarrow 0$. \\

% \subsubsection{Standard shape functions} 

% %\textcolor{red}{Only focus on hierarchical base functions, drop standard, that is not novel.} \\

% The concept of quarter point element is briefly described by means of 1D 2-nd order finite element with standard base shape functions. 
% Global configuration of 2-nd order element with nodes 0, 2 and 1 is schematically presented in Figure~\ref{fig:1d-quarter}(a) where node 0 coincides with the crack tip.
% Furthermore, the natural coordinate system of the element is presented in Figure~\ref{fig:1d-quarter}b and the corresponding standard shape functions $N_0$, $N_2$ and $N_1$ are presented in Figure~\ref{fig:1d-quarter}c.  
% \begin{figure}[h!]
% 	\begin{center}
% 		\begin{tabular}{c}
% 		{\def\svgwidth{15cm} \input{Figures/QuarterPoint.pdf_tex}}\\  %& \includegraphics[height=2.1cm]{Figures/2ndOrderNodeOr.pdf} &   &  \includegraphics[height=1.3cm]{Figures/StandardElement.pdf}\\
% 		\end{tabular}
% 		\caption{1D 2-nd order quarter-point element with standard shape functions:a) global configuration, b) natural coordinates, c) base shape functions }
% 		\label{fig:1d-quarter}
% 	\end{center}
% \end{figure}
% Let the demonstrated element be a quarter-point type, the distance between node 0 with nodes 2 and 1 is given by radial coordinate $r_{\rm q}$ (see Figure~\ref{fig:1d-quarter}(a)). 
% The position of the middle node 2 is controlled by the parameter $\kappa$. 
% The quadratic 1D displacement function of this element is: 
% \begin{equation}\label{eq:crack_disp_func}
% \begin{aligned}
% &u(\xi) = \sum_{a=0}^2 N_a (\xi) u^{(a)} = \frac{1}{2} \xi (\xi - 1)u^{(0)} + (1 - \xi^2)u^{(2)} + \frac{1}{2} \xi (\xi + 1)u^{(1)} =\\
% & u^{(2)} + \frac{1}{2}(u^{(1)} - u^{(0)})\xi + \left[ \frac{1}{2} (u^{(0)} + u^{(1)}) - u^{(2)} \right] \xi^2 
% \end{aligned}
% \end{equation}
% Note that Eq.~(\ref{eq:crack_disp_func}) is ordered by powers of $\xi$ that is element natural coordinate. 
% In the classical isoparametric formulation, the same interpolation functions are also used for the coordinates, i.e. as well for the radius $r_{\rm q}$ with the nodal values $r^{(0)}_{\rm q} = 0$, $r^{(2)}_{\rm q} = \kappa l$, $r^{(1)}_{\rm q} = l$:
% \begin{equation}\label{eq:crack_radius_dep}
% r_{\rm q}(\xi) = \sum_{a=0}^2 N_a (\xi) r^{(a)}_{\rm q} = \kappa l + \frac{1}{2} l \xi  + \left(  \frac{1}{2} - \kappa \right) l \xi^2.
% \end{equation}
% Any value chosen for $\kappa$ would fulfil equality $r_{\rm q}(\xi=-1) = 0$ in Eq.~(\ref{eq:crack_radius_dep}).
% However, the aim of quarter point element is to generate an approximated displacement field, $u(r_{\rm q})$, so that the resulting strains evaluated as $\varepsilon (r_{\rm q}) = \partial u(r_{\rm q})/\partial r_{\rm q}$.
% To achieve this, a $r^{\theta}_{\rm q}$ term with $\theta < 1$ in Eq.~(\ref{eq:crack_disp_func}) should be pursued.
% Here, value $\kappa = 1/4$ is used providing the following relations:
% %From Eq.~(\ref{eq:crack_radius_dep}) it can be derived that radius $r_{\rm q}(\xi=-1) = 0$ for $ \kappa=1/4$, providing the following relations:
% \begin{equation}
% r_{\rm q}= \frac{l}{4}(1+\xi)^2 \quad \Rightarrow \quad \xi = 2 \sqrt{\frac{r_{\rm q}}{l}} -1,
% \end{equation}
% which substituted into Eq.~(\ref{eq:crack_disp_func}) results to an expression with a term $r^{0.5}_{\rm q}= \sqrt{r_{\rm q}}$ renders the desired radial dependence of the displacements $u(r_{\rm q})$ and strains $\varepsilon(r_{\rm q})$:
% \begin{equation}
% \begin{aligned}
% u(r_{\rm q}) = u^{(0)} &+ \left( -3u^{(0)} - u^{(1)} +4u^{(2)} \right) \sqrt{\frac{r_{\rm q}}{l}} + 2 \left( u^{(0)} + u^{(1)} -2 u^{(2)} \right) \frac{r_{\rm q}}{l}\\
% \varepsilon(r_{\rm q}) = \frac{\partial u}{ \partial r_{\rm q}} = &+ \left( - \frac{3}{2}u^{(0)} - \frac{1}{2}u^{(1)} +2u^{(2)} \right) \frac{1}{\sqrt{lr_{\rm q}}} + 2 \left( u^{(0)} + u^{(1)} -2 u^{(2)} \right) \frac{1}{l}
% \end{aligned}
% \end{equation}
% The displacement function contains now a constant (rigid body motion) and linear function also a $\sqrt r_{\rm q}$ term, which reproduces the displacement field at the crack tip. 
% The strain in the quarter-point element possesses the square root $1/{\sqrt r_{\rm q}}$ singularity.
%\subsubsection{Hierarchical shape functions}
%In this section, the concept of 2-nd order quarter-point element formulation with standard shape function is extended to the case of hierarchical shape functions.
%A more detailed description for higher dimensions can be found in, for example,~\citep{nejati2015use}.

%The adoption of hierarchical approximation functions~\citep{Ainsworth2003}  used in this work does not introduce extra nodes beyond those at the vertices. This feature greatly simplifies both $p$~- and $hp$~-refinement.

For elements adjacent to the crack tip in the material configuration, the approximated material displacement field, using hierarchical shape functions (up to 2nd order), is expressed as:
\begin{equation}\label{eq:hierarchical_u}
W(\xi) = \sum_{a=0}^2 N_a (\xi) W^{(a)} = (1 -\xi)W^{(0)} + \xi W^{(1)} + \kappa (1 - \xi) \xi W^{(2)}
\end{equation}
where the natural coordinate $0\le \xi \le 1$ and $N_2 = \kappa N_0 N_1 =  \kappa\xi(1 - \xi)$. The introduction of the parameter $\kappa$ leads to a nonlinear mapping between the natural and physical coordinates and results in the desired singular stress and strain field at the crack tip. 

Adopting an isoparametric formulation, the element geometry can also be interpolated using the same approximation functions. Thus, the physical distance from the crack tip is expressed as:
\begin{equation}\label{eq:hierarchical_r}
r_{\rm q}(\xi) = \sum_{a=0}^2 N_a (\xi) r_{\rm q}^{(a)} = \xi l + \kappa \xi(1-\xi)  l 
\end{equation}
where $r_{\rm q}(\xi=0)=0$ at the crack tip and $r_{\rm q}(\xi=1)=l$. Setting $\kappa=-1$ results in the following relationship:
\begin{equation}
r_{\rm q}= \xi l - \xi(1-\xi)l= \xi l \quad \Rightarrow \quad \xi = \sqrt{\frac{r_{\rm q}}{l}},
\end{equation}
This  yields the following radial dependence for displacements and strains:
\begin{equation}\label{eq:singstrain}
\begin{aligned}
W(r_{\rm q}) &= W^{(0)} + \left( -W^{(0)} + W^{(1)} - W^{(2)} \right) \sqrt \frac{r_{\rm q}}{l} - W^{(2)} \frac{r_{\rm q}}{l}\\
\varepsilon(r_{\rm q}) &= \frac{\partial W}{\partial r_{\rm q}} = \left( W^{(0)}  + W^{(1)} - W^{(2)}  \right) \frac{1}{2} \sqrt \frac{l}{r_{\rm q}} + W^{(2)} \frac{1}{l}
\end{aligned}
\end{equation}
Expressions in Eq.~(\ref{eq:singstrain}) have the necessary terms to reproduce rigid body motion and pass the patch tests, as well as the desired singularity at the crack tip due the existence of the term $1 / \sqrt r_{\rm q}$. This will enable the elements adjacent to the crack front to reproduce the strain singularity resulting in an accurate finite element solution~\citep{nejati2015use}. 
The influence of this approach for tetrahedral elements will be investigated in Section~\ref{sec:quarter_point_results}.

\section{Numerical examples}
\label{sec:numerical_examples}
Several numerical examples are presented to illustrate each aspect of the proposed framework. 
The first set of analyses, presented in Subsection~\ref{sec:numerical_examples:bone_adap}, considers bone adaptation, using an equine 3rd metacarpal bone as a case study.
The second set of analyses, in Subsection~\ref{sec:mals_mapping}, shows the results of MWLS mapping onto an FE mesh. 
The performance of the singularity element formulation is demonstrated in Subsection~\ref{sec:release_energy_rate} using a finite plate with through thickness crack subjected to uniaxial stress. In the penultimate subsection, the framework is used to investigate the likelihood of fracture at different  stages of adaptation. The final subsection considers fracture propagation at different stages of adaptation.



%Finally, the results of release energy rate for simple finite plate problem and metacarpal bone are presented in Subsection~\ref{sec:release_energy_rate} verifying the implementation. 
%Additionally, convergence study is conducted with and without quarter point elements at the crack tip.
\subsection{Bone adaptation examples}
\label{sec:numerical_examples:bone_adap}
This subsection considers the bone adaptation of an equine 3rd metacarpal bone. 
In the UK, approximately 60\% of horse fatalities at racecourses are directly or indirectly associated with a fracture, with the distal limb the most commonly affected site \citep{parkin2004risk}.
Most of these fractures occur due to the accumulation of tissue fatigue, as a result of repetitive loading~\citep{Parkin2005}, rather than a specific traumatic event. 
Racehorses experience extreme bone adaptation, with intense exercise and excessive loading of the metacarpal bones resulting in maladaptation. 
The location of 3rd metacarpal fractures is remarkably consistent across a large number of racehorses,  with crack initiation presenting from 
the lateral para-sagittal groove of the distal condyle of the leading forelimb~\citep{jacklin2012frequency, parkin2006analysis}.
Despite considerable research in the field, including applying diagnostic methods such as radiography 
\citep{bogers2016quantitative, crijns2014intramodality, loughridge2017qualitative}, magnetic resonance imaging 
\citep{tranquille2017MRI} and biomarkers~\citep{mcilwraith2005use}, it still remains a challenge to accurately predict the fracture risk 
and prevent this type of significant injury.

Three cases are studied, all using the same material parameters presented in Table~\ref{tab:parameters_mc3}.
Stiffness and porosity values are derived from mechanical tests~\citep{Les1994}, whereas other values are from previous studies of human tibia~\citep{Pang2012,Waffenschmidt2012}. 

Each case considers a different function for the parameter $c$ that defines the rate of bone adaptation and used to compute the mass source, $\mathcal{R}_0$, according to Eq.~(\ref{eq:mass_source}).
In Case~1, $c$ is constant. For Case~2 and Case~3 different bell functions (Eq.~(\ref{eq:bell_function}) are used. The parameters for each case are presented in Table~\ref{tab:three_cases}. 
The finite element mesh used in all cases comprises 17041 tetrahedral elements and was generated by discretising the segmented geometry of a full-scale model of equine 3rd metacarpal bone derived from CT scan data - see Figure~\ref{fig:mc3_BC}.

For each analysis, the initial density is chosen to be homogeneous since, in the thermodynamic-based model, the starting density does not have a significant effect on the final bone density distribution (similar to other models at biological equilibrium~\citep{kuhl2003theory}). % is not sensitive to the initial density
Boundary conditions are simplified to two representative forces (5~$\text{[kN]}$~each) spanning over a small area based on pressure film studies~\citep{Brama2001}, as demonstrated in Figure~\ref{fig:mc3_BC}. 
The two forces are often considered in the literature as an equivalent of joint peak force at the mid-stance of a horse gait. %Obviously, with such simplified loading case the analysis is not sufficient to produce any quantitative results regarding remodelling of the metacarpal but rather to demonstrate the potential of this approach. 
An adaptive time stepping scheme (using PETSc~\citep{petsc-web}) is used in all the simulations with an initial time step $\Delta t = 0.5$~$[\text days (d)]$, maximum time step of $\Delta t_{\text {max}} = 50$~$[\text d]$ and minimum of $\Delta t_{\text {min}} = 0.05$~$[\text d]$.
\begin{table}[h]
	\centering
	\begin{tabular}{lll}
		\hline
		Parameter             & Description                  & Value  \\ \hline
		$E  $                 & Young's modulus              & $4700 \,\mathrm{ [MPa]}$ ~\citep{Les1994} \\
		$\nu  $               & Poisson ratio                & $0.3 \,\mathrm{ [-]}$ \\
		$\rho_0 ^\ast  $      & Initial density              & $1.0 \,\mathrm{[ g/cm^{3}]}$  \\
		$\psi_{0}^\ast $      & Target energy density        & $0.0275\,\mathrm{ [MPa]}$  ~\citep{Waffenschmidt2012}  \\
		$c$                   & Density growth velocity      & $1.0 \,\mathrm{ [d/cm^{2}]}$   \\
		$m$                   & Algorithmic exponent         & $ 3.25 \,\mathrm{ [-]}$          \\
		$n$                   & Porosity exponent            & $2.25 \,\mathrm{ [-]}$     ~\citep{Les1994}   \\ 
		\hline
	\end{tabular} 
	\caption{Material parameters used for the simulations of 3rd metacarpal bone adaptation.}
	\label{tab:parameters_mc3}
\end{table}


\begin{table}[h]
	\centering
	\begin{tabular}{lllll}
		\hline
		Case                  & $c$              				       & $b$     &$\rho^\mathrm{max}$               &$\rho^\mathrm{min}$ \\ \hline
		1                     & 1              								 & -       & -                                & -\\
		2                     & Eq.~(\ref{eq:bell_function})   & 1000    & 2.5~$[{\text{g/cm}}^3]$          & 0.3~$[{\text{g/cm}}^3]$\\
		3                     & Eq.~(\ref{eq:bell_function})   & 30      & 1.8~$[{\text{g/cm}}^3]$          &1.0~$[{\text{g/cm}}^3]$ \\
		\hline
	\end{tabular} 
	\caption{Presentation of three cases input parameters for the evaluation of coefficient $c$ to compute mass source, $\mathcal{R}_0$, as presented in Eq.~(\ref{eq:mass_source}). All cases have common material input parameters presented in Table~\ref{tab:parameters_mc3}.}
	\label{tab:three_cases}
\end{table}

\begin{figure}[h]
	\begin{center}
		   \begin{tikzpicture}
				\node at (0,0) {\includegraphics[width=8cm]{Figures/mc3_BC.png}};
				\node at(-3.5,-1.8){$F = 5 \mathrm{kN}$ };
				\node at(-4.1,-0.7){ $F = 5 \mathrm{kN}$ };
	\end{tikzpicture}
		\caption{Finite element mesh of the equine 3rd metacarpal bone. The subject specific three-dimensional mesh consists of 14,041 quadratic tetrahedral elements and 70,901 degrees of freedom. To simulate the peak load of a gallop, 5 kN forces are applied on the lateral and medial side of the distal condyle.}
		\label{fig:mc3_BC}
	\end{center}
\end{figure}

Results of Case~1 are presented in Figure~\ref{fig:mc3_density} where density maps at five different points in time $(\text{0, 10, 40, 100, 700})$~$[\text d]$ are visualised. 
Significant densification occurred immediately after reaching the maximum level of the loading, particularly in the proximity of the applied forces, associated with high levels of strain energy. Conversely, areas with low levels of strain energy experience a reduction in density.
After 100~$[{\text d}]$, biological equilibrium was achieved and no further changes in density took place. 
The resulting maximum density is 2.8~$[{\text {g/cm}}^3]$ and the minimum is close to zero.
\begin{figure}[h!]
	\centering
	\begin{tikzpicture}
	\node at (0,0) {	\input{Figures/tikz/mc3_density.tex} };
	\node at(0.,1.5){ \includegraphics[width=9cm]{Figures/tikz/mc3_density_fig.png}};
	\node at(3,3){                    	\def\svgwidth{5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
	
	\end{tikzpicture}
	%	\includegraphics[width=15cm]{Figures/tikz/mc3_density.png}
	\caption{Case~1: Change in overall mass of the bone over time. Density distribution contours in 3rd metacarpal bone at five snapshots in time.}
	\label{fig:mc3_density}
\end{figure}



When adaptation converges to an equilibrium state, an interesting phenomenon is observed.
For each density level there is a corresponding value of constant strain energy density $\psi$
This result is a direct consequence of the constitutive Eq.~(\ref{eq:mass_source}).
This feature can be visualised by plotting the strain energy density on the contours of constant density levels as presented in Figure~\ref{fig:mc3_biol_eq}. 


\begin{figure}
	\centering
%	\begin{tikzpicture}
%	\node at (2,0) {	\includegraphics[width=16cm]{Figures/mc3_biol_eq.png} };
%	\node at (0.4,-0.6) {\includegraphics[width=3cm]{Figures/scale_bars/mc3_biol_eq_scale1.pdf}};
%	\node at (9,2)  {\includegraphics[width=4.5cm]{Figures/scale_bars/mc3_biol_eq_scale2.pdf}};
%	\node at (1,-2)  { a) \hspace{5cm} b) \hspace{5cm} c) };
	\def\svgwidth{14cm}
	\input{Figures/mc3_biol_eq.pdf_tex}
%	\end{tikzpicture}
	\caption{Case 1: Biological equilibrium state. a) Density map. b) Contours of density. c) Strain energy plotted on contours of density.}
	\label{fig:mc3_biol_eq}
\end{figure}


The maximum density for Case~1 is noticeably higher than in the actual equine bones~\citep{yamada2015experimental} and the minimum density is unrealistically close to zero. 
There is clearly a need to somewhat constrain upper and lower bounds for density in order to produce more realistic outcomes.
To achieve this, the bell shape function presented in Eq.~(\ref{eq:bell_function}) is used for the next two analyses (Case~2 and Case~3). 
%Therefore, in the following section, the results of two analyses with the application of the bell function (see Eq.~\ref{eq:bell_function}) are presented. 
%In the first one, the parameters for the function are: $b = 1000$, $\rho_\mathrm{max} = 2.5$~$[{\text{g/cm}}^3]$, $\rho_\mathrm{min} = 0.3$~$[{\text{g/cm}}^3]$. 
%All the rest of parameters remain unchanged. 

\begin{figure}[h!]
\centering
	%	\includegraphics[width=10cm]{Figures/tikz/density_bell1.png}
			\begin{tikzpicture}
		\node at (0,0) {	\input{Figures/tikz/density_bell1.tex} };
		\node at(0.,1.5){ \includegraphics[width=4cm]{Figures/tikz/density_bell1_imag.png}};
		\node at(3,3){                    	\def\svgwidth{5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
		\end{tikzpicture}
		\caption{Case~2: Change in overall mass of the bone over time. Density distribution contours in 3rd metacarpal bone at the last converged step.}
		\label{fig:density_bell1}
\end{figure}

The results for Case~2 are plotted in Figure~\ref{fig:density_bell1}.
The last converged step takes place at $t=93$~$[{\text{d}}]$. 
By setting a high value of $b$, the transition between densities is very sharp and the algorithm encounters convergence difficulties, even with adaptive time-stepping, and biological equilibrium cannot be achieved in this case. 
However, by observing the range of densities obtained, it is evident that they slowly converge to the same solution as Case~1 (Figure~\ref{fig:mc3_density}). 
\begin{figure}[h!]
\centering
	%	\includegraphics[width=10cm]{Figures/tikz/density_bell2.png}
				\begin{tikzpicture}
	\node at (0,0) {	\input{Figures/tikz/density_bell2.tex} };
	\node at(0.,1.5){ \includegraphics[width=4cm]{Figures/tikz/density_bell2_imag.png}};
	\node at(3,3){                    	\def\svgwidth{5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
	\end{tikzpicture}
	
		\caption{Case~3: Change in overall mass of the bone over time. Density distribution contours at time $t=1600$~$[{\text{d}}]$.}
		\label{fig:density_bell2}
\end{figure}

For Case~3, a more moderate value for the exponent in the bell function was chosen along with a narrower density range than those chosen for Case~2 (see Table~\ref{fig:mc3_biol_eq}).
The plot presented in Figure~\ref{fig:density_bell2} demonstrates how these values influence the results of the analysis. 
It is evident that with a much lower value for exponent, $b$, the algorithm no longer has problems converging. 
Furthermore,  reducing the range between the upper and lower bounds of density has a significant impact on the results. 
The dense cortical shaft on the dorsal side of the bone is less dense and covers a much larger region. 
Furthermore, unrealistically low values of densities have been eliminated. 
However, as with the previous case, the overall solution converges to the same mass (and density distribution) as in Case~1, albeit requiring significantly more time steps. \\
%In the next sections, the methods will be presented on how to map the resulting density patterns from bone adaptation analysis on different meshes by using moving least squares approximation. Subsequently, the new model will be used to estimate the propensity to fracture, by calculating material forces on the introduced crack tip.
\subsection{MWLS mapping examples}
\label{sec:mals_mapping}
Here, validation of the implementation of the MWLS method (described in~\ref{sec:mwls}) is presented via two examples.
The first example involves the mapping of an analytical scalar field onto the nodes of a mesh of a prism.
For this case, the relative error between the analytical input scalar field and MWLS results are compared for three target orders of approximation of MWLS.
In the second example, mapping of CT scan data of a bone onto a mesh is presented.
For this challenging mesh geometry, results of the MWLS method are compared with the direct CT scan data as well as results of least squares method.
    
\subsubsection{Mapping of an analytical field}
The analytical field ($f({\boldsymbol {\rm x}})=x + y^2 + z^3 $) %(simulating CT scan data). 
is mapped onto the mesh nodes of the prism (Figure~{\ref{fig:mwlsprism}a}) using the proposed MWLS procedure described in~\ref{sec:mwls}.
The analytical field $f({\boldsymbol {\rm x}})$ is evaluated at a discrete set of points, $v({\boldsymbol{\rm x}}_i)$, presented in Figure~\ref{fig:mwlsprism}b.
The FE mesh is placed within the discrete field (Figure~\ref{fig:mwlsprism}b) and the spherical domains of influence of each mesh node are presented (reduced in size for clearer visual presentation) in Figure~\ref{fig:mwlsprism}c. 
The size of the influence domain is determined by increasing its radius until matrix $\mathbf A$ in Eq.~(\ref{eq:mwls_system}) is invertible for all mesh nodes. 
The approximated field data, with its gradient, is saved on corresponding nodes as demonstrated in Figure~\ref{fig:mwlsprism}c for $q=10$. 
Subsequently, the relative approximation error between the norm of analytical gradient of the given field $f({\boldsymbol {\rm x}})$ at the coordinates of each mesh node and the norm of gradient calculated with MWLS at the same node is evaluated and presented in Figure~\ref{fig:prism_error}.
The error is evaluated for three cases: constant ($q=1$), linear ($q=4$) and quadratic ($q=10$) basis functions. 
It is clear from presented results in Figure~\ref{fig:prism_error} that constant functions are not sufficient for evaluating the gradient. 
The maximum error for a linear and quadratic basis has values of $10^{-2}$ and $10^{-4}$, respectively. 
These results are satisfactory for the application of mapping data fields onto the mesh and suggest correctness of the implementation.
\begin{figure}[h!]
	\centering
%	\includegraphics[width=16cm]{Figures/mwls_prism.png}
	\begin{tikzpicture}
		\node at (0,0) {		\includegraphics[width=14cm]{Figures/mwls_prism.png} };
		\node at(-1,-2){a) \hspace{3cm} b)  \hspace{4.5cm}   c)  \hspace{3cm}  d)     };
	\end{tikzpicture}
	\caption{a) Finite element tetrahedral mesh. b) Mesh inside analytical discrete field $f({\boldsymbol {\rm x}}) = x + y^2 + z^3$. c) Mesh with corresponding nodes and spherical domain of influence. d) Outcomes of the approximation for $q=10$.}
	\label{fig:mwlsprism}
\end{figure}
\begin{figure}[h!]
	\centering
	%\includegraphics[width=10cm]{Figures/prism_error.png}
		\def\svgwidth{14cm}
	\input{Figures/prism_error.pdf_tex}
	\caption{Contour plot of relative error of approximated gradient field for constant a), linear b) and quadratic c) basis functions. The logarithmic scale represents the magnitude of relative error.}
	\label{fig:prism_error}
\end{figure}
\subsubsection{Metacarpal bone}
In this section, the results of density approximation from CT data are presented. Geometry and finite element mesh of an equine 3rd metacarpal bone was obtained in ScanIP (Synopsys Simpleware, Exeter) from medical 3D images. The CT data was subsequently used to approximate the density values onto the finite element mesh nodes by using the proposed MWLS method. 
The mesh consisted of approximately 7000 tetrahedral elements.
\begin{figure}
	\centering
%	\includegraphics[width=1\linewidth]{Figures/mwlsmapping_cross.png}
	\def\svgwidth{10cm}
	\input{Figures/mwlsmapping_cross.pdf_tex}
	\caption{Comparison of a CT data with the corresponding approximation. a) A cut-view along the $x-y$ plane for CT scan data and b) density mapped onto FE mesh.}
	\label{fig:mwlsmapping_cross}
\end{figure}
Results of the mapping procedures are presented in Figure~\ref{fig:mwlsmapping_cross}. Comparison between the proposed MWLS method and the standard Least Squares (LS) is shown in Figure~\ref{fig:mwlsmappingcomparisons} for both the density field and the density gradient field.
\begin{figure}[h!]
	\centering
%	\includegraphics[width=0.7\linewidth]{Figures/mwls_mapping_comparisons.png}
		\def\svgwidth{12cm}
		\input{Figures/mwls_mapping_comparisons.pdf_tex}
	\caption{Mapping results of bone density (left) and density gradient (right). a) Least squares approximation. b)~Moving Weighted Least Squares approximation.}
	\label{fig:mwlsmappingcomparisons}
\end{figure}
The density pattern from both methods is very similar. The MWLS method ensures that the density field is continuous despite the fact that the mesh is relatively coarse. 
This is particularly beneficial when using hierarchical basis functions, where larger elements with high order approximation can be more desirable. 
Classical finite elements provides only ${C^0}$-continuity resulting in piecewise continuous gradients with LS . 
Density gradients resulting the MWLS approximation are smooth, as required for the fracture propagation analysis.
It can also be seen that mesh boundary does not suffer from Partial Volume Artifacts~\citep{adams2009quantitative}.
%try more meshes maybe?

\subsection{Stress intensity calculations}
\label{sec:release_energy_rate}
In this section five numerical examples are presented to examine the calculation of configurational forces.
First, a simple quasi-two-dimensional plate with homogeneous material distribution is considered.  The convergence study is utilises an analytical solution as a reference.
Second, the singularity elements are used for the same plate problem and their influence on the rate of convergence is presented. 
Third, the same problem is considered again but with a heterogeneous material. 
The final two examples demonstrate the calculation of configurational forces for a more representative bone.
 
\subsubsection{Finite plate with a horizontal crack}\label{sec:plate_section}
This example involves a finite plate with height, $h_{\rm {pl}} = 10$, thickness $t_{\rm {pl}}=1$ and half width $b_{\rm{pl}} = 2.5$ and a horizontal through-thickness crack with half width $a_{\rm {pl}} = 1$, as presented in Figure~\ref{fig:plate_load_mesh}(a). All input parameters presented are dimensionless. 
The  plate is spatially discretised using 1384 tetrahedral elements and subjected to uniaxial stress in the longitudinal direction, as indicated in Figure~\ref{fig:plate_load_mesh}(b). 
Displacements are constrained on three vertices of the plate to prevent rigid body motion. 
%\includegraphics[width=0.5\linewidth]{Figures/plate_load_mesh.png}

\begin{figure}[h!]
\begin{center}
\begin{tabular}{c}
{\def\svgwidth{17cm} \input{Figures/InfSlab.pdf_tex}}\\
\end{tabular}
\caption{Finite plate with a horizontal crack. a) Plate geometry and through thickness crack. b) Applied uniaxial stress $\sigma$ and finite element mesh where elements presented with grey colour have approximation order $p_{\rm g}$ and elements that have vertices at crack tip, presented with yellow colour, have approximation order $p_{\rm l}+p_{\rm g}$. }
\label{fig:plate_load_mesh}
\end{center}
\end{figure}

The purpose of this analysis is to calculate the Mode I stress intensity factor $ K_{\rm I} $ and compare the results to the following analytical solution~\citep{rooke1976compendium} for an infinite plate:
\begin{equation}\label{eq:frac_analytical}
K_{\rm I}=\sigma \sqrt{\pi a_{\rm {pl}}} \left[  \frac{1 - \frac{a_{\rm {pl}}}{2b_{\rm {pl}}} + 0.326 (\frac{a_{\rm {pl}}}{b_{\rm {pl}}})^2 }{\sqrt{1-\frac{a_{\rm {pl}}}{b_{\rm {pl}}}}}  \right]
\end{equation}
where $\sigma $ is the applied stress. 
%Dimensions of the specimen are presented in Figure~\ref{fig:plate_load_mesh} along with the finite element model consisting of 1384 tetrahedral elements. 
Young's modulus $E$ and Poisson's ratio $\nu$ are $1000$ and $0.3$, respectively. 


Hierarchical approximation basis functions allows for usage of elements with different orders of approximation. 
Hence, the influence of local and global $p$~-~refinement is investigated.
In general, all tetrahedrons of the mesh have a global order of approximation, $p_{\rm g}$, with some elements subjected to local refinement of order $p_{\rm{l}}$.
 %$p_{\rm{l}} + 1$~to~$p_{\rm{l}} + p_{\rm{g}}$.
%When $p_{\rm l}+p_{\rm g}\leq3$, two types of tetrahedral elements are considered where local order of approximation is increased to $p_{\rm l}+p_{\rm g}$ only at elements with vertices at the crack tip as presented in Figure~\ref{fig:plate_load_mesh}b.
%Otherwise, a number of groups of tetrahedrals with different orders of approximation are considered.
%Similar to the case where $p_{\rm l} + p_{\rm g} \leq 3$, the first group of elements is composed of the tetrahedrals with vertices at the crack tip and have approximation order $p_{\rm l}+p_{\rm g}$.
%The second group of elements is consisted of the tetrahedrons adjacent to the first set elements, with approximation order that is one less than the previous set, i.e. $p_{\rm l}+p_{\rm g}-1$.
%This process continues for each next adjacent group of tetrahedrons until the approximation order reaches the global order of approximation, $p_{\rm {g}}$.
All analyses presented were run using the same mesh with p-refinement varying from 1\textsuperscript{st}-order  to 6\textsuperscript{th}-order so that $p_{\rm l} + p_{\rm g} \leq 7$.
The Mode I stress intensity factor, $K_{\rm I}$, can be calculated directly from the output configurational forces using the following relationship: 
\begin{equation}
K_{\rm I} = \sqrt{GE}
\end{equation}
where $G$ is the change of elastic strain energy per unit area of crack growth.
The deformed shape of the plate is illustrated in Figure~\ref{fig:plate_conv_no_sing}.
From the graph, it is evident that, for the same coarse mesh and number of nodes, the solution can improve drastically when the order of approximation is increased. 
The well known pathological nature of the 1st order solution due to shear locking is observed since a much higher error than other orders is computed. 
The minimum achieved error is $0.50\%$ for all the cases with total order of approximation  $p_{\rm l} + p_{\rm g} = 7$. 
Therefore, it can be observed that the same level of accuracy can be accomplished when using a low order of global approximation with only local $p$~-~refinement as with high order on the entire mesh. 
Moreover, by looking at the number of degrees of freedom, it can be observed that using higher order elements locally results to the same accuracy at a much lower cost of computation time, since the global matrix is much smaller.
\begin{figure}
	\centering
	\begin{tikzpicture}
	\node at (0,0)   {		\input{Figures/tikz/plate_conv_no_sing.tex} };
	\node at (-3.4,-0.9)   {		\def\svgwidth{3.6cm}	 	\input{Figures/tikz/plate_conv_no_sing_fig.pdf_tex} };
			\node at (1.,-2.75){$0.50\%$};
	\end{tikzpicture}
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$ Error (\%) versus no. of DOF (log10) and deformed shape of the plate (bottom left).}
	\label{fig:plate_conv_no_sing}
\end{figure}


\subsubsection{Influence of singularity elements}
\label{sec:quarter_point_results}
The same problem as in Section~\ref{sec:plate_section} is investigated. This time, however, singularity tetrahedral elements were applied around the crack front.
\begin{figure}[h!]
	\centering
%	\includegraphics[width=0.7\linewidth]{Figures/tikz/plate_conv_singularity.png}
		\begin{tikzpicture}
			\node at (0,0){	\input{Figures/tikz/plate_conv_singularity.tex} };
			\node at (-4.4,-2.5){$0.028\%$};
	\end{tikzpicture}
	
	
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$ Error (\%) versus no. of DOF (log10).}
	\label{fig:plate_conv_singularity}
\end{figure}
Based on the results in Figure~\ref{fig:plate_conv_singularity}, it is evident that using singularity elements improves the convergence rate significantly and lowered the error by an order of magnitude, from 0.50\% down to 0.028\%. 
However, it can be seen from the plot in Figure~\ref{fig:plate_conv_singularity} that for each $p_{\rm l} + p_{\rm g}$ combination, just after reaching the minimum error, it starts increasing again. 
This suggests that the solution cannot be further improved beyond that point only by enhancing the order of approximation. 
Possibly, by refining the mesh and changing the model length (to better replicate the infinite plate used to determine the analytical solution), the error could be decreased even more. 
Nevertheless, this is considered extremely accurate for the purpose at hand. \\
%The critical thickness is that which causes the specimen to be dominated by a state of plane strain, as opposed to plane stress. The stress in the through-thickness z direction must become zero at the sides of the specimen since no traction is applied there, and in a thin specimen the stress will not have room to rise to appreciable values within the material. The strain in the z direction is not zero, of course, and the specimen will experience a Poisson contraction given by Îµz = Î½(Ïƒx + Ïƒy). But when the specimen is thicker, material near the center will be unable to contract laterally due to the constraint of adjacent material. Now the z-direction strain is zero, so a tensile stress will arise as the material tries to contract but is prevented from doing so. 
Overall, these results indicate that it is of great benefit to use the singularity elements, since they improve the accuracy of the solution with no extra cost.
Furthermore, the difference in execution time for the analysis with and without their inclusion was negligible. 

\subsubsection{Heterogeneous material}
So far the numerical examples have assumed homogenous material properties. Here we consider the effect of a heterogeneous material. 
Considering the same problem of the finite plate with horizontal crack, a density field $\mathbf{\rho}(x,y,z) = 0.125y + 1$ is directly assigned to the integration (Gauss) points of each tetrahedral element.
As expected, configurational forces are induced at the crack tip under load and, as explained in Section \ref{sec:release_energy}, these influeced but the non-uniform density distribution. 
However, the stress intensity factor loses its meaning in the case of heterogeneous materials and there is no agreed approach to validate either configurational forces or stress intensity factors for such cases (except for the special case of functionally graded materials~\citep{kim2002finite}).
%, by using MWLS method, demonstrated in Section~\ref{sec:mwls}.

A straightforward verification can be performed by using simple numerical differentiation method like centered Finite Difference Method (FDM). Following Griffith's work~\citep{Griffith163}, the energy release rate for crack growth can be calculated as the change in elastic strain energy per unit area of crack growth:
\begin{equation}
G = \frac{\partial \psi}{\partial a_{\rm {pl}}}
\end{equation}
where $\psi$ is the elastic energy of the system, and $a_{\rm{pl}}$ is the crack length. This derivative can be calculated using FDM as:
\begin{equation}
 \frac{\partial \psi}{\partial a_{\rm {pl}}} = \lim_{\Delta a_{\rm {pl}} \to 0} \frac{\psi(a_{\rm {pl}} + \Delta a_{\rm {pl}}) - \psi(a_{\rm {pl}} -\Delta a_{\rm {pl}})}{2\Delta a_{\rm {pl}}}
\end{equation}
where the elastic strain energies $\psi(a_{\rm {pl}} \pm \Delta a_{\rm {pl}})$ can be obtained simply by running two additional analyses of the finite plate with horizontal cracks of lengths: ($a + \Delta a_{\rm {pl}}$) and ($a - \Delta a_{\rm {pl}}$), where $\Delta a_{\rm {pl}}$ is a very small value. 
Next, knowing the resulting release energy with the crack length of $a_{\rm {pl}}$, a relative error can be calculated. 
Twenty-four analyses for different levels of $p$~-~refinements and values of $\Delta a_{\rm {pl}}$ ) have been performed in order to determine the error in the release energy. 
The results are presented in Figure~\ref{fig:covergencefdm}.
\begin{figure}[h]
	\centering
%	\includegraphics[width=0.7\linewidth]{Figures/tikz/covergence_FDM.png}
	\begin{tikzpicture}
		\node at (0,0){\input{Figures/tikz/covergence_FDM.tex}};
		\node at (5,-0.0) {	\includegraphics[width=2cm]{Figures/tikz/gradient.png}};
		\node at (-4.5,-2.8){$0.3\%$};
		\end{tikzpicture}
	\caption{Convergence of error in release energy rate from Finite Difference Method. Density distribution (bottom right).}
	\label{fig:covergencefdm}
\end{figure}
It is apparent from the plot that with increasing levels of refinement the error in release energy is converging down to 0.3\%. It is worth noting that for homogeneous case similar accuracy was attained.  Achieving higher precision with FDM validation is difficult due to the accumulation of truncation, approximation and discretisation errors.
Therefore, it can be deduced that the presented implementation allows for estimation of release energy for heterogeneous domains with a satisfactory level of accuracy.

\subsubsection{Fracture energy release rate for metacarpal bone} \label{sec:mc3_release_eng}
This numerical example considers the same bone as presented in Section~\ref{sec:numerical_examples:bone_adap}. 
An initial crack was generated in the mesh using a cutting plane, as shown in Figure~\ref{fig:bone_ct_mesh_cut}. A notch is situated at the origin of the most common location of lateral condyle fracture~\citep{jacklin2012frequency}. 
The numerical analyses were undertaken using three meshes consisted of 6069, 10032 and 21189 tetrahedrons and repeated for 1\textsuperscript{st}, 2\textsuperscript{nd} and 3\textsuperscript{rd}-order of global and local $p$~-~refinement at the crack tip. 
Boundary conditions and material parameters remain the same as in Table~\ref{tab:parameters_mc3}. 
Using a $\mathrm {K_2 HPO_4}$ calibration phantom, grey scale values from CT are converted to bone mineral density using five tubes with reference densities. 
The mechanical material properties were mapped onto the integration points of the metacarpal mesh using the MWLS method described in \ref{sec:mwls}. 
Applying load induces configurational forces at the crack front, as shown in Figure~\ref{fig:crackfrontforce}. 
The direction of the vectors also indicates the direction of future crack propagation.
%When these forces, attain the critical value, crack growth is spontaneous and catastrophic.  
The values of numerically predicted maximal nodal energy release rates in Mode I (crack opening) for subsequent meshes are plotted in Figure~\ref{fig:max_g1_convergece}. 
It can be seen that, for the same mesh, as the order of approximation increases, the energy release rate converges. 
%with increasing order of approximation material forces converge.
\begin{figure}[h]
	\centering
		\def\svgwidth{10cm}
		\input{Figures/bone_ct_mesh_cut.pdf_tex}
%	\includegraphics[width=0.5\linewidth]{Figures/bone_ct_mesh_cut.png}
	\caption{Bone geometry with mapped density from CT by using MWLS. In order to calculate the configurational forces, an initial crack is introduced by cutting the mesh with a circular surface. The cutting algorithm is not limited to planar cracks. }
	\label{fig:bone_ct_mesh_cut}
\end{figure}

\begin{figure}[h!]
	\centering
	\def\svgwidth{12cm}
	\input{Figures/crack_front_force.pdf_tex}
	%\includegraphics[width=0.9\linewidth]{Figures/crack_front_force.png}
	\caption{Crack surface and vectors of material (crack driving) forces at the front.}
	\label{fig:crackfrontforce}
\end{figure}

\begin{figure}[h!]
	\centering
	\input{Figures/tikz/max_g1_convergece.tex}
	\caption{Convergence plot of maximum configurational force in Mode-I versus no of DOF (log10) for subsequent discretisations and $p$~-~refinements. Results are mesh independent since they all converge to the value for energy release of approximately $ G_{\rm I} = 0.9 \, [\mathrm{kJ} / \mathrm{m}^2]$ for increasing orders of approximation. }
	\label{fig:max_g1_convergece}
\end{figure}
Crack will propagate when the energy release rate $G$ equals the material's resistance to crack extension, $g_{\rm c}$. Assuming $g_{\rm c} = 2.0\,[\mathrm{ kJ/m^2}]$~\citep{gasser2007numerical} it can be estimated that this particular metacarpal bone with this initial crack can sustain loading of approximately 2.2 times greater before a fracture starts to propagate. 

\subsubsection{Energy release rate for adapted bone}
The likelihood of fracture in an equine metacarpal bone at different phases of adaptation during training is investigated here.
The same geometry and boundary conditions as in the previous example are used. 
However, this time, densities from a bone adaptation analysis (Section~\ref{sec:numerical_examples:bone_adap}) are mapped onto the mesh consisting of 6069 elements as shown in Figure~\ref{fig:frackmeshcutting}. 
\begin{figure}[h]
	\centering
	%\includegraphics[width=0.8\linewidth]{Figures/frack_mesh_cutting.png}
			\def\svgwidth{12cm}
		\input{Figures/frack_mesh_cutting.pdf_tex}
	\caption{The resulting density distribution from the bone adaptation analysis is approximated directly onto integration points of the mesh used for fracture analysis using MWLS method described in~\ref{sec:mwls}. The cutting circular plane used to create an initial crack is also shown.}
	\label{fig:frackmeshcutting}
\end{figure}
The resulting energy release rate at different points in time of bone adaptation are illustrated in Figure~\ref{fig:crackmc3release} for three different local $p$~-~refinements. It can be seen that the variation in energy release rate for increased orders of approximation at the crack front is very small. 
\begin{figure}[h!]
	\centering
%	\includegraphics[width=1\linewidth]{Figures/tikz/crack_mc3_release.png}
		\begin{tikzpicture}
			\node at(0,0){	\input{Figures/tikz/crack_mc3_release.tex} s};
			\node at(0,0){ \includegraphics[width=9cm]{Figures/tikz/density_for_g1_conv.png}};
			\node at(2,-1){                    	\def\svgwidth{4cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
		
		\end{tikzpicture}
	\caption{Configurational forces for remodelled bones for three local $p$~-~refinements.}
	\label{fig:crackmc3release}
\end{figure}
The numerical outcomes clearly capture the general trend of increasing release energy rate over time. It can be seen that by introducing a notch in the resorption zone, where no loading is applied, the configurational force attains larger values. This indicates that over time the bone becomes more prone to fracture in this specific region. 

\subsection{Crack propagation in bone}
In the this section we move the analysis further by simulating full crack propagation for predicted density distributions. The magnitude of applied forces (Figure \ref{fig:mc3_BC}) is controlled by the crack area increment during each load step. The initial finite element mesh is the same as previously, as it is being locally refined with the crack front advancement. The assumed bone's Griffith energy is equal to $2.0\,[\mathrm{ kJ/m^2}]$ for the entire domain. The crack front nodes are moved only when the magnitude of crack driving forces is in equilibrium with the material resistance (Eq. \ref{eq:crack_configuration_force}). 
All five cases (time snapshots) are solved for 2nd-order of approximation.
The numerically predicted crack paths are shown in Figure~\ref{fig:crack_snapshots}. 
It can be seen that the crack has initially planar shape and curves the trajectory towards the lateral side of the bone. The simulated crack path compares well with fractures observed in radiographs \citep{whitton2010third}, especially considering oversimplified loading conditions. Load factor versus crack area plots are shown in Figure~\ref{fig:crack_remodel_frac_compar}. Consistent with the previous analysis in Section~\ref{sec:mc3_release_eng}, the metacarpal bone shows an increased propensity for fracture - for the same crack area, remodelled bone requires much lower force (load factor) to induce crack propagation. Low density levels at the biological equilibrium ($t=90$ and $t=200$) also alternates the crack path, as can be observed the crack starts to curve much earlier than in the initial stages of remodelling. 

\begin{figure}[h!]
	\centering
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fracture/remodel_frac_compar.tex} };
	\node at (0.25,1.8) {	\includegraphics[width=7cm]{Figures/pngs/crack_surfaces_adapt.png}};
	\node at (1.5,0) {	Crack surfaces};
	\end{tikzpicture}
	\caption{Load factor versus crack area for different snapshots from bone remodelling analysis. It can be noticed that the heterogeneity of the bone inclueced both load factor and the resulting crack surface.}
	\label{fig:crack_remodel_frac_compar}
\end{figure}



\begin{figure}[h!]
	\begin{centering}
			\begin{tikzpicture}
				\node at (0,0) {			\includegraphics[width=12cm]{Figures/pngs/crack_spatial_conf.png} };
				\node at(1,-2.5){a) \hspace{2.5cm} b)  \hspace{2.5cm}  c)  \hspace{2.5cm}  d)  \hspace{2.5cm}  };
		\end{tikzpicture}
		
	\end{centering}		
		\caption{Snapshots for points shown in Figure~\ref{fig:crack_remodel_frac_compar} of crack propagation in equine 3rd metacarpal. }
		\label{fig:crack_snapshots}
\end{figure}


As previously demonstrated (in Figure~\ref{fig:plate_conv_singularity}) modelling singularity can significantly improve the accuracy of the configurational forces at the crack front. In the next example we considered bone with heterogeneous density distribution mapped from CT scan data. In the Figure~\ref{fig:crack_singular_vs_non} results from crack analysis with and without Quarter Point elements are depicted. It is evident that accurate stress state at the tip has a negligible impact on the full crack propagation analysis and the resulting load factor. 

\begin{figure}
	\centering
	\begin{tikzpicture}
		\node at(0.,0){  	\input{Figures/tikz/fracture/remod_heter_singular.tex} };
	\end{tikzpicture}
	\caption{Load factor versus crack area for with and without modelled singularity at the tip.}
	\label{fig:crack_singular_vs_non}
\end{figure}


Finally, we investigated the h and p convergence. The results presented on the Figures \ref{fig:crack_ct_h_ref} and \ref{fig:crack_ct_p_ref} show good numerical convergence for consecutive refinements. It can be concluded that our formulation predicts crack path accurately with minimal effect from original mesh or order of approximation. 

\begin{figure}
	\centering
	\begin{minipage}{.5\textwidth}
		\begin{tikzpicture}
			\node at(0.,0){ \input{Figures/tikz/fracture/real_fract_ct_h_ref.tex} };
		 \end{tikzpicture}
		 \caption{Load factor versus crack area ($h$~-~refinement).}
		 \label{fig:crack_ct_h_ref}
	\end{minipage}%
	\begin{minipage}{.5\textwidth}
		\begin{tikzpicture}
			\node at(0,0){         \input{Figures/tikz/fracture/real_fract_ct_p_ref.tex} };
		\end{tikzpicture}
		\caption{Load factor versus crack area ($p$~-~refinement).}
		\label{fig:crack_ct_p_ref}
	\end{minipage}
	\end{figure}


% ..................................................................................................................................................................

% OPTIONAL RESULTS - GRAPHICS, SHOULD WE INCLUDE THEM?

%In the process of moving the crack front nodes, the mesh quality can potentially deteriorate leading to numerical errors. One of the solutions to overcome this difficulty is to refine the mesh surrounding the crack tip after certain (usually three) number of load steps. 
\begin{figure}
	\centering
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fracture/homo_vs_het.tex} };
	\node at (2.5,1) {	\includegraphics[width=8cm]{Figures/pngs/crack_surf_heter_compar.png}};
	\end{tikzpicture}
	\caption{Load factor versus crack area for heterogeneous versus homogeneous bone.}
	\label{fig:crack_homo_vs_het}
\end{figure}


% \begin{figure}
% 	\centering
% 	\begin{tikzpicture}
% 	 \node at(0.,0){ \input{Figures/tikz/fracture/real_fract_ct_h_ref.tex} };
% 	\end{tikzpicture}
% 	\caption{Load factor versus crack area for consecutive global $h$~-~refinements.}
% 	\label{fig:crack_ct_h_ref}
% \end{figure}


% \begin{figure}
% 	\centering
% 	\begin{tikzpicture}
% 		\node at(0,0){         \input{Figures/tikz/fracture/real_fract_ct_p_ref.tex} };
% 	\end{tikzpicture}
% 	\caption{Load factor versus crack area for consecutive $p$~-~refinements.}
% 	\label{fig:crack_ct_p_ref}
% \end{figure}


..................................................................................................................................................................

% \begin{figure}[h!]
% 	\begin{centering}
% 			\begin{tikzpicture}
% 		\node at (0,0) {			\includegraphics[width=10cm]{Figures/crack_procedure.pdf} };
% 		\node at(0,1){a) \hspace{4.5cm} b)  \hspace{4.5cm} };
% 		\node at(0,-3){c) \hspace{4.5cm} d)  \hspace{4.5cm} };
% 		\end{tikzpicture}
		
% 	\end{centering}		
% 		\caption{a) Nodal configurational force. b) Crack front extension. c) Mesh refinement. d) MWLS density mapping onto new elements.}
% 		\label{fig:crack_procedure}
% \end{figure}


%A crack-surface controlled arc-length method was used to predict the crack pattern and limit load. 
%The mode I fracture enegy is approximated to be a constant value $\mathcal{G}_{I}=2 \mathrm{kN} / \mathrm{m}$
%SIMPLY: energy release per unit length of a crack advancement has to be equal energy consumption for the creation of the new surface in the circuital conditions and its equal to %material parameter - fracture energy. Griffith theory
%$-\frac{\partial \psi}{\partial a} = \frac{\partial S}{\partial a} = \mathcal\mathbf G_c$

\section{Discussion}\label{sec:discussion}
Development of a 3D Finite Element model for biological applications is a very complicated process. 
Unlike that in typical engineering research subjects, there is still very little knowledge of the material properties. 
Another issue is lack of proper definition of the boundary conditions. Constraints are mostly explicit when analysing engineering objects such as concrete beams or steel frames under different loading conditions. 
However, in a living body it is challenging to accurately define loads. 
Model geometry suffers from inaccuracies in scanning as well as segmentation process. 
Results from such models could potentially include an increasing number of errors since the data collected from each stage of the 
model creation encompasses high ancertenty data~\citep{campoli2014effects}.
Available information is usually subject-specific or gathered for a relatively small population of subjects and cannot be generalised. 
Subsequently, even if one manages to overcome the aforementioned obstacles, there is a need for validation of such models, which will also have to deal with similar difficulties. 
%A possible number of errors increase at each stage of creating such models since there is high uncertainty about obtained data~\citep{campoli2014effects}. 

Over the years, many frameworks have been developed to quantify such uncertainty levels, which might greatly increase the credibility of computational models~\citep{wille2016uncertainty}. 
CT scanning on living horses limbs is still too cumbersome to be used as a standard diagnostic tool.
As to best authors' knowledge there is a limited number of facilities that can perform CT scanning for horses without the necessity for anaesthesia. 
Nevertheless, this study can bring new insight in the area of catastrophic injuries in order to improve the welfare of the thoroughbred racehorse. %The successful application of developed framework would enable the introduction of interventions for veterinary practitioners, such as suggestions for training regimes based on known risk factors for lateral condylar fractures that could reduce the probability of fracture in racehorses. \\

In summary, the goals of this study were to: (i) implement bone adaptation algorithm to predict density levels in response to high-intensity training 
for racehorses, (ii) to incorporate an efficient and accurate mapping strategy to represent heterogeneous bone material properties for hierarchical 
finite element models and (iii) to assess the potential of linear fracture mechanics in evaluating bones' propensity to failure. 

Despite certain limitations, it was demonstrated that the implemented open systems thermodynamics framework allows for simulation of a natural behaviour of hard biological tissues. 
The proposed computational method may have a great potential to identify the risk of fracture related to changes in bone mineral density. 
Understanding the effects of changing release energy in response to bone adaptation can help developing training regimes that reduces the liability of fatal injury. 
Furthermore, the model uses very few parameters which can be experimentally determined in a practical manner increasing the attractiveness of this approach.\\ 

Application of a bell function to enforce bounds on density levels in the constitutive model did not provide rigid constrains for density levels, but merely slowed down the convergence to the biological equilibrium process. 
Nevertheless, it may still become useful, when one tries to fit the model parameters into the actual density data form CT scanning in defined periods of time. 
One could also constrain density bounds by introducing and calibrating mass influx to the balance of mass equation~\citep{sharma2013adaptive}. 
Nonetheless, bones in the living organisms are never fully load adapted~\citep{christen2014bone}. 
Therefore, achieving a biological equilibrium that results in unrealistic levels of density should never take place in a real case scenario. \\

This contribution also investigated the application of a meshless MWLS method in approximating the density data on FE models. Validation of analytical field mapped on a simple mesh and comparison with LS method on mapping data from CT scanning was conducted and proved that MWLS can be a suitable technique for the approximation of density field, even with strong gradients. 
Nevertheless, the accuracy of the presented approach still has to be validated experimentally, for example, in the prediction of strains in the loaded bone specimen.  \\

A novel method in quantifying bone fracture propensity was presented. By scanning the bone, running the bone adaptation simulation and subsequently introducing a notch in the geometry at particular time steps, it can be observed from the values of configurational forces how loading the bone influences its resistance to fracture. 
This framework, can be potentially a very useful tool in diagnostic of fractures and eventually prevention of catastrophic failures. 
Moreover, the code used for all numerical analyses was developed keeping in mind scalability and robustness. 
Entire framework can be executed on parallel computer system in order to fit in an efficient patient-specific modelling routine that can handle many patients within a practical time window. \\

Numerical examples demonstrated the accuracy of the proposed framework. 
Convergence has been validated for all examples, in particular, the use of quarter point elements was shown to improve the convergence of calculated release energy rates. However, it was also confirmed that improved accuracy of the stress at the tip has no impact on the crack propagation analysis.
\subsection{Limitations and future work}
The methods presented in this paper have several important limitations. 
Considerably more work has to be done to determine bone loading, since using simplified input results in unrealistically low densities in non load-bearing regions. 
Multiple load cases can be critical in modelling bone adaptation~\citep{geraldes2016consideration}. 
In the future, the forces will be obtained by using gait data and musculoskeletal analysis~\citep{Delp2007} combined with FEM mortar contact formulation in MoFEM~\citep{athanasiadis2018mortar}. 
Another method to predict realistic loading is to solve an~inverse problem to bone adaptation. 
Promising results have been reported in that field by using machine learning methods like Neural Networks~\citep{campoli2012computational}. 
The current linear fracture mechanics approach does not take into account nonlinear cohesive mechanisms like collagen fiber bridging at the crack tip~\citep{yang2006fracture}. 
Therefore, the calculated release energy with presented approach might be overestimated. 
More research is also required to calibrate material parameters, in particular those regarding constitutive relations for bone adaptation. 


%Overall, the presented examples of density evolution, at this point are not sufficient to make any practical conclusions about the remodelling of the metacarpal bones. \\


%Calculation of release energy rate does not give any insights into quantitative strength of the bones' structure. Future implantation on an implicit crack propagation for heterogeneous bodies will allow to trace a full dissipative loading path. The process of determining detailed musculoskeletal loads using kinematic data and external forces is called inverse dynamic analysis

%Another limitation of the study is that only one load case is considered. 
%However, it is important to note that while simulating bone functional adaptation a detailed knowledge of the actual loading situation is elementary. By assuming that all three cases occur simultaneously in some loading conditions forces could balance each other.

%The model is not yet calibrated and validated against patient data, however, it provides valuable insight to the bone remodelling behaviour for equine metacarpal and is capable of qualitatively comparing different loading.

%bone remodelling is not purely load-driven. Possible causes for this could be that also other mechanisms, for example, calcium homeostasis, influence normal bone remodelling and thus bone is never fully load adapted. as suggested in~\citep{christen2014bone}. The authors of previously mentioned publication also suggests that approximately 50\% of the bone structure might be determined by mechanical loading.


%No previous study has investigated release energy of brittle fracture in heterogeneous bodies like bones. 
%In the future we might use a micro CT scanning as ot was shown that it is currently the most accurate method to estimate bone strength. 
%We are hoping that when we refine the model we could confirm that bone remodelling may increase the propensity to cracks and find potential practical applications in the fracture prevention.
% this research can be easily translated into human applications 
%Presented framework could be also combined with other risk factors~\citep{georgopoulos2017risk} which should improve the clinical assessment of fracture risk
%The correlation between bone adaptation, high intense training and stress fractures is still poorly understood. The promising results of this study offer a novel framework to simulate  changes in the bone structure as a result of loading and quantify the risk of fatal injury. 
%In conclusion, this study has shown that fracture resistance in the equine metacarpal bone can be numerically quantified. 
%Understanding the effects of changing release energy in response to bone remodelling will help in the development of training regimes that reduces the risk of fatal injury in racehorses
%This approach might become especially handy to analyse whether a discovered crack in the equine bone is liable to propagate under certain loading conditions. 
%model with the capability to simulate the bone density growth and resorption processes due to mechanical stimuli
%A reduction in this speciï¬c type of fracture would have a signiï¬cant global impact on the number of Thoroughb redracehorses subjected to euthanasia as a result of in jury incurred duringracing
%has a massive welfare and economic impact on horse racing

%A better understanding of the influence of race training on subchondral bone remodelling is essential to understanding the pathophysiology of subchondral bone injury.

%Therefore, the development of computational tools with the capability to estimate bone adaptation when prosthetic devices are used has a remarkable importance, since these processes may contribute to implant success or failure. In this scenario, the finite-element method (FEM) has been playing a key role, being used to study and evaluate the mechanical behaviour of prosthetic devices

%The flexibility of the hierarchic finite element is fully utilised, which permits the use of arbitrary order of approximation leading to accurate results for relatively coarse meshes. The developed computational framework is implemented in our group's FE software, MoFEM (Mesh-Oriented Finite Element Method). \\

%Moreover, the application of the study proposes a computational assessment tool for veterinary specialists, focused on the simulation of a healthy femur and a femur with an implanted prosthesis submitted to loads.

%The main objective advocated in this contribution is the setting up of a modelling framework relying on the thermodynamics of irreversible processes

\newpage
% \bibliographystyle{abbrv}
\bibliography{bibfile.bib}

\newpage
\appendix{}
\section{Moving Weighted Least Squares (MWLS)}
\label{sec:mwls}


%The density field (see Eq.~(\ref{eq:density_material})) has to be
%approximated on the moving mesh in the current material configuration. However,
%
%IS THIS THE RIGHT PLACE?
%
%Assuming that the fracture process takes place much faster than the process of
%bone remodelling, these two processes can be calculated in a staggered manner. 
%The finite element mesh used for remodelling  is not the same as that used for the crack propagation problem.
%To avoid numerical difficulties a Moving Weighted Least Squares approximation 
%is used to approximate the densities in the fixed reference configuration, thereby ensuring a smooth density field that is necessary for the fracture modelling. Thus, the bone density and its spatial gradient are mapped onto the integration points of the mesh used for crack propagation.

The Moving Weighted Least Squares (MWLS) method is used to construct interpolation functions on a set of points to approximate a given spatially varying discrete field (in this case the scalar density field), $v({\boldsymbol{\rm X}}_{i})$, and is widely used for various meshless methods~\citep{belytschko1996meshless}. 
In computer graphics, it is useful to reconstruct a surface from a set of points~\citep{lancaster1981surfaces} through downsampling or upsampling. 
Numerous studies have also attempted to utilise the method within the context of Element-Free Galerkin approach as trial and test functions~\citep{belytschko1996dynamic,wong2010meshfree, ullah2013finite}.\\

In this work, the nodal configurational forces $\tilde{\mathbf{G}}^\textrm{h}$ 
(see Eq.~(\ref{eq:mat_int_front})) are dependent on the gradient of elastic energy over change of density, $\mathbf{B_X}^{\rm T} \rho$. 
Therefore, the approximation of a spatially smooth density field is important in order to evaluate the configurational forces at the crack front.   
To approximate a given discrete field, $v({\boldsymbol{\rm X}}_i)$, with MWLS method at a node of the mesh in the material configuration, each node is considered separately and denoted here as a Target Point of Approximation (TPA). 
The coordinates of each TPA are denoted with vector ${\boldsymbol{\rm X}}_{\rm t}$ and the approximated field at that location is evaluated as:
\begin{equation}
v^h({\boldsymbol{\rm X}}_{\rm t})=\sum^q_{\alpha=1}p_{\alpha}({\boldsymbol{\rm X}}_{\rm t} )a_{\alpha}({\boldsymbol{\rm X}}_{\rm t} ) =\mathbf p^{\rm T}({\boldsymbol{\rm X}}_{\rm t} )\mathbf a({\boldsymbol{\rm X}}_{\rm t} )
\label{eq:mwls_approx}
\end{equation}
where $v^h({\boldsymbol{\rm X}}_{\rm t})$ is the approximated value, $\mathbf p({\boldsymbol{\rm X}}_{\rm t})$ is the vector of complete basis functions and $\mathbf a({\boldsymbol{\rm X}}_{\rm t})$ is the vector of unknowns.
It should be noted that in MWLS method, $\mathbf a({\boldsymbol{\rm X}}_{\rm t})$ is spatially varying rather than being constant as used in conventional Least Squares method.
Moreover, $q$ is the number of approximation functions that are built from Pascal's tetrahedron via multiplicative combinations of unity with monomials equal to the spatial coordinates $X_{\rm t}$, $Y_{\rm t}$ and $Z_{\rm t}$ of the TPA.
For maximum target order of approximation functions, $k$, the total number of non-orthogonal approximation functions is determined by the binomial coefficient as:
\begin{equation}
q = \binom{k+3}{3} = \frac{(k+3)!}{6k!}
\end{equation}
 
In the current implementation, three types of basis functions are used:
\begin{equation}
\begin{centering}
\begin{aligned} 
\mathbf p^{\rm T}({\boldsymbol {\rm X}}_{\rm t})  = \mathbf p^{\rm T}(X_{\rm t},Y_{\rm t},Z_{\rm t})= [1], \quad q=1 \,\,\,{\rm {and}}\,\,\, k = 0,\\
\mathbf p^{\rm T}({\boldsymbol {\rm X}}_{\rm t}) = \mathbf p^{\rm T}(X_{\rm t},Y_{\rm t},Z_{\rm t})= [1,X_{\rm t},Y_{\rm t},Z_{\rm t}], \quad q=4 \,\,\,{\rm {and}}\,\,\, k = 1,\\
\mathbf p^{\rm T}({{\boldsymbol {\rm X}}}_{\rm t}) = \mathbf p^{\rm T}(X_{\rm t},Y_{\rm t},Z_{\rm t})= [1,X_{\rm t},Y_{\rm t},Z_{\rm t},X_{\rm t}Y_{\rm t},Y_{\rm t}Z_{\rm t},Z_{\rm t}X_{\rm t},X^2_{\rm t},Y^2_{\rm t},Z^2_{\rm t}],\quad q=10 \,\,\,{\rm {and}}\,\,\, k = 2
\end{aligned}
\end{centering}
\label{eq:mwls_basis}
\end{equation}
For each TPA, the process to evaluate the vector of unknowns $\mathbf a({\boldsymbol{\rm X}}_{\rm t}) = \Big[ a_1({\boldsymbol{\rm X}}_{\rm t} ), a_2({\boldsymbol{\rm X}}_{\rm t} ), \dots a_q({\boldsymbol{\rm X}}_{\rm t} ) \Big]$ in Eq.~(\ref{eq:mwls_approx}) involves consideration of neighbouring points of the discrete field $v({\boldsymbol{\rm X}}_i)$ and a weight function $w(r)$ is constructed, where $r$ is the normalised radial distance from the TPA defined as $r = ||{\boldsymbol{\rm X}}_{\rm t}-{\boldsymbol{\rm X}}||/d_{\rm {mi}}$ so that $0<r\le1$, where $d_{\rm {mi}}$ is a scaling parameter.

An example of an arbitrary weight function for a 2D domain is presented in Figure~\ref{fig:weight_func}.
Values of the given discrete field $v({\boldsymbol{\rm X}}_i)$ are presented with dots and the positions where $v({\boldsymbol{\rm X}}_i)$ is mapped (i.e. TPAs) are presented with circles. 
Furthermore, the TPA under consideration is located at the origin of a cylindrical local coordinate system with $r$ and $w$ axes. 
For the 2D case, the weight function is visually represented as a 3D surface (shaded area) resulting from full rotation around $w$ axis of the 1D weight function, $w(r)$, represented as a solid line.
The boundary of the domain of influence of $w(r)$ is represented by a dashed circle ($r=1$). $w(r)$ is equal to zero outside the domain of influence.
\begin{figure}[h!]
	\begin{centering}
	{\def\svgwidth{10cm} \input{Figures/weighs.pdf_tex}}
		\caption{2D schematic example of arbitrary weight function of a TPA located with position vector ${\boldsymbol{\rm X}}_{\rm t}$. 
		Points of the discrete field $v({\boldsymbol{\rm X}}_i)$ are presented with dots and points that $v({\boldsymbol{\rm X}}_i)$ is mapped (TPAs) are presented with circles.
		The function is smooth, non-negative, reaches maximum at the TPA and decreases with distance $||{\boldsymbol{\rm X}}_{\rm t} - {\boldsymbol{\rm X}}_i||$. 
		The boundary of the domain of influence of the weight function is presented with dashed ellipsoid (circle on 2D plane) and the function takes a constant value of zero outside of it.}
		\label{fig:weight_func}
	\end{centering}
\end{figure}

Many types of weight functions can be used for MWLS method. A one-dimensional quartic spline, commonly used in meshless methods~\citep{belytschko1996meshless}, was chosen for the current work:
\begin{equation}
w(||{\boldsymbol{\rm X}}_{\rm t}-{\boldsymbol{\rm X}}_i||/d_{\rm {mi}})=w(r_i)=\begin{cases} 1-6r_i^2+8r_i^3-3r_i^4 & \mathrm{for} \, r_i \leq 1\\ 0 & \mathrm{for} \, r_i > 0 \end{cases}
\end{equation}
Its derivative (required later) with respect to the material coordinates is:
\begin{equation}
\frac{{\rm d}w}{{\rm d}{\boldsymbol{\rm X}}_{\rm t}}= \frac{{\rm d}w}{{\rm d}r_i}\frac{{\rm d}r_i}{{\rm d}{\boldsymbol{\rm X}}_{\rm t}} =\frac{1}{d_{\rm {mi}}}\begin{cases} (-12r_i +24r_i^2 -12 r_i^3) \,  & \mathrm{for} \, r_i \leq 1, \\ 0 & \mathrm{for} \, r_i > 0  \end{cases}
\end{equation}
Here $r_i = ||{\boldsymbol{\rm X}}_{\rm t}-{\boldsymbol{\rm X}}_i||/d_{\rm {mi}}$ is the normalised radial distance of point $i$ from the TPA divided by scaling parameter $d_{\rm {mi}}$. 
This coefficient is governing the size of influence domain. 

%The vector of unknowns $\mathbf a({\boldsymbol{\rm X}}_{\rm t}) = \Big[ a_1({\boldsymbol{\rm X}}_{\rm t} ), a_2({\boldsymbol{\rm X}}_{\rm t} ), \dots a_q({\boldsymbol{\rm X}}_{\rm t} ) \Big]$ in Eq.~(\ref{eq:mwls_approx}) can be obtained from a minimization of 
With the above tools at hand, the vector of unknowns $\mathbf a({\boldsymbol{\rm X}}_{\rm t})$ associated to the TPA can be evaluated through minimisation of the weighted discrete $L_2$ norm:
\begin{equation}
J({{\boldsymbol{\rm X}}}_{\rm t})=
\frac{1}{2} \sum_i^{n_{\rm w}} w(r_i) \left( v^h({\boldsymbol{\rm X}}_{\rm t}) - v({\boldsymbol{\rm X}}_i) \right)^2
=
\frac{1}{2} \sum_i^{n_{\rm w}} w(r_i) \left( \mathbf p^{\rm T} ({\boldsymbol{\rm X}}_i)\mathbf a({\boldsymbol{\rm X}}_{\rm t}) - v({\boldsymbol{\rm X}}_i) \right)^2
\label{eq:mwls_l2}
\end{equation}
where $v({\boldsymbol{\rm X}}_i)$ is the value of the given discrete field at point $i$ amongst the $n_{\rm w}$ points located within domain of influence of the TPA and $\mathbf p^{\rm T} ({\boldsymbol{\rm X}}_i)$ is the vector of shape functions of point $i$. 
 
Minimisation of $J$ with respect to $\mathbf a$ leads to a system of linear equations as:
\begin{equation}
\mathbf{ { A }} ({\boldsymbol{\rm X}}_{\rm t}) \mathbf{ { a}} ({\boldsymbol{\rm X}}_{\rm t}) = \mathbf{ { B }}({\boldsymbol{\rm X}}_{\rm t}) \mathbf{ { v}}
\label{eq:mwls_system}
\end{equation} 
where matrices $\mathbf{ { A }}({\boldsymbol{\rm X}}_{\rm {t}})$ and \textbf{$\mathbf{ { B}}({\boldsymbol{\rm X}}_{\rm t})$} are of size $(q \times q )$ and $(q \times n_{\rm w} )$ and defined as follows:
\begin{equation} 
\begin{aligned}
& \mathbf{ { A }}({\boldsymbol{\rm X}}_{\rm t}) = \sum_i^{n_{\rm w}} w (r_i)\mathbf{p} ( {\boldsymbol{\rm X}}_i)\mathbf p^{\rm T} ({\boldsymbol{\rm X}}_i) \\
& \mathbf{ B }({\boldsymbol{\rm X}}_{\rm t}) = \Big[ w(r_1) \mathbf p ({\boldsymbol{\rm X}}_1), w(r_2) \mathbf p ({\boldsymbol{\rm X}}_2), \dots ,  w(r_{n_{\rm w}}) \mathbf p ({\boldsymbol{\rm X}}_{n_{\rm w}})  \Big]
\end{aligned}
\end{equation}
and $\mathbf v$ is $(n_{\rm w} \times 1)$ vector of the given field values at the points within the influence domain given as: 
\begin{equation}
\mathbf v = \big[ v({\boldsymbol{\rm X}}_{\rm 1}), v({\boldsymbol{\rm X}}_{\rm 2}), \dots, v({\boldsymbol{\rm X}}_{n_{\rm w}}) \big]^{\rm T}
\end{equation}
It should be noted that parameter $d_{\rm{mi}}$ is chosen to include sufficient $n_{\rm w}$~points such that the resulting matrix $\boldsymbol{\rm A}$ is not singular. 
Next, Eq.~(\ref{eq:mwls_approx}) combined with Eq.~(\ref{eq:mwls_system}) can be rewritten as: 
\begin{equation}
v^h({\boldsymbol{\rm X}}_{\rm t} )= \sum^{n_{\rm w}}_{i=1} \omega_i({\boldsymbol{\rm X}}_i) v_i = \mathbf {\bm {\upomega}}^{\rm T} ({\boldsymbol{\rm X}}_{\rm t}) \mathbf v 
\end{equation}
where $ {\boldsymbol{\rm {\upomega}}} ({\boldsymbol{\rm X}}_{\rm t})$ is a resulting vector of shape functions associated with the TPA, defined as
\begin{equation}
{\boldsymbol\upomega}^{\rm T} ({\boldsymbol{\rm X}}_{\rm t}) = \mathbf p^{\rm T} ({\boldsymbol{\rm X}}_{\rm t}) \mathbf{A}^{-1} ({\boldsymbol{\rm X}}_{\rm t}) \mathbf B ({\boldsymbol{\rm X}}_{\rm t})
\end{equation}
It is also necessary to approximate the density's gradient in the material domain.
Therefore, the first derivative of the shape function with respect to the material coordinates is derived in direction $X_j$:
\begin{equation}
{\boldsymbol{\upomega}}^{\rm T}_{,j} = \mathbf p^{\rm T}_{,j} \mathbf A^{-1} \mathbf B + \mathbf p^{\rm T} ( \mathbf A_{,j}^{-1} \mathbf B + \mathbf A^{-1} \mathbf B_{,j} )
\end{equation}
The commas in the subscripts denote the partial derivative and the inverse of the material derivative of matrix $\boldsymbol{\rm A}$ is evaluated as 
\begin{equation}
\mathbf A_{,j}^{-1} = -\mathbf A^{-1} \mathbf A_{,j} \mathbf A^{-1}
\end{equation}
It is worth noting that for any TPA located at ${\boldsymbol{\rm X}}_{\beta}$, MWLS shape functions do not satisfy Kronecker delta property, i.e. $\omega_i({\boldsymbol{\rm X}}_{\beta}) \neq \delta_{i\beta}$. 
%The values obtained from the MWLS approximation are not the same as the given field values, i.e. $v^h({\boldsymbol{\rm X}}_{\beta}) \neq v({\boldsymbol{\rm X}}_{\beta}) $ as presented with a 1D example in Figure~\ref{fig:mwls_approxi}.
%\begin{figure}[h!]
%	\begin{centering}
%		\includegraphics[width=7cm]{Figures/1dMWLS.pdf}
%		\caption{1D example of moving least squares method.}
%		\label{fig:mwls_approxi}
%	\end{centering}
%\end{figure}
%Since the MWLS shape functions do not satisfy Kronecker-delta property on the boundaries of the problem; it can be quite a challenge to enforce essential boundary conditions, however, here approximation is used for simple mapping hence this problem can be neglected. 
\\

A common problem arising from CT scanning is generation of Partial Volume Artifacts~\citep{adams2009quantitative}. As a result, the voxel data can be averaged between two materials, for example bone and soft tissue.
To eliminate mapping spurious bone densities, some researchers have proposed to either redefine data at any node on the mesh surface to data assigned on the nearest internal node~\citep{helgason2008modified, chen2010new} or resurface the mesh geometry~\citep{peleg2014can}. 
In this study, a more elegant solution is proposed; every CT scan data point positioned outside the geometry of the bone is simply removed from the domain of influence, thereby only points that fall inside the volume are approximated. 
%Determining whether a given point is inside a polyhedron is a classic computer graphics problem.  It can be solved by casting a ray originating from the given point to an arbitrary direction and determine the number of intersections of the ray with the polyhedron. If the ray intersects the shape an even number of times, then the point is outside the shape. It is important to choose a random direction. (should I describe why based on measure theory?) In MoFEM implementation standard C++ $rand()$ function was used, however without the seed in order to ensure that the code remains deterministic. 
This procedure only has to be performed once for each domain of influence  and can be easily parallelized. %is 'embarrasingly parrallel' 




\end{document}