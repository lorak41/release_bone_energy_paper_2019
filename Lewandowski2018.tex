% !TeX root = ./Lewandowski2018.tex
\documentclass[onecolumn]{svjour3}   
%\usepackage{amssymb,amsthm,mathrsfs,graphicx, bm}
\usepackage{amssymb,mathrsfs,graphicx, bm}
\usepackage{natbib}
\usepackage{subcaption}
% \usepackage{titlesec}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{newtxtext,newtxmath}
\usepackage{hyperref}

\usepackage{color}
\usepackage{amsfonts}
\pagenumbering{arabic}

%Packages for Matlab2TikZ
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{plotmarks}
\usetikzlibrary{arrows.meta}
%\tikzset{every picture/.style={/utils/exec={\boldsymbol{\rm X}}{\sffamily}}}
\usepgfplotslibrary{patchplots}
\usepackage{grffile}

\usepackage{lineno,hyperref}
\usepackage{moreverb}
\usepackage[ruled,slide]{algorithm2e}



\begin{document}

\title{A computational framework for crack propagation in spatially heterogeneous materials}
\subtitle{}
\author{Karol Lewandowski \and
	{\L}ukasz Kaczmarczyk \and
	Ignatios Athanasiadis \and
	John F. Marshall\and 
	Chris J. Pearce 
}

\institute{Karol Lewandowski \at
	Glasgow Computational Engineering Centre, The James Watt School of Engineering, University of Glasgow, Glasgow, G12 8QQ, UK \\
	\email{karol.lewandowski@glasgow.ac.uk}           %  \\
	\and
	John F. Marshall \at
	Weipers Centre Equine Hospital, School of Veterinary Medicine, University of Glasgow, Glasgow, G61 1QH, UK
} 

\date{Received: date / Accepted: date}

\maketitle
% \author[gla,vet]{Karol Lewandowski\corref{cor}}
% \ead{karol.lewandowski@glasgow.ac.uk}
% \author[gla]{{\L}ukasz Kaczmarczyk}
% \ead{lukasz.kaczmarczyk@glasgow.ac.uk}
% \author[gla]{Ignatios Athanasiadis}
% \ead{ignatios.athanasiadis@glasgow.ac.uk}
% \author[vet]{John F. Marshall}
% \ead{john.f.marshall@glasgow.ac.uk}
% \author[gla]{Chris J. Pearce}
% \ead{chris.pearce@glasgow.ac.uk}
% \cortext[cor]{Corresponding author}
% \address[gla]{Glasgow Computational Engineering Centre, The James Watt School of Engineering, University of Glasgow, Glasgow, G12 8QQ, UK.}
% \address[vet]{Weipers Centre Equine Hospital, School of Veterinary Medicine, University of Glasgow, Glasgow, G61 1QH, UK,}

\begin{abstract}
This paper presents a mathematical formulation and numerical modelling framework for brittle crack propagation in heterogeneous elastic solids. 
Such materials are present in both natural and engineered scenarios.
The formulation is developed in the framework of configurational mechanics and solved numerically
using the finite element method.
We show that the methodology previously established for homogeneous materials without the need for any further assumptions. 
The proposed model is based on the assumption of maximal dissipation of energy and utilises the Griffith criterion; we 
show that this is sufficient to predict crack propagation in brittle heterogeneous materials, with spatially varying Young's modulus and fracture energy.
Furthermore, we show that the crack path trajectory orientates itself such that it is always subject to Mode-I. 
The configurational forces and fracture energy release rate are both expressed exclusively in terms of nodal quantities, 
avoiding the need for post-processing and enabling a fully implicit formulation for modelling the evolving crack front and creation of new crack surfaces.
The proposed formulation is verified and validated by comparing numerical results with both analytical solutions and experimental results.
Both the predicted crack path and load-displacement response show very good agreement with experiments where the crack path was independent of material heterogeneity for those cases.
Finally, the model is successfully used to consider the real and challenging scenario of fracture of an equine bone, with spatially varying material properties obtained from CT scanning. 


\keywords{ Finite element analysis \and functionally graded materials  \and fracture  \and configurational mechanics  \and heterogeneous materials}
\end{abstract}


%\linenumbers

\section{Introduction}
% 
% 
The predictive modelling of crack propagation continues to generate significant scientific interest and 
represents an ongoing focus for computational mechanics research.  
The unstable and highly nonlinear nature of crack propagation in three-dimensional solids
means that the development of a robust and objective modelling capability, 
that is able to capture the evolution of the crack front and creation of new crack surfaces, represents a considerable challenge.

This paper extends the authors' previous work for brittle fracture in solids that comprise homogeneous materials~\cite{kaczmarczyk2017energy}, 
to now consider spatially heterogenous materials. 
Such materials are prevalent in both natural and engineered materials. 
Functionally Graded Materials (FGM) is a class of materials whose composition (and therefore material properties) 
vary spatially in a smooth fashion \cite{KawasakiWatanabe1997} and are used in many engineering 
applications \cite{Jha2013, NaebeShirvan2016}.
The advantage of FGMs is that they can be designed to achieve desired mechanical behaviour \cite{Erdogan1995, FinotSuresh1996}. 
Nevertheless, it is necessary to model their behaviour and failure characteristics when used in critical engineering applications. 
Numerical models have been proposed to investigate crack propensity and stress intensity factors in FGMs for various material distribution 
and multiple cracks, for instance \cite{KimPaulino2002, Ayhan2009, ZhangBEM2011, ShiMan2014, ShojaeeDaneshmand2015}. 
Despite the breadth and importance of applications where these materials are present, 
numerical modelling of crack propagation is still in the early stages of development.
The majority of well validated models available are limited to 2D analysis \cite{KimPaulino2004,Bayesteh2013, Ooi2015, Chafi2019}.
For the 3D case, a phase field model has also been proposed \cite{Hirshikesh2019}.
However, such an approach is strongly mesh-size and step-size dependent, 
which could present an unsurmountable computational challenge for full scale  applications.

Natural materials, such as bamboo, bone and skin exhibit spatially heterogenous materials that also evolve over time. 
In particular, bone adapts to its mechanical environment (commonly referred to as bone remodelling); 
this is an on-going biological process of replacing old bone tissue with new bone, thus repairing fatigue damage~\cite{hughes2017role}. 
This ability to repair bone micro-damage is essential for maintaining mechanical integrity. 
Therefore, variations in bone tissue quality and hence material properties can be observed at different locations and times of bone life. 
Consequently, there is a strong correlation between stress fractures and the adaptation process~\cite{hughes2017role}. 
Furthermore, bone repair can be overwhelmed by load-induced bone densification that also increases brittleness and reduces fracture resistance~\cite{loughridge2017qualitative}.

This paper addresses the need for an energetically consistent model for crack propagation in heterogeneous materials.
The formulation is developed in the framework of configurational mechanics and solved numerically using the finite element method.
The concept of configurational forces was originally introduced by Eshelby~\cite{eshelby1951force}. 
Unlike physical forces, configurational forces act on the material manifold and represent the tendency of imperfections like cracks, 
voids or material inhomogeneities to move relative to the surrounding material. 
The past two decades have seen a growing interest in this approach for analysis of material imperfections~\cite{maugin2016configurational} and in particular for evaluating the forces driving crack advancement~\cite{kaczmarczyk2017energy,steinmann2001application, ozencc2016configurational}. 
However, until recently this approach has never been used to effectively assess configurational forces for cracking in heterogeneous bodies. 

The model presented in this paper is based on the assumption of maximal dissipation of energy and utilises the Griffith criterion. 
We show that these assumptions are sufficient to predict crack propagation in brittle heterogeneous materials, 
using configurational mechanics. 
Additional configurational forces, arising from inhomogeneities~\cite{kienzler2014configurational}
associated with spatially varying properties are introduced into the formulation. This allows for both the accurate assessment of the likelihood of a crack to propagate and to simulate the subsequent propagation of fractures. 
The model offers a computationally efficient 3D analysis tool for complex materials by means of a monolithic approach 
with relatively small number of finite elements.

\textcolor{red}{Furthermore, the focus of this work is on the modelling of physical processes arising from crack propagating through material heterogeneity and \emph{not} on the particular choice of displacement jump approximation approach along the crack path.}
\textcolor{red}{{The framework proposed is not restricted to the underlying crack propagation implementation of the present work i.e. mesh cutting algorithm.
Other popular brittle crack propagation approaches such as XFEM and PUFEM, \citep{Belytschko1999, WriggersXFEM, Babuska2017, Tian2019}} could adopt the present framework by adding explicit approximation of material position to incorporate configurational forces evaluation.  }

This article is structured as follows. After establishing the kinematic preliminaries in Section~\ref{preliminaries}, Section~\ref{sec:fracture_prop} extends the authors' previous work for evolving crack propagation within the framework of configurational mechanics. Section \ref{sec:fem_modelling} describes the finite element method implementation and briefly introduces a special element for capturing the singular stress field at the crack front.  
All the above components are brought together into a single framework and its performance is demonstrated using a series of numerical examples in Section~\ref{sec:numerical_examples}, where the model is validated with experimental results for 
FGMs, as well as applying it to a full-scale model of equine bones using clinically available CT-scanning data.


% 
% 
\section{Preliminaries}
\label{preliminaries}
Figure~\ref{fig:domains4} shows a section of a solid with an initial crack in the reference domain $\mathscr{B}_{0}$. As a result of loading, the crack extends and the body deforms elastically. Working within the framework of configurational mechanics \cite{kaczmarczyk2014three,kienzler2014configurational}, it is convenient to decompose this behaviour into an extension of the crack in the material domain  $\mathscr{B}_t$ followed by elastic deformation in the spatial domain $\Omega_t$. The former is described by the mapping from the reference  domain to the material domain ${\boldsymbol\Xi}$, whilst the latter is described by the mapping from the material to the spatial domain ${\boldsymbol\varphi}$ - Figure~\ref{fig:domains4}.

\begin{figure}[th] 
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.7\textwidth]{Figures/domains4.eps} // by Chris (keep as a reference)
%\def\svgwidth{15cm} 	\input{Figures/Configurations.pdf_tex} 
\includegraphics[width=9cm]{Figures/domains5.pdf} 
\end{center}
\caption{Kinematics of crack propagation in elastically deforming body.}
\label{fig:domains4}
\end{figure}

The material coordinates $\mathbf{X}$ are mapped onto the spatial coordinates $\mathbf{x}$ via the
familiar deformation map $\boldsymbol\varphi(\mathbf{X},t)$. The physical displacement is:
\begin{equation}
\mathbf{u}=\mathbf{x}-\mathbf{X}
\end{equation}
The reference material domain describes the body before crack extension. ${\boldsymbol\Xi}(\boldsymbol\chi,t)$ maps the reference material coordinates $\boldsymbol\chi$ on to the current material coordinates $\mathbf{X}$, representing a configurational change, i.e. extension of the crack due to advancement of the crack front. ${\boldsymbol\Phi}$ maps the reference material coordinates $\boldsymbol\chi$ on to the spatial coordinates $\mathbf{x}$. The current material and spatial displacement fields are given as
\begin{equation}
\mathbf{W} = \mathbf{X} - {\boldsymbol\chi}\quad\textrm{and}\quad
\mathbf{w} = \mathbf{x} - {\boldsymbol\chi}
\end{equation}
$\mathbf{H}$ and $\mathbf{h}$ are the gradients of the material and spatial maps and $\mathbf{F}$ is the deformation gradient~\cite{kaczmarczyk2014three}, defined as:
\begin{equation}
\mathbf{H}=\frac{\partial {\boldsymbol\Xi}}{\partial {\boldsymbol\chi}},\quad\mathbf{h}=\frac{\partial {\boldsymbol\Phi}}{\partial {\boldsymbol\chi}},\quad\mathbf{F} = \frac{\partial \boldsymbol\varphi}{\partial \mathbf{X}} = \mathbf{h}\mathbf{H}^{-1}
\end{equation}


The time derivative of the physical displacement $\mathbf{u}$ and the deformation gradient $\mathbf{F}$ (material time derivative) are given as~\cite{kaczmarczyk2014three}:
\begin{equation}\label{eq:phy_vel}
\dot{\mathbf{u}}= \dot{\mathbf{w}}-\mathbf{F}\dot{\mathbf{W}} \qquad 
\dot{\mathbf{F}} = \nabla_\mathbf{X} \dot{\mathbf{x}} = \nabla_\mathbf{X} \dot{\mathbf{u}} = 
\nabla_\mathbf{X} \dot{\mathbf{w}} - \mathbf{F} \nabla_\mathbf{X} \dot{\mathbf{W}}
\end{equation}
 
% \section{Bone adaptation} \label{sec:bone_remodel}
% In this paper, the modelling of bone adaptation is based on the work of Kuhl and Steinmann~\cite{kuhl2003theory} in which bone is considered an elastic porous material. The model is stable~\cite{kuhl2003computational}, efficient~\cite{kaczmarczyk2011efficient} and capable of 
% producing bone mineral density profiles that are quantitatively comparable with DEXA scans following gait analysis~\cite{pang2012computational}. 
% Using this approach, bone adaptation in human scapula~\cite{liedtke2017computational}, 
% tibia~\cite{pang2012computational}, humerus~\cite{taylor2009phenomenon} and femur with various surgical implants~\cite{ambrosi2011perspectives, Connor2017bone} have been simulated and its potential in topology optimization~\cite{waffenschmidt2012application} has been explored. 
% One of the advantages of such a phenomenological approach is that only a small number of parameters are required, which can be experimentally
% determined from, for example, CT imaging~\cite{zadpoor2013open}.


% \subsection{Conservation of mass}

% Following Kuhl and Steinmann~\cite{kuhl2003computational}, it is assumed that
% the rate of change of the time-dependent material density is in equilibrium
% with mass flux, expressed as:
% \begin{equation} \label{eq:mass_balance}
% \frac{\partial\rho}{\partial t}  + \dot{\mathbf{W}} \cdot  \nabla_\mathbf{X} \rho = 
% \nabla_{\boldsymbol {\rm X}} \cdot \mathbf{R} + \mathcal{R}_0
% \end{equation}
% where $\rho$ is mass density and $\mathcal{R}_0$ is the locally created mass.
% It is worth noting that, comparing to Kuhl and Steinmann, we require a material time derivative since the reference material configuration is changing, leading to the addition of the second term in Eq.~\ref{eq:mass_balance}. This is only a kinematic extension of the formulation and does not change the description of the physical problem. 

% Furthermore, $\mathbf{R}$ is the mass flux defined as:
% % 
% \begin{equation}
% \mathbf{R} = \mathcal{R} \nabla_\mathbf{X} \rho
% \label{eq:mass_flux}
% \end{equation}
% % 
% where $\mathcal{R}$ is mass conductivity. The term on the right hand side of Eq. \ref{eq:mass_balance}
% is the material time derivative associated with the evolving current material
% configuration. 
% However, in the present work it is assumed that the mass flux $\mathbf{R}$ is zero and hence only the local mass source $\mathcal{R}_0$ contributes to the changes in density.


% \subsubsection{Constitutive relationship for bone adaptation}

% \label{sec:constitutive_eq}

% In the context of bone mechanics, the constitutive law for the mass source $\mathcal{R}_{0}$ is commonly in the form proposed by Harrigan and Hamilton~\cite{Harrigan1993}. This well established approach has been used e.g. in \citep{harrigan1996bone, taylor2009phenomenon, pang2012computational, hambli2013integrated, kuhl2003computational}. 
% It is assumed that the local increase/decrease in density is governed by the elastic energy as follows:
% \begin{equation}
% \mathcal{R}_{0}=c\left[\Biggl[\frac{\rho}{\rho_{0}^{\ast}}\Biggr]^{-m}\Psi
% -\Psi^{\ast}\right]
% \label{eq:mass_source}
% \end{equation}
% where $\rho_0^\ast$ and $\Psi^\ast$ represent reference values of the
% density, $\rho$ and free energy, $\Psi$, respectively. The driving term
% $\left[ \rho / \rho_0^\ast \right]^{-m}\Psi$ tends to converge to
% $\Psi^\ast$ (see Eq.~(\ref{eq:mass_source})) when density saturation is
% achieved and local generation of bone ceases. The exponent $m$ is a
% dimensionless scalar introduced to guarantee uniqueness and
% stability~\cite{Harrigan1993}. The coefficient $c$ controls
% the rate of the adaptation process with units~$[\rm{s/cm^2}]$. 
% % As proposed in~\cite{Waffenschmidt2012}, it can be beneficial to prescribe an upper and
% % lower bound for bone density, thereby avoiding spurious or non-physical
% % values (lower than zero or greater than observed maximum). In this paper, the parameter $c$, which is conventionally considered 
% % to be constant, is replaced by a bell function
% % defined as:
% % \begin{equation}
% % \begin{aligned}
% % c(\rho) = & \frac{1}{1 + \left[  (\rho - \rho^{\mathrm{mid}}) / 
% % (\rho{^\mathrm{max}} - \rho{^\mathrm{mid})} \right]^{2 b}}\\
% % & \mathrm{with} \quad \rho^{\mathrm{mid}} = 
% % \frac{\rho{^\mathrm{max}} + \rho{^\mathrm{min}}}{2}
% % \end{aligned}
% % \label{eq:bell_function}
% % \end{equation}
% % $\rho^\mathrm{max}$ and $ \rho{^\mathrm{min}}$ where $\rho^\mathrm{max}$
% % and $\rho^\mathrm{min}$ are the maximum and minimum values of $\rho$, and
% % $\rho^{\rm {mid}}$ is their average. The bell function
% % (\ref{eq:bell_function}) is illustrated in Figure~\ref{fig:bell_func} for
% % different values of the integer exponent, $b$. Its application and influence
% % on the overall results are elaborated in
% % Section~\ref{sec:numerical_examples}.
% % \begin{figure}[!htb]
% % 	\centering
% % 		\input{Figures/tikz/myfile_bell.tex}
% % 		\caption{Bell function for parameter $c$ for different values of the integer exponent $b$. 
% % 		As $b \rightarrow \infty$, the bell-shape curve becomes infinitely steep at 
% % 		$\rho{^\mathrm{min}}$ and $ \rho{^\mathrm{max}}$.}
% % 		\label{fig:bell_func}
% % \end{figure}
% 
% In most cases, the values of parameters for bone adaptation models are chosen using trial and error approach based on the outcome of the predictions. Ideally, these values should be obtained by solving an inverse model based on bone anatomy, loading, and density data, as proposed in \citep{zadpoor2013open}. However, it still remains an open challenge in computational biomechanics. In this work, the parameters are based on previously validated investigations of human tibia \cite{pang2012computational}, together with an adjustment for the higher stiffness measured in equine bones \cite{Les1994}.
% 
% \subsection{Elastic constitutive relationship}
% As an elastic cellular material, the free energy $\Psi (\mathbf F, \rho)$ for bone is typically weighted by the relative density \citep{gibson1982mechanics,Kuhl2003a,pang2012computational,Waffenschmidt2012} as follows:
% \begin{equation}
% \Psi=\left[\frac{\rho}{\rho_{0}^{\ast}}\right]^{n}\Psi^{\mathrm{neo}},
% \label{eq:free_energ}
% \end{equation}
% where $\Psi^{\rm {neo}}$ is the Helmholtz free energy for a Neo-hookean material, which is expressed in terms of the right Cauchy-Green deformation tensor $\boldsymbol{\rm{C}}$:
% \begin{equation}
% \Psi^{\mathrm{neo}}=\frac{\mu}{2}\left[\textrm{tr}(\mathbf{C})-3\right]-\mu\ln(\sqrt{\det\mathbf{C}})+\frac{\lambda}{2}\ln^{2}(\sqrt{\det\mathbf{C}})
% \end{equation}
% where $\mu$ and $\nu$ are the Lam\'e constants. Moreover, the exponent $n$ is a
% non-physical parameter that typically varies as $1 \leq n \leq 3.5$, 
% depending on the porosity of the material~\cite{Gibson2005}. 
% %This isotropic constitutive law can be extended for the case of anisotropy, if required, using the micro-sphere framework~\cite{Waffenschmidt2012}.
% 
% Bone adaptation is a mechanically driven process, whereby the density field evolves in response to the mechanical environment. Likewise, the material stiffness is directly dependent on the density and this, in turn, influences the mechanical response. Therefore, the equation for conservation of mass \ref{eq:mass_balance} is coupled with the equation for linear momentum balance:
% \begin{equation} \label{eq:linear_momentum}
% \nabla_{\mathbf X} \cdot \mathbf P = 0
% \end{equation}
% where $\mathbf P$ is the the first Piola-Kirchhoff stress, in case of heterogeneous materials has the following form:
% 
% \begin{equation}
% \mathbf P = \frac{\partial \Psi (\mathbf F, \rho)}{\partial \mathbf F} = \left[ \frac{\rho }{ \rho_{0}^{\ast} } \right]^{n}  \frac{ \partial \Psi (\mathbf F) }{ \partial \mathbf F}
% \end{equation}
% $n$ is a characteristic exponent and $\rho_{0}^{\ast}$ is the reference density. Such form of the Piola-Kirchhoff stress was adopted from porous materials like bones~\cite{Gibson2005}. However, it can be used for generic heterogeneous materials.
% This coupled system of equations is solved using the finite element method - see Section \ref{sec:numerical_examples:bone_adap}.
% 
% \section{Fracture resistance and fracture propagation}
% \label{sec:fracture}


\section{Fracture propagation}
\label{sec:fracture_prop}

\subsection{First and second laws of thermodynamics}

The first law of thermodynamics can be expressed as 
\begin{equation}
\label{eq::first_law}
\int_{\partial \mathcal B_t} {\dot {\boldsymbol {\rm u} } } 
\cdot \mathbf t \mathrm d S = \int_{\partial \Gamma } \gamma(\rho) \dot A_\Gamma +
{\frac{\mathrm d}{\mathrm d t }} 
\int_{\mathcal B_t} \Psi(\mathbf F, \rho) \mathrm d V
\end{equation}
where the left hand side is the power of external work, the first term on the
right hand side is the rate of crack surface energy and the last term is
the rate of internal energy. $\mathbf t$ is the external
traction vector, $\gamma $ is the surface energy $[ {\rm{N m}}^{-1} ]$, $\dot{A}_\Gamma$ is the change in the
crack surface area, $\rho$ is the density and
$\Psi$ is the volume specific free energy. The crack surface $\Gamma$ comprises two crack faces and a crack front $\partial\Gamma$ - see Figure~\ref{fig:crac_surf_construct}.

\begin{figure}[th]
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{0pt}%
\begin{center}
% \includegraphics[width=0.8\textwidth]{Figures/crack3.eps} 
\def\svgwidth{7cm} 	\input{Figures/CrackSurface.pdf_tex} 
\end{center}
\caption{Crack construction. In 2D (left) and in more detail in 3D (right).}
\label{fig:crac_surf_construct} 
\end{figure}
% 
% 
The power of external work on the elastic body, with the use of Eq.~(\ref{eq:phy_vel}), is given as: 
\begin{equation} \label{eq:extern_pow}
	\mathscr{P} =\int_{\partial \mathscr{B}_{t}} \dot{\mathbf{u}} \cdot \mathbf{t} \operatorname{d} S=\int_{\partial \mathscr{B}_{t}}\left\{\dot{\mathbf{w}} \cdot \mathbf{t}-\dot{\mathbf{W}} \cdot \mathbf{F}^{\mathrm{T}} \mathbf{t}\right\} d S
\end{equation}
% 
In~\cite{kaczmarczyk2017energy}, a kinematic relationship between the change in the
crack surface area $\dot{A}_\Gamma$ and the crack front velocity $\dot{\mathbf{W}}$ was derived that is given as:
\begin{equation}
\label{eq::Agamma2}
\dot{A}_\Gamma
 =
\int_{\partial\Gamma}
\mathbf{A}_{\partial\Gamma} \cdot \dot{\mathbf{W}} \textrm{d}L
\end{equation}
where 
$\mathbf{A}_{\partial\Gamma}$ is a dimensionless kinematic state variable that defines the orientation of the current crack front that can be considered a unit vector normal to the crack front and tangential to the crack surface. In deriving this expression, it was recognised that any change in the crack surface area $\dot{A}_\Gamma$ in the current material space can only occur due to motion of the crack front.
% 
% following the reviewers suggestion we put a more detailed derivation
Assuming that no dissipation of energy occurs within the volume of the body (i.e. restricted to the creation of new crack surfaces) and given that $\mathrm d \dot V = \nabla _{\mathbf X} \cdot \mathbf{\dot W} \mathrm d V$, the change of the specific free energy can be expressed as:
\begin{equation} \label{eq:psi_time}
	\begin{aligned}
		\frac{\mathrm{d}}{\mathrm{d} t} \int_{\Omega} & \Psi(\mathbf{F}, \rho) \mathrm{d} \Omega =
		 \int_{\Omega} \nabla_{\mathbf{X}} \dot{\mathbf{w}}: \mathbf{P} 
		+ \nabla_{\mathbf{X}} \dot{\mathbf{W}}: \Sigma 
		+ \mathbf f^\mathrm{inh} \cdot \dot{\mathbf{W}} \mathrm{d} \Omega
	\end{aligned}
	\end{equation}
where
\begin{equation}
\begin{aligned}
{\bm {\Sigma}} =
\Psi(\mathbf F, \rho) \mathbf  1 - \mathbf F^{\rm T} 
\mathbf P(\mathbf F, \rho),
%\mathrm{and} \quad
\end{aligned}
\end{equation}
where $\mathbf P$ is the first Piola-Kirchhoff stress; in the case of heterogeneous materials, can be expressed as:
\begin{equation}
\mathbf P = \frac{\partial \Psi (\mathbf F, \rho)}{\partial \mathbf F} = \left[ \frac{\rho }{ \rho_{0}^{\ast} } \right]^{n}  \frac{ \partial \Psi (\mathbf F) }{ \partial \mathbf F}
\label{eq:piola_heter}
\end{equation}
The parameter $n$ is a characteristic exponent and $\rho_{0}^{\ast}$ is the reference density. Although this form of the Piola-Kirchhoff stress was adopted from porous materials, such as bone~\cite{Gibson2005}, it can be used for generic heterogeneous materials.
% 
${\bm {\Sigma}}$ is the Eshelby stress tensor and
$\mathbf f^{\mathrm {inh}}$ is an additional fictitious force that arises from variations in the density field and drives the crack front from dense to less dense material. $\mathbf f^{\mathrm {inh}}$  is computed as follows:
\begin{equation}
	\mathbf f^{\mathrm{inh}} =  \left(\frac{\partial \Psi}{\partial \mathbf{X}}\right)_{\mathrm{expl.}}
\end{equation}
where the explicit derivative of $\Psi$ is defined by 
\begin{equation}
	\left(\frac{\partial \Psi}{\partial \mathbf{X}}\right)_{\mathrm{expl.}} = 
	\left.
	\frac{\partial \Psi}{\partial \rho}
	\right|_{(\mathbf{F} = {\rm{const}})}
	\frac{\partial \rho}{\partial \mathbf X} 
\end{equation}
% 
Making use of Equations~(\ref{eq:extern_pow}), (\ref{eq::Agamma2}) and (\ref{eq:psi_time}), Equation~(\ref{eq::first_law}) can be reformulated as:
% 
\begin{equation}\label{eq:crack_first_law}
\begin{aligned}
\int_{\partial \mathcal B_t} \big( {\dot {\boldsymbol {\rm w} } } \cdot \mathbf t - 
{\dot {\boldsymbol {\rm W} } } \cdot \mathbf F^{\rm T} \mathbf t \big) \mathrm d S = 
\int_{\partial \Gamma } \gamma \mathbf A_{\partial \Gamma} 
\cdot {\dot {\boldsymbol {\rm W} } } \mathrm d L \\
+ \int_{\mathcal B_t} 
\big( \mathbf P\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm w} } } + 
{\bm  \Sigma}\, \colon \nabla_{\mathbf X} {\dot {\boldsymbol {\rm W} } } 
&      +  \mathbf f^{\mathrm {inh}} \cdot \dot{\mathbf{W}}
\big) \mathrm d V 
\end{aligned}
\end{equation}
% 
The spatial conservation law of linear momentum balance is repeated here:
\begin{equation} \label{eq:linear_momentum2}
\nabla_{\mathbf X} \cdot \mathbf P = 0
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
\mathbf{P}\mathbf{N} = \mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
where $\partial\mathcal B_t^\sigma$ is the region of the boundary where tractions are applied and $\mathbf N$ is the outer normal to the surface.. 
% 
The equivalent material momentum balance is expressed as:
\begin{equation}
\nabla_{\mathbf X } \cdot {\bm {\Sigma}}= \mathbf f^{\mathrm {inh}}
\;
\forall \mathbf{X}\in\mathcal B_t,
\quad
{\bm {\Sigma}}\mathbf{N} = \mathbf{F}^\textrm{T}\mathbf{t}\;
\forall \mathbf{X}\in\partial\mathcal B_t^\sigma
\end{equation}
It is important to note that $\mathbf f^{\mathrm {inh}}=\mathbf{0}$ in the case of homogeneous materials, with uniform density distribution.
% 
After applying the divergence theorem to Eq.~(\ref{eq:crack_first_law}) and recognising the momentum balance laws, we follow~\cite{kaczmarczyk2017energy} to establish a local form of Eq.~(\ref{eq:crack_first_law}), which represents an expression for equilibrium of the crack front as
%Following, the divergence theorem is applied to gradient terms. Considering the volume and boundary integrals, and grouping together terms that are work conjugate to the spatial and material velocities, the local conservation laws are obtained. 
%Furthermore, the surface $\mathcal C$ (Figure~\ref{fig:frac_crack_con})
%collapses to the crack front $\partial \Gamma $ and integrals over the crack
%front are simplified as follows [REF]:
%\begin{equation}
%\lim_{\mathcal C \to 0} \int_{\mathcal C} (\cdot ) \mathrm d S = \lim_{\mathcal C \to 0} \int_{{\mathcal L}_{\rm t}} \int_{ {\mathcal L}_{\rm n}} (\cdot) \mathrm d S = \int_{\partial \Gamma} \lim_{|\mathcal{ L }|\to 0} \int_{{\mathcal L}_{\rm n} } (\cdot ) \mathrm d S
%\end{equation}
%with the integrals at crack front:
%Following \cite{kaczmarczyk2017energy}, the an expression for equilibrium of the crack front is expressed as
\begin{equation}\label{eq:crack_local_first_law}
	{\dot {\boldsymbol {\rm W} } } \cdot 
	\left( \gamma \mathbf A_{\partial \Gamma} - \mathbf G \right) = 0
\end{equation}
where the configurational force $\mathbf{G}$ is the driving force for crack propagation:  
\begin{equation}
	\mathbf G = \lim_{|\mathcal{ L }|\to 0} 
	\int_{ {{\mathcal L}_{\rm n}} } {\bm {\Sigma}}\mathbf{N}\, \mathrm d L 
	\label{eq:crack_configuration_force}
\end{equation}
From this equation, it is clear that the crack front is in equilibrium when the crack is not propagating, i.e. material
velocity $\dot{\mathbf{W}}$ at the crack front is zero, or when the crack front is propagating and the configurational force
is in equilibrium with the material resistance $\gamma \mathbf A_{\partial \Gamma}$. 

It should be noted that crack front equilibrium is unaffected by material heterogeneities and does not depend on $\mathbf f^{\mathrm {inh}}$. All terms in Eq.~\ref{eq:crack_local_first_law} are only evaluated at the crack front. However, it will be shown in Section~\ref{sec:fem_fracture_prop} that, in a discrete setting, calculation of the nodal configurational forces involves a volume integral of the density gradient.

Since Eq.~(\ref{eq:crack_local_first_law}) has more than one solution at equilibrium, depending on whether the crack 
does or does not propagate, the formulation is supplemented by a straightforward criterion for crack growth, equivalent to Griffith's  criterion~\cite{kaczmarczyk2017energy}:
\begin{equation} \label{eq:grif1}
\phi(\mathbf{G}) = 
\mathbf{G} \cdot \mathbf{A}_{\partial\Gamma} - g_c/2 \leq 0
\end{equation} 
where $g_c=2\gamma(\rho)$ is a material parameter specifying the critical threshold of energy release
per unit area of the crack surface $\Gamma$, also known as the Griffith energy. Note that in context of inhomogeneous materials it may depend on the density $\rho$. For a point on the crack front to satisfy the crack growth criterion, 
either $\phi<0$ and $\dot{\mathbf{W}}=0$, or $\phi=0$, $\dot{\mathbf{W}}\ne 0$ and $\gamma\mathbf{A}_{\partial\Gamma}=\mathbf{G}$. 
% 
% 
The direction of fracture propagation is
constrained by the second law of thermodynamics. Here we assume that fracture takes place
relatively fast, 
such that non-negative dissipation at the crack front can be expressed as
\begin{equation}
	\mathcal{D} = \gamma \dot{\mathbf{W}} \cdot \mathbf{A}_{\partial\Gamma}= \dot{\mathbf{W}} \cdot \mathbf{G}\ge0
	\label{eq:max_dissp}
\end{equation}
% 
% It should be noted that the well-established stress intensity factors are not applicable 
% in the case of heterogeneous materials, since it requires the existence of
% an analytical solution for the stress field in the vicinity of the crack front that is
% independent of arbitrary distribution of density. 
% Similarly, the use of
% J-integrals requires integration over the closed surface without
% inhomogeneities (including heterogeneous density distribution), except for the crack front itself and therefore not applicable in this case.
Finally, it is worth noting that the current framework is formulated within 
the realm of large displacements and large strains, hence it 
is generally valid under any assumption for strains and displacements. 

\subsection{Density field}
\label{sec:dens_mapping}
The previous subsections have shown that fracture modelling of heterogeneous materials is influenced by the density distribution in the material configuration (see Eq.~\ref{eq:piola_heter}). This density field can be derived in a number of ways: in the case of FGMs, from a known function of spatial position; from image data of the material, such as computed tomography (CT) scans; in the case of a material that experiences remodelling, such as bone, from a separate numerical analysis \cite{kuhl2003theory,kaczmarczyk2011efficient}. Previous examples in the literature of subject-specific modelling to assess the stresses and fracture resistance of heterogeneous bones can be found in~\cite{poelert2013patient,Helgason2008b,yosibash2010predicting}. Most algorithms that use CT voxel data have simply averaged~\cite{zannoni1999material} or integrated data onto finite elements, thereby supplying a constant density within each element volume~\cite{taddei2007material, schileo2008subject}. In this paper, the density data associated with each 3D voxel from CT scan data is spatially approximated. 

In the numerical examples described later, the density in the reference configuration is prescribed as a function of spatial positions (FGM) and CT scan data for the bone example. It will be shown in the next section that, in order to evaluate the configurational forces at the crack front, it is necessary to have a spatially smooth density field. Therefore, discrete density data will need to be approximated as a smooth density field, and this will be achieved by adopting the Moving Weighted Least Squares (MWLS) method. This mapping approach was chosen since it offers higher regularity (i.e. higher derivatives exist) than when the field is
directly approximated on the finite element mesh. Full details are given in \cite{karol_lewandowski_moving_2019}.  %LINK TO ZENODO
% 
\section{Finite element modelling} \label{sec:fem_modelling}
% 
% This section considers the sequential analysis of bone adaptation and fracture propagation, although it is recognised that the density field could be obtained directly from subject-specific data, in which case it may not be necessary to undertake the bone adaptation analysis. A sequential approach is justified since the process of bone adaptation takes place at a much longer time scales than fracture.


In this work, three-dimensional domains are discretised with tetrahedral finite elements. 
Fields are approximated in the current material and current spatial spaces with 
hierarchical basis functions of arbitrary polynomial order, following the work of Ainsworth and Coyle~\cite{Ainsworth2003}.  
\begin{eqnarray}
	% \rho^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) {\tilde{\pmb\uprho}}(t) \\
	\mathbf{ X}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm {\upchi}}}) \tilde {\mathbf{ X}}(t), 
	\quad \mathbf{x}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}) {\tilde{\mathbf{x}}}(t) \\
	\mathbf{ W}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\rm \upchi}}) {\dot { \tilde {\boldsymbol {\rm W} } }}(t), 
	\quad \mathbf{w}^h({\boldsymbol {\rm \upchi}},t) = \pmb\Phi({\boldsymbol {\upchi}}){\dot { \tilde {\boldsymbol {\rm w} } }}(t)
	\label{eq:discretisation}
\end{eqnarray}
where $\mathbf{\Phi}$ are shape functions, superscript $h$ indicates approximation and $(\tilde \cdot)$ nodal
values. Moreover, the smoothed density field is approximated by MWLS shape functions
\begin{equation}
	\rho^{h,\textrm{MWLS}}(\mathbf{X},t) = \Phi^\textrm{MWLS}(\mathbf{X}) 
	\tilde{\pmb\uprho}^h(\Xi({\boldsymbol {\rm \upchi}}),t) 
\end{equation}
It should be noted that shape functions $\Phi^\textrm{MWLS}(\mathbf{X})$ are evaluated at
current material points, $\mathbf{X}$, rather than reference points, $\pmb\upchi$, as presented in Eq.~(\ref{eq:discretisation}) with the property of partition of unity.
Since the density field is evaluated at $\mathbf{X}$, the approximation is independent of changes of the material configuration (i.e.
changing mesh).
% 

% \subsection{Bone adaptation}
% The bone adaptation problem is solved with a staggered approach, the material configuration is fixed
% such that:
% \begin{equation}
% 	\tilde {\mathbf{ X}}(t)	= \tilde {{\boldsymbol {\rm \upchi}}} =  \textrm{const}
% 	\;\;\textrm{and}\;\;
% 	\dot{\tilde {\mathbf{X}}}(t) = \dot{\tilde {\mathbf{W}}}(t) = 0
% \end{equation}
% where $\tilde {{\boldsymbol {\rm \upchi}}}$ is vector of nodal positions. The semi-discrete
% form of equations (\ref{eq:mass_balance}) and (\ref{eq:linear_momentum}) take
% the form of residuals
% \begin{equation}
% 	\left\{
% 	\begin{aligned}
% 		\mathbf{r}^\rho(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) &=
% 		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\dot{\tilde{\pmb\uprho}}^h({\boldsymbol {\rm \upchi}},t) 
% 		\textrm{d}V \\
% 		&+ 
% 		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T} 
% 		\mathcal{R} \nabla_\mathbf{X}\pmb{\Phi} \tilde{\pmb\uprho}
% 		\textrm{d}V \\
% 		&-	
% 		\int_{\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} \mathcal{R}^h_0 
% 		\textrm{d}V	 \\
% 		&-
% 		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T} 
% 		\mathbf{q}^\textrm{external} 
% 		\textrm{d}S	
% 		= \mathbf{0}\\
% 		\mathbf{r}^x(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) &=
% 		\int_{\mathcal{B}^h_t} \nabla_\mathbf{X}\pmb{\Phi}^\textrm{T}\mathbf{P}^h\textrm{d}V \\
% 		&-
% 		\int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}\mathbf{f}^\textrm{ext, adapt}\textrm{d}S	
% 		= \mathbf{0}
% 	\end{aligned}
% 	\right.
% \end{equation}
% where $\mathbf{r}^\rho$ is the vector of residuals related to mass density flux 
% equilibrium, $\mathbf{q}^\textrm{external}$ is influx of mass across the boundary, 
% $\mathbf{r}^x$ is the vector of residuals associated with balance of linear momentum and
% $\mathbf{f}^\textrm{ext, adapt}$ are averaged long term forces
% mimicking mechanical load on the bone over long time period and $\mathcal{R}$ is mass conductivity. A truncated Taylor series expansion leads to the  semi-discrete form, expressed as:
% \begin{equation}
% \begin{split}
% 	\left[
% 		\begin{array}{c}
% 			\mathbf{r}^\rho(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))\\
% 			\mathbf{r}^x(\tilde{\pmb\uprho}_i(t), \tilde{\mathbf{x}}_i(t))
% 		\end{array}
% 	\right]
% 	+
% 	\left[
% 	\begin{array}{cc}
% 		\mathbf{M}_{\rho\rho} & \mathbf{0}\\
% 		\mathbf{0} & \mathbf{0}
% 	\end{array}
% 	\right]
% 	\left\{
% 		\begin{array}{c}
% 		\delta\dot{\tilde{\pmb\uprho}}_{i+1}(t)\\
% 		\delta\dot{\tilde{\mathbf{x}}}_{i+1}(t)
% 		\end{array}
% 	\right\}
% 	\\ + 
% 	\left[
% 		\begin{array}{cc}
% 			\mathbf{K}_{\rho\rho} & \mathbf{K}_{\rho x}\\
% 			\mathbf{K}_{x\rho} & \mathbf{K}_{xx}
% 		\end{array}
% 		\right]
% 		\left\{
% 			\begin{array}{c}
% 			\delta\tilde{\pmb\uprho}_{i+1}(t)\\
% 			\delta\tilde{\mathbf{x}}_{i+1}(t)
% 			\end{array}
% 		\right\}
% 		=
% 		\left[
% 			\begin{array}{c}
% 				\mathbf{0}\\
% 				\mathbf{0}
% 			\end{array}
% 		\right]
% 		\end{split}
% 		\label{eq:tangent_remodelling}
% \end{equation}
% with
% \begin{equation}
% \begin{split}
% \mathbf{M}_{\rho\rho} = 
% \left.
% \frac{\partial \mathbf{r}^\rho}{\partial \dot{\tilde{\pmb\uprho}}}
% \right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
% \mathbf{K}_{\rho\rho} = 
% \left. 
% \frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\pmb\uprho}}}
% \right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\, \\
% \mathbf{K}_{\rho x} = 
% \left.
% \frac{\partial \mathbf{r}^\rho}{\partial {\tilde{\mathbf{x}}}}
% \right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\,
% \mathbf{K}_{x \rho} = 
% \left.
% \frac{\partial \mathbf{r}^x}{\partial {\tilde{\pmb\uprho}}}
% \right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},\, \\
% \mathbf{K}_{x x} = 
% \left.
% \frac{\partial \mathbf{r}^x}{\partial {\tilde{\mathbf{x}}}}
% \right|_{(\tilde{\pmb\uprho}_i(t),\tilde{\mathbf{x}}_i(t))},
% \end{split}
% \end{equation}
% and 
% \begin{equation}
% \begin{split}
% 	\tilde{\pmb\uprho}_{i+i}(t) =
% 	\tilde{\pmb\uprho}_{i}(t) + \delta\tilde{\pmb\uprho}_{i+i}(t),\\
% 	\tilde{\mathbf{x}}_{i+i}(t) =
% 	\tilde{\mathbf{x}}_{i}(t) + \delta\tilde{\mathbf{x}}_{i+i}(t)
% \end{split}
% \end{equation}
% where $(\cdot)_i$ is quantity at Newton iteration $i$. Finally, the
% above semi-discrete problem is discretised in time using implicit Euler scheme:
% \begin{equation}
% 	\dot{\tilde{\pmb\uprho}}_{i+i}^{n+1}(t) =
% 	\frac{
% 	\tilde{\pmb\uprho}_{i+i}^{n+1}-\tilde{\pmb\uprho}^{n}
% 	}{\Delta t}
% \end{equation}
% where $\Delta t$ is length of time step, and $n$ is time step number.

% Note that the density field variables are approximated using polynomial bases functions that are one order less than those used for the spatial position variables, thereby ensuring a stable solution without oscillations.

% The discretised balance equations are solved iteratively using the Newton-Raphson method for the displacements and density.

% %NECESSARY??
% %
% %Two approaches have been implemented regarding evaluations of tangent stiffness,
% %i.e by either analytically evaluating the higher dimensional derivatives of the residuals of $\mathbf{r}_{x}$ and $\mathbf{r}_{\rho}$ as 
% %presented in Eq.~(\ref{eq:tangent_remodelling}) or by means of automatic differentiation using the ADOL-C 
% %library~\cite{Walther2009}. At this point, it is interesting to note that analyses presented in this paper using automatic 
% %differentiation are about 25~$\%$ slower than the analytical formulation due to increased assembly time.
% %Nevertheless, ADOL-C significantly simplifies the implementation process, it is then reasonable to use it at the early stages of development.
% %
\subsection{Fracture propagation} \label{sec:fem_fracture_prop}
% 
The residual force vector in the discretised spatial domain is expressed in the classical way as:
\begin{equation}
\begin{aligned}
\label{spatial_residual}
	\mathbf{r}_\textrm{s}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) = \tau\mathbf{f}^\textrm{h}_\textrm{ext,s}-\mathbf{f}^\textrm{h}_\textrm{int,s}\\= 
	\tau \int_{\partial\mathcal{B}^h_t} \pmb{\Phi}^\textrm{T}
	\mathbf{f}^\textrm{ext}
	\textrm{d}S
	- \int_{\mathcal{B}^h_t} \nabla_\mathbf{X} \pmb{\Phi}^\textrm{T}
	\mathbf{P}^{h,\textrm{MWLS}}\textrm{d}V=\mathbf{0}
	\end{aligned}
\end{equation}
where $\tau$ is the unknown scalar load factor, $\mathbf{f}^\textrm{h}_\textrm{ext,s}$ is the vector of externally applied forces and $\mathbf{f}^\textrm{h}_\textrm{int,s}$ is the vector of internal forces. The approximated Piola-Kirchhoff stress tensor for heterogeneous materials is expressed in terms of the density 
calculated using MWLS approximation, $\rho^{h,\textrm{MWLS}}$, as follows:
\begin{equation}
	\mathbf{P}^{\textrm{h},\textrm{MWLS}} = 
		\mathbf{P}(
		\mathbf{F}^\textrm{h}, \rho^{h,\textrm{MWLS}})
\end{equation}
% 
Discretisation of Eq.~\ref{eq:crack_local_first_law} establishes the material counterpart to Eq.~\ref{spatial_residual}, expressed as
\begin{equation}
\label{material_residual}
\mathbf{r}_\textrm{m}^\textrm{h}(\tilde{\pmb\uprho}(t), \tilde{\mathbf{x}}(t)) = \mathbf{f}^\textrm{h}_\textrm{res}-\tilde{\mathbf{G}}^\textrm{h}=\mathbf{0}
\end{equation}
$\tilde{\mathbf{G}}^\textrm{h}$ is the vector of nodal configurational forces that are only associated with nodes on the crack front:
\begin{equation}
\begin{aligned}
	\tilde{\mathbf{G}}^\textrm{h} =
	\int_{\mathcal{B}^h_t}
		\nabla_\mathbf{X}\pmb{\Phi}^\textrm{T} {\pmb\Sigma}^{h,\textrm{MWLS}}
	\textrm{d}V 
	+
	\int_{\mathcal{B}^h_t}
		\pmb{\Phi}^\textrm{T} \dfrac{\partial {\Psi}^{h,\textrm{MWLS}} }{\partial \rho^{h,\rm{MWLS}}}
		\left(
			\frac{\partial 
			\rho^{h,\textrm{MWLS}}}{\partial \mathbf{X}}
		\right)
	\textrm{d}V
	\label{eq:mat_int_front}
	\end{aligned}
\end{equation}
where the integration is restricted to elements adjacent to the crack front.
These configurational forces are the driving force for crack propagation. It should be noted that the second term of $\tilde{\mathbf{G}}^\textrm{h}$ reflects the influence of the spatially varying density. In the case of a homogeneous material, this second term would be zero. It should also be noted that this is only the case for the discretised configurational forces and that the continuum equivalent (Eq.~\ref{eq:crack_configuration_force}) is unaffected by variation in the density field.
% 
$\mathbf{f}^\textrm{h}_\textrm{res}$ is the vector of nodal material resistance forces, given as:
\begin{equation}
\mathbf{f}^\textrm{h}_\textrm{res}=\frac{1}{2}\left(\tilde{\mathbf{A}}_\Gamma^\textrm{h}\right)^\textrm{T}\mathbf{g}_\textrm{c}(\rho^{h,\textrm{MWLS}})
\end{equation}
where $\mathbf{g}_\textrm{c}$ is a vector of size equal to the number of nodes on the crack front. $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ defines the current orientation of the crack front and is a matrix comprising direction vectors along the crack front that are normal to the crack front and tangent to the crack surface:
\begin{equation}
\tilde{\mathbf{A}}_\Gamma^\textrm{h} = 
\int_{S^h_\Gamma}
\pmb{\Phi}^\textrm{T} 
\frac{\partial {A}^h_{\Gamma}}{
\partial \tilde{\mathbf{X}}}
\textrm{d}L
\end{equation}
$\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ is evaluated by only integrating over $S_\Gamma^\textrm{h}$ that defines the area of those triangular faces of tetrahedral elements that discretise the crack surface $\Gamma^\textrm{h}$ adjacent to the crack front $\partial\Gamma^\textrm{h}$.
$A^\textrm{h}_{\Gamma}$ is calculated as:
\begin{equation}
A^\textrm{h}_{\Gamma} = 	
	\| \mathbf{N}(\tilde{\mathbf{X}}) \|
=
\left\| 
\epsilon_{ijk}
\frac{\partial \Phi^\alpha}{\partial \xi_0}  
\frac{\partial \Phi^\beta}{\partial \xi_1} 
\tilde{X}^\alpha_j
\tilde{X}^\beta_k
\right\|
\end{equation}
where $\alpha, \beta \in \{0, 1, 2\}$ are the number of nodes of the triangle,
$i,j,k \in \{0,1,2\}$ are material indices, $\boldsymbol{\upepsilon}$~is the Levi-Civita tensor and $\xi_0$ \& $\xi_1$ are the directions of the parent coordinate system of the triangular element. 
Moreover, the total number of degrees of freedom on element is $3(N_{\rm{base}}+1)$ and the units of $\tilde{\mathbf{A}}_\Gamma^\textrm{h}$ are $[{\rm m}^{-1}]$. $\mathbf{N}$ are the normals to the crack surface $\Gamma$.

The resulting discretised weak form of the two conservation equations (\ref{spatial_residual} and \ref{material_residual}) represent a
set of coupled, nonlinear, algebraic equations that is solved in a monolithic manner using a Newton-Raphson scheme.
In addition, an arc-length method is adopted to trace the dissipative load path for brittle fracture propagation, using a prescribed incremental change in crack area as a control.

\subsection{Crack topology resolution}
\label{CrackTopology}
% 
Continuous crack surface evolution requires constant adjustments into finite element mesh during the analysis. In this work, the new crack front is generated by moving the nodes in the direction to establish equilibrium, resulting in maximum energy dissipation (see Eq.~\ref{eq:max_dissp}). The mesh is not split, or the connectivity changed. Once the quality of the elements deteriorates, typically after 3-4 advancements, the mesh is cut by the resulting new crack surfaces. Subsequently, the crack surface is remeshed; the surrounding elements are trimmed and merged. These procedures are executed in an iterative manner to minimise the number of distorted elements in the new mesh. Nevertheless, the reconstructed crack surface can occasionally still contain low quality elements (Jacobian $J < 0.1$), however, this deficiency is compensated by the use of higher-order and p-adaptive elements within hierarchical basis framework \citep{mofemJoss2020,Ainsworth2003}.
Finally, after rebuilding the mesh around the crack surfaces, the field of material parameters (density) is mapped onto new elements. The data is stored on the vertices of a background mesh which does not change throughout the analysis. During the assembly process for each new step, using meshless MWLS, the data is approximated from the neighbour vertices to any considered material point of the new mesh. A schematic procedure of this process is shown in Figure~\ref{fig:crack_procedure}.
% 
% % 
% % 
% In the process of moving the crack front nodes, the mesh quality can deteriorate leading to numerical errors. One of the solutions to overcome this is to refine the mesh surrounding the crack tip after certain (usually three) number of load steps. 
\begin{figure}
	\centering
			\begin{tikzpicture}
		\node at (0,0) {			\includegraphics[width=8cm]{Figures/crack_procedure.pdf} };
		\node at(0,1){a) \hspace{4.5cm} b)  \hspace{4.5cm} };
		\node at(0,-3){c) \hspace{4.5cm} d)  \hspace{4.5cm} };
		\end{tikzpicture}

		\caption{a) Nodal configurational force. b)~Crack front extension. c)~Mesh reconstruction around the tip. d)~MWLS mapping onto new material points.}
		\label{fig:crack_procedure}
\end{figure}

\subsection{Singularity element}
\label{sec:singularity}
For the purposes of determining parameters such as stress intensity factors, it can be useful to reproduce the singular stress field at the crack front. However, conventional finite elements that adopt polynomial approximation functions are unable to do this. 
In this paper, a new type of finite element with hierarchical approximation functions that overcome this problem is utilised. This is inspired by the so-called quarter-point elements, originally developed in the 1970s, whereby the mid-node of all edges connected to the crack front node were shifted to the quarter-point~\cite{barsoum1976use,henshell1975crack}. 
% 
The result of this shift is a nonlinear mapping between natural (isoparametric) and local coordinates $\xi \rightarrow \mathbf x$ which produces the square root singularity. Stress and strain fields are dependent on the radial function of the crack front, approaching infinity at the front. 
% 
A detailed derivation of the Jacobian for three-dimensional quarter-point elements can be found in, for example in~\citep{nejati2015use}. 
The influence of using this element on calculating the stress at the crack front is investigated in Section~\ref{sec:release_energy_rate}.
% However, for simplicity, we present the main attributes in this paper in 1D.

% For elements adjacent to the crack tip in the material configuration, the approximated material displacement field, using hierarchical shape functions (up to 2nd order), is expressed as:
% \begin{equation}
% \label{eq:hierarchical_u}
% \begin{split}
% W(\xi) =& \sum_{a=0}^2 N_a (\xi) W^{(a)} = \\
% & (1 -\xi)W^{(0)} + \xi W^{(1)} + \kappa (1 - \xi) \xi W^{(2)}
% \end{split}
% \end{equation}
% where the natural coordinate $0\le \xi \le 1$ and $N_2 = \kappa N_0 N_1 =  \kappa\xi(1 - \xi)$. The parameter $\kappa$ is introduced, resulting in a nonlinear mapping between the natural and physical coordinates and leading to the desired singular stress and strain field at the crack tip. 

% Adopting an isoparametric formulation, the element geometry can also be interpolated using the same approximation functions as for $W$. Thus, the physical distance from the crack tip is expressed as:
% \begin{equation}\label{eq:hierarchical_r}
% r_{\rm q}(\xi) = \sum_{a=0}^2 N_a (\xi) r_{\rm q}^{(a)} = \xi l + \kappa \xi(1-\xi)  l 
% \end{equation}
% where $r_{\rm q}(\xi=0)=0$ at the crack tip and $r_{\rm q}(\xi=1)=l$. Setting $\kappa=-1$ results in the following relationship:
% \begin{equation}
% r_{\rm q}= \xi l - \xi(1-\xi)l= \xi l \quad \Rightarrow \quad \xi = \sqrt{\frac{r_{\rm q}}{l}},
% \end{equation}
% This  yields the following radial dependence for displacements and strains:
% \begin{equation}\label{eq:singstrain}
% \begin{aligned}
% W(r_{\rm q}) &= W^{(0)} - W^{(2)} \frac{r_{\rm q}}{l} \\ 
% &+ \left( -W^{(0)} + W^{(1)} - W^{(2)} \right) \sqrt \frac{r_{\rm q}}{l} \\
% \varepsilon(r_{\rm q}) &= \frac{\partial W}{\partial r_{\rm q}} =  W^{(2)} \frac{1}{l} \\
% & + \left( W^{(0)}  + W^{(1)} - W^{(2)}  \right) \frac{1}{2} \sqrt \frac{l}{r_{\rm q}} \\
% \end{aligned}
% \end{equation}
% Eq.~(\ref{eq:singstrain}) has the necessary terms to reproduce rigid body motion and pass the patch tests, as well as the desired singularity at the crack tip due the existence of the term $1 / \sqrt r_{\rm q}$. This will enable the elements adjacent to the crack front to reproduce the strain singularity resulting in an accurate finite element solution~\cite{nejati2015use}. 
% The influence of this approach for tetrahedral elements will be investigated in Section~\ref{sec:release_energy_rate}.
% 
\section{Numerical examples}
\label{sec:numerical_examples}
Several numerical examples are presented to illustrate each aspect of the proposed formulation. 
The accuracy of the calculated energy release rate and the performance of the singularity element formulation is demonstrated in Subsection~\ref{sec:release_energy_rate} using a finite plate with a through-thickness crack and subjected to uniaxial stress. Moreover, in Section~\ref{sec:crack_propagation_FGM}, 
the framework is compared against experimental and numerical data from literature for functionally graded materials.
The final example considers fracture propagation of equine bone using experimental density data presented in Section~\ref{sec:mc3_release_eng}. 
% 
% 
% 
% For Case~3, a more moderate value for the exponent in the bell function was chosen along with a narrower density range than those chosen for Case~2 (see Table~\ref{tab:three_cases}).
% The plot presented in Figure~\ref{fig:density_bell2} demonstrates how these values influence the results of the analysis. 
% It is evident that with a much lower value for exponent, $b$, the algorithm no longer has problems converging. 
% Furthermore,  reducing the range between the upper and lower bounds of density has a significant impact on the results. 
% The dense cortical shaft on the dorsal side of the bone is less dense and covers a much larger region. 
% Furthermore, unrealistically low values of densities have been eliminated. 
% However, as with the previous case, the overall solution converges to the same mass as in Case~1, albeit requiring significantly more time steps. \\

\subsection{Stress intensity calculations}
\label{sec:release_energy_rate}
To examine the calculation of configurational forces at the crack front in bodies with both homogeneous and heterogeneous density distributions, five numerical examples are presented.
First, a simple quasi-two-dimensional plate with a through-thickness crack and homogeneous material distribution is considered.  The convergence study utilises an approximate solution from the literature as a reference.
Second, the proposed singularity elements are included for the same plate problem and their influence on the rate of convergence is presented. 
Third, the same problem is considered again but with a heterogeneous material distribution.
The final two examples demonstrate the calculation of configurational forces for a more representative problem of an equine bone.
 
\subsubsection{Finite plate with a horizontal crack}\label{sec:plate_section}
A finite plate with height, $h = 10$, thickness $t=1$ and half width $b = 2.5$ and a horizontal through-thickness crack with half width $a = 1$, as presented in Figure~\ref{fig:plate_load_mesh}(a), is considered. All input parameters are dimensionless. 
The  plate is spatially discretised using 1384 tetrahedral elements and subjected to uniaxial stress in the longitudinal direction, as indicated in Figure~\ref{fig:plate_load_mesh}(b). 
Displacements are constrained on three vertices to prevent rigid body motion.

\begin{figure}[h!]
\begin{center}
\begin{tabular}{c}
{\def\svgwidth{8cm} \input{Figures/InfSlab.pdf_tex}}\\
\end{tabular}
\caption{Finite plate with a horizontal crack. a) Plate geometry with through thickness crack. b) Finite element mesh: grey elements have approximation order $p_{\rm g}$; yellow elements have vertices at crack front and have approximation order $p_{\rm l}+p_{\rm g}$. }
\label{fig:plate_load_mesh}
\end{center}
\end{figure}

The purpose of this analysis is to calculate the Mode-I stress intensity factor $ K_{\rm I} $ directly from the configurational forces and compare with the solution~\cite{rooke1976compendium} for a finite plate:
\begin{equation}\label{eq:frac_analytical}
K_{\rm I}=\sigma \sqrt{\pi a} \left[  \frac{1 - \frac{a}{2b} + 0.326 (\frac{a}{b})^2 }{\sqrt{1-\frac{a}{b}}}  \right]
\end{equation}
where $\sigma $ is the applied stress. 
Young's modulus $E$ and Poisson's ratio $\nu$ are $1000$ and $0.3$, respectively. 


Hierarchical approximation functions allow for global and local $p$~-~refinement without changing the mesh.
In general, all tetrahedra of the mesh have a global order of approximation, $p_{\rm g}$, with some elements subjected to local refinement of order $p_{\rm{l}}$.
All analyses presented were run using the same mesh with $p$~-~refinement varying from 1\textsuperscript{st}-order to 6\textsuperscript{th}-order so that $p_{\rm l} + p_{\rm g} \leq 7$.
Assuming plane stress conditions, the Mode-I stress intensity factor, $K_{\rm I}$, was calculated directly from the output configurational forces as: 
\begin{equation}\label{eq:SIF_g_c}
K_{\rm I} = \sqrt{GE}
\end{equation}
where $G$ is the change of elastic strain energy per unit area of crack growth.
From Figure~\ref{fig:plate_conv}(a), it is evident that, for the same coarse mesh and number of nodes, the solution can improve drastically when the order of approximation is increased. 
The well known shear locking associated with first-order approximation is observed. 
The minimum error achieved is $0.50\%$ for all the cases with total order of approximation  $p_{\rm l} + p_{\rm g} = 7$. 
Therefore, it can be observed that using a low order of global approximation plus local $p$~-~refinement 
can achieve the same level of accuracy as using a global high order approximation, but with fewer degrees of freedom and lower computational cost.
\begin{figure}[h]
	\centering

	\input{Figures/tikz/legend1.tex}
	\begin{minipage}{.45\textwidth}
		% \hspace{-0.5cm}
		\begin{tikzpicture}
			\node at (0,0)   {		\input{Figures/tikz/plate_conv_no_sing.tex} };
			\node at (-1.2,-1.1){$0.50\%$};
			\node at (0,0) {};
			\end{tikzpicture}
		\begin{centering} a) \end{centering}
	\end{minipage}%
	% \quad \quad \quad
	\begin{minipage}{.45\textwidth}
		% \vspace{-0.25cm}
		\begin{tikzpicture}
			\node at (0,0){	\input{Figures/tikz/plate_conv_singularity.tex} };
			\node at (-1.2,-1.0){$0.028\%$};
	\end{tikzpicture}
\begin{centering} b) \end{centering}
	\end{minipage}
				% \begin{centering} (a)\hspace{7cm}(b) \end{centering}
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$. Relative error (\%) versus no. of DOF (log10) for a) using hierarchical approximation functions and b) using singularity elements.}
			\label{fig:plate_conv}
\end{figure}


From the results in Figure~\ref{fig:plate_conv}b) it is evident that using singularity elements improves the convergence rate significantly and lowers the error by an order of magnitude, from 0.50\% down to 0.028\%. 
However, it can also be seen that for each combination of $p$~-~refinement, the error increases with further refinement after it reaches the minimum value. 
This suggests that the solution cannot be further improved by enhancing the order of approximation alone. 
Reducing the elements size ($h$~-~refinement) and increasing the plate dimensions to better replicate the plane stress conditions used to determine the approximate solution, could potentially improve the solution. 
Nevertheless, the results are considered sufficiently accurate for the purpose at hand. 

Overall, these results indicate that singularity elements provide significant benefit, since they improve the accuracy of the solution with no extra cost.
Furthermore, the difference in execution time for the analysis with and without their inclusion was negligible. 

\subsubsection{Heterogeneous material}

So far the numerical examples have assumed homogenous material properties. Here we consider the effect of a heterogeneous density distribution (and therefore Young's modulus and fracture energy). 
Considering the same problem of the finite plate with horizontal crack, a density field $\mathbf{\rho}(x,y,z) = 0.125y + 1$ is directly assigned to the integration (Gauss) points of each tetrahedral element. Exponent $n$ and reference density $\rho_{0}^{\ast}$ (see Eq. \ref{eq:piola_heter}) are both equal to 1.
As expected, configurational forces are induced at the crack front under load and, as explained in Section \ref{sec:fem_fracture_prop}, these forces are influenced by the non-uniform density distribution. 
It is important to note that, in the case of heterogeneous materials, the stress intensity factors or J-integral are difficult to calculate or obtain experimentally \citep{fischer_problems_2014}. Due to the inhomogeneities, the J-integral becomes path dependent and requires special correction terms to be computed \citep{eischen_fracture_1987, chang_extension_2002}. 
% There is no agreed approach to validate either configurational forces or stress intensity factors for such cases (except for the special case of functionally graded materials~\cite{kim2002finite}).
%, by using MWLS method, demonstrated in Section~\ref{sec:mwls}.

A straightforward verification can be performed by using a central difference numerical integration. The energy release rate for crack growth can be calculated as the change in elastic strain energy per unit area of crack growth~\cite{Griffith163}:
\begin{equation}
G = \frac{\partial \psi}{\partial a}
\end{equation}
where $\psi$ is the elastic energy of the system, and $a$ is the crack length. This derivative can be approximated as:
\begin{equation}
 \frac{\partial \psi}{\partial a} = \lim_{\Delta a \to 0} \frac{\psi(a + \Delta a) - \psi(a -\Delta a)}{2\Delta a}
 \label{eq:fdm_crack}
\end{equation}
where the elastic strain energies $\psi(a \pm \Delta a)$ is obtained from two additional analyses with horizontal cracks of lengths: ($a + \Delta a$) and ($a - \Delta a$), where $\Delta a$ is a very small value. 
Next, knowing the resulting energy release rate with the crack length of $a$, a relative error can be calculated.
Twenty-four analyses, for different levels of $p$~-~refinement and values of $\Delta a$, have been undertaken in order to determine the error in the energy release rate. 
The results are presented in Figure~\ref{fig:covergencefdm}, where it is apparent that the error in fracture energy release rate is converging to 0.3\% 
with increasing levels of refinement. It is worth noting that a similar level of accuracy was attained for the homogeneous case.  Achieving higher precision with this means of validation is difficult due to the accumulation of truncation, approximation and discretisation errors. Moreover, it is worth to note that calculating energy release using Eq.~\ref{eq:fdm_crack} is not suitable for any practical analyses as it can be only used for simple crack paths, it is computationally expensive and potentially unstable for sufficiently low $\Delta a$.
Therefore, it can be concluded that the proposed estimation of fracture energy release rate for heterogeneous materials is obtained with a satisfactory level of accuracy.
\begin{figure}[h]
	\centering
%	\includegraphics[width=0.7\linewidth]{Figures/tikz/covergence_FDM.png}
	\begin{tikzpicture}
		\node at (0,0){\input{Figures/tikz/covergence_FDM.tex}};
		\node at (-1.8,-0.7) {	\includegraphics[width=1cm]{Figures/tikz/gradient.png}};
		\node at (-0.2,-1.5){$0.3\%$};
		\end{tikzpicture}
	\caption{Convergence plot for stress intensity factor $K_{\rm I}$ for heterogeneous density distribution. Relative error (\%) versus no. of DOF (log10).}
	\label{fig:covergencefdm}
\end{figure}

\subsection{Crack propagation in FGMs} \label{sec:crack_propagation_FGM} 
% 
The correct implementation and performance of the presented computational method is demonstrated by means of two 3D numerical examples of crack propagation in functionally graded materials. In order to validate the numerical results, we adopt examples reported by \cite{kim2004simulation}, who compared their analyses against experimental data \cite{galvez1996crack, rousseau2000compositionally}. The examples consider crack propagation in graded beams under three-point bending. Figure~\ref{fig:fgm_mesh_load} shows specimen geometries, discretisation and boundary conditions for two cases: (a) simple symmetric three-point bending and (b) considering offset loading which results in a mixed mode crack evolution. Discretisation is undertaken using 3D quadratic tetrahedral elements with an additional local $p$~-~refinement (increased polynomial degree) around the crack tip, where 3rd order polynomials are used.
\textcolor{red}{Throughout the analyses, mesh addapts to crack propagation according to an $h$~-~~$p$~-~refinement scheme as mentioned in Section~\ref{CrackTopology}} 

The analyses consider two materials: homogeneous poly-methyl-methacrylate (PMMA) and linearly graded polymer, where Young's modulus $E$ and fracture toughness $K_\mathrm{Ic}$ are linearly varying from top to bottom. The numerical values of material properties for PMMA are as follows: $E$ = 2890~${\rm {[MPa]}}$, $\nu$ = 0.4,  $K_\mathrm{Ic}$ = 1.09 [MPa $\sqrt{\mathrm m}$] and for the graded case values at top and bottom points are shown in Table~\ref{tab:parameters_fgm}. Note that due to current limitations of the implementation the Poisson's ratio is assumed to be constant (unlike in original work of \cite{kim2004simulation} where the used ratio was varying from 0.39 to 0.41). 
% 
\begin{table}[h]
	\centering
	\begin{tabular}{llll}
		\hline
		Y [mm]            \hspace{1.0cm} 	&  $E$ [MPa] \hspace{1.0cm} & $\nu$    \hspace{1.0cm}     & $K_\mathrm{Ic}$ [MPa $\sqrt{\mathrm m}$]  \\ \hline
		$0  $              \hspace{1.0cm}   &  1780  	 \hspace{1.0cm}	& 0.4      \hspace{1.0cm}  		&  0.99\\
		$60  $            \hspace{1.0cm}   &  4000  	 \hspace{1.0cm}	& 0.4      \hspace{1.0cm}     &  1.19 \\
		\hline
	\end{tabular} 
	\caption{Material parameters used for FGM simulations. Relationship between $K_\mathrm{Ic}$ and $g_{\rm c}$ can be found in Eq.~\ref{eq:SIF_g_c}.}
	\label{tab:parameters_fgm}
\end{table}
% 
% 
% 
\begin{figure}[h!]
	\centering
	\begin{center}
	\def\svgwidth{12cm} \input{Figures/fgm_geom.pdf_tex}
	\caption{FGM example: A crack in a beam subjected to three-point bending. Geometry, boundary conditions and initial discretisation for (a) Case 1: symmetric loading, (b) Case 2: offset loading. Units in [N], [mm]. Note that in both cases the total force P is applied in the form of uniformly distributed pressure on a block with dimensions: 2.25x4.5x18 [mm]. The initial meshes consists of 1751 and 1794 quadratic tetrahedral elements.}
	\label{fig:fgm_mesh_load}
	\end{center}
\end{figure}
% 

The arc-length control is adopted to trace the nonlinear response, using an adaptive crack area increment with a target of $\Delta s$ = 5 $[\mathrm{mm}^2]$ per load step. Figure~\ref{fig:fgm_case1} shows comparison of load versus crack mouth opening displacement (CMOD) curves for both a homogeneous and a functionally graded beam for Case 1 (symmetric loading) obtained by the presented approach and compared with results from the literature~\citep{kim2004simulation}, with which there is good agreement. Due to symmetry, the crack is in pure Mode-I and therefore the resulting crack is a plane surface. It is evident that the material gradation results in an increased critical load $P$. 
% 
% 
\begin{figure}
	\centering
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fgm_case1.tex} };
	\node at (2.0,-0.2) {	\includegraphics[width=7cm]{Figures/pngs/fgm_case1crack.png}};
	\node at (2.0,-1.2) {3D view};
	\end{tikzpicture}
	\caption{Case 1: Comparison of Load - CMOD curves for homogeneous and FGM beams obtained by \citep{kim2004simulation} and the present numerical analysis (MoFEM). 3D view of final crack surface and FE mesh \textcolor{red}{as a result of the implemented mesh cutting addaptive $h$~-~~$p$~-~refinement scheme}.}
	\label{fig:fgm_case1}
\end{figure}
% 
% 
Figure~\ref{fig:fgm_case2} presents a comparison of load versus CMOD curve for both a homogeneous and a functionally graded beam for Case 2 (mixed-mode). Once again, the numerical results from the presented work are compared to results from the literature~\citep{kim2004simulation}. It can be noticed that the peak loads and initial stiffness obtained by the proposed approach are slightly lower than those obtained in the literature. This can be explained by the influence of the initial crack. As shown in Figure~\ref{fig:fgm_mesh_load} the initial crack is short and vertically aligned, in comparison to the resulting crack surfaces shown in \ref{fig:fgm_crack_path_comapre}, where the crack trajectory curves towards left hand side. In the first few loading steps the crack reorientates towards a pure Mode-I situation, therefore the initial load required for crack propagation is different than in the literature. A few load steps after the peak load, the curves are in very good agreement. 
% 
\begin{figure}
	\centering
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fgm_case2.tex} };
	\node at (2.0,-0.2) {	\includegraphics[width=7cm]{Figures/pngs/fgm_case2crack.png}};
	\node at (2.0,-1.2) {3D view};
	\end{tikzpicture}
	\caption{Case 2: Comparison of Load - CMOD curves for homogeneous and FGM beams obtained by \citep{kim2004simulation} and the present numerical analysis (MoFEM). 3D view of final crack surface and FE mesh \textcolor{red}{as a result of the implemented mesh cutting addaptive $h$~-~~$p$~-~refinement scheme}.}
	\label{fig:fgm_case2}
\end{figure}

It can be noticed in both 3D views in Figures~\ref{fig:fgm_case2} and \ref{fig:fgm_crack_path_comapre}, that the density of the final FE mesh is increased along the crack surfaces due to mesh cutting and adaptive refinement triggered every three load steps. Nevertheless, the resulting meshes are relatively coarse for 3D analysis with 3515 and 8079 elements for Case 1 and Case 2, respectively.
% 
% \begin{figure}
% 	\centering
% 	\begin{tikzpicture}
% 	\node at (0.0,0.) {	\includegraphics[width=10cm]{Figures/pngs/fgm_case1crack.png}};
% 	\node at (0.0,-5) {	\includegraphics[width=10cm]{Figures/pngs/fgm_case2crack.png}};
% 	% \node at (3.0,-2.5) {3D view};
% 	% \node at (3.0,-2.5) {a)};
% 	% \node at (3.0,-2.5) {b)};
% 	\end{tikzpicture}
% 	\caption{gdsfgsdfgsdfgdsfgdsfg}
% 	\label{fig:fgm_crack_surfaces}
% \end{figure}


Figure~\ref{fig:fgm_crack_path_comapre} shows comparison of the predicted crack path and experimental results for Case 2 (offset loading, leading to mixed mode loading at the crack front). The presented approach shows an excellent agreement with the experimentally obtained crack path and an improvement on previously documented 2D analyses \cite{kim2004simulation}. 
Within the framework of linear elastic fracture mechanics, although spatially varying material properties has no effect on the crack path for these particular problems, the ultimate load is influenced.
% 
\begin{figure}
		\centering
		\begin{tikzpicture}
		\node at(0.,0){  	\input{Figures/tikz/cracks_fgm_compar.tex} };
		\node at (3.0,-0.35) {	\includegraphics[width=3.5cm]{Figures/pngs/fmg_crack_path_cropped.png}};
		\node at (3.0,-2.35) {3D view};
		\end{tikzpicture}
		\caption{Comparison of crack paths obtained experimentally by \cite{galvez1996crack}, numerically by \citep{kim2004simulation} and by the proposed approach (MoFEM).}
		\label{fig:fgm_crack_path_comapre}
\end{figure}
% 
% 
\subsection{Fracture energy release rate for metacarpal bone} 
\label{sec:mc3_release_eng}
% 
The fracture of an equine 3rd metacarpal bone is now presented.
Horse fatalities at racecourses are often directly or indirectly associated with a fracture, with the distal limb the most commonly affected site \cite{parkin2004risk}.
Most of these fractures occur due to the accumulation of tissue fatigue, as a result of repetitive loading~\cite{Parkin2005}, rather than a specific traumatic event. 
Intense exercise and excessive loading of the metacarpal bones results in maladaptation. 
The location of 3rd metacarpal fractures is remarkably consistent across a large number of racehorses,  with crack initiation presenting from 
the lateral para-sagittal groove of the distal condyle of the leading forelimb~\cite{jacklin2012frequency, parkin2006analysis}.
Despite considerable research in the field, including applying diagnostic methods such as radiography 
\cite{bogers2016quantitative, crijns2014intramodality, loughridge2017qualitative}, magnetic resonance imaging 
\cite{tranquille2017MRI} and biomarkers~\cite{mcilwraith2005use}, it still remains a challenge to accurately predict the fracture risk and prevent this type of significant injury.

Various theories exist in the literature regarding failure criteria for bone tissue and it is now common practice for researchers to estimate fracture resistance within the framework of FEM. In particular, subject-specific FEM models can potentially quantify the risk of failure under a given loading scenario. However, this still remains an open challenge.

In recent years, the main focus in bone mechanics has been in the use of different strength criteria for the onset of failure. 
The most commonly adopted ones were based on stress~\cite{keyak2005predicting} or strain measures~\cite{schileo2008subject} assuming bone failure is determined by a yield criterion~\cite{yosibash2010predicting}. 
Experimental validation of such simplified models show that there is a significant spread in the predicted failure, with errors between 10\% and 20\%~\cite{van2014accurately}.
This variation is perhaps explained by the focus on both the use of strength criteria, rather than energy (as in this paper), and the local initiation of failure, rather than the complete failure mechanism.
The fracture process of bone is very important,  particularly in the case of fatigue fractures~\cite{gupta2008fracture}. 
Limitations in previous studies (e.g. use of 2D geometry~\cite{bettamer2017using}, assuming homogeneous bone properties~\cite{gasser2007numerical}), 
can also explain why an appropriate model for bone fracture has not been developed previously.

The material parameters for the following analyses are presented in Table~\ref{tab:parameters_mc3}. 
The elastic properties for both cortical and trabecular bone are approximated using a power law derived from mechanical tests of MC3 bone~\cite{Les1994}. 
Such empirical elasticity-density relationships are commonly adopted in finite element investigations of bones \citep{helgason2008mathematical}. 
Note that the stress is scaled depending on density as shown in Eq.\ref{eq:piola_heter}, which is equivalent to spatially varying Young's modulus (e.g. like in FGM). Due to lack of experimental data, the fracture energy $g_{\text c}$ is assumed constant for the entire domain. 
% Each case considers a different function for the parameter $c$ that defines the rate of bone adaptation and is used to compute the mass source, $\mathcal{R}_0$, according to Eq.~(\ref{eq:mass_source}).
% In Case~1, $c$ is constant. For Case~2 and Case~3 different bell functions (Eq.~(\ref{eq:bell_function})) are used. The parameters for each case are presented in Table~\ref{tab:three_cases}. 
 % is not sensitive to the initial density
Boundary conditions are simplified to two representative forces (5~$\text{[kN]}$~each) spanning over a small area based on pressure film studies~\cite{Brama2001}, as illustrated in Figure~\ref{fig:mc3_BC}. 
The two forces are often considered in the literature as an equivalent of joint peak force at the mid-stance of a horse gait. Obviously, with such simplified loading case the analysis is not sufficient to produce any quantitative results regarding critical loading for the metacarpal but rather to demonstrate the potential of this approach. 
\begin{table}[h]
	\centering
	\begin{tabular}{lll}
		\hline
		 Param.             & Description                  & Value  \\ \hline
		$E  $                 & Young's modulus              & $4700 \,\mathrm{ [MPa]}$ ~\cite{Les1994} \\
		$\nu  $               & Poisson's ratio                & $0.3 \,\mathrm{ [-]}$ \\
		$g_{\text c}$					&	Fracture energy							 &  $2.0\,[\mathrm{ N/mm}]$ \\
		$n$                   & Porosity exponent            & $2.25 \,\mathrm{ [-]}$     ~\cite{Les1994}   \\ 
		\hline
	\end{tabular} 
	\caption{Material parameters used for the simulations of 3rd metacarpal bone adaptation.}
	\label{tab:parameters_mc3}
\end{table}
% 
% \begin{table}[h]
% 	\centering
% 	\begin{tabular}{lllll}
% 		\hline
% 		Case                  & $c$              				       & $b$     &$\rho^\mathrm{max}$               &$\rho^\mathrm{min}$ \\ \hline
% 		1                     & 1              								 & -       & -                                & -\\
% 		2                     & Eq.~(\ref{eq:bell_function})   & 1000    & 2.5~$[{\text{g/cm}}^3]$          & 0.3~$[{\text{g/cm}}^3]$\\
% 		3                     & Eq.~(\ref{eq:bell_function})   & 30      & 1.8~$[{\text{g/cm}}^3]$          &1.0~$[{\text{g/cm}}^3]$ \\
% 		\hline
% 	\end{tabular} 
% 	\caption{Presentation of three cases input parameters for the evaluation of coefficient $c$ to compute mass source, $\mathcal{R}_0$, as presented in Eq.~(\ref{eq:mass_source}). All cases have common material input parameters presented in Table~\ref{tab:parameters_mc3}.}
% 	\label{tab:three_cases}
% \end{table}
% 
\begin{figure}[h]
	\begin{center}
		   \begin{tikzpicture}
				\node at (0,0) {\includegraphics[width=7cm]{Figures/mc3_BC.png}};
				\node at(-2.5,-1.8){$F = 5 \mathrm{kN}$ };
				\node at(-3.1,-0.3){ $F = 5 \mathrm{kN}$ };
				\node at(2.5,-0.3){ Fixed end };
	\end{tikzpicture}
		\caption{Finite element mesh of the equine 3rd metacarpal bone. To simulate the peak load of a gallop, 5 kN forces are applied on the lateral and medial side of the distal condyle.}
		\label{fig:mc3_BC}
	\end{center}
\end{figure}
% 
% 
Using a $\mathrm {K_2 HPO_4}$ calibration phantom, grey scale values from CT scans are converted to bone mineral density 
using five tubes with reference densities. 
The mechanical material properties were mapped onto the integration points of the mesh of the metacarpal bone using the MWLS method described in~\ref{sec:dens_mapping}. 
% 
An initial crack was generated in the mesh using a cutting plane, as shown in Figure~\ref{fig:bone_ct_mesh_cut}. A notch is situated at the origin of the most common location of a lateral condyle fracture~\cite{jacklin2012frequency}.
\textcolor{red}{For crack propagation, mesh cutting scheme with addaptive $h$~-~~$p$~-~refinement was proved succesful in the presence of the challenging equine 3rd metacarpal bone geometry.}

The numerical analyses were undertaken using three meshes consisted of 6069, 10032 and 21189 tetrahedrons and repeated for 1\textsuperscript{st}, 2\textsuperscript{nd} and 3\textsuperscript{rd}-order of global $p$~-~refinement and local $p$~-~refinement at the crack tip. The finite element meshes were generated by discretising the segmented geometry of a full-scale model of an equine 3rd metacarpal bone derived from CT scan data - see Figure~\ref{fig:mc3_BC}.
% 
The application of load induces configurational forces at the crack front, as shown in Figure~\ref{fig:crackfrontforce}. 
The direction of the vectors also indicates the direction of crack propagation.
%When these forces, attain the critical value, crack growth is spontaneous and catastrophic.  
The values of numerically predicted maximal nodal fracture energy release rates in Mode-I (crack opening) for subsequent meshes are plotted in Figure~\ref{fig:max_g1_convergece}. 
It can be seen that, for the same mesh, as the order of approximation increases, the energy release rate converges. 
%with increasing order of approximation material forces converge.
% \begin{figure}[h]
% 	\centering
% 		\def\svgwidth{7cm}
% 		\input{Figures/bone_ct_mesh_cut.pdf_tex}
% 	\caption{Bone geometry with density mapped from CT using MWLS. Initial crack introduced by cutting the mesh with a circular surface.}
% 	\label{fig:bone_ct_mesh_cut}
% \end{figure}

% \begin{figure}[h!]
% 	\centering
% 	\def\svgwidth{7cm}
% 	\input{Figures/crack_front_force.pdf_tex}
% 	\caption{Crack surface and configurational forces at the crack front.}
% 	\label{fig:crackfrontforce}
% \end{figure}
% 
% 
% 
% 
\begin{figure*}[h]
	\centering
	\begin{minipage}{.45\textwidth}
		\def\svgwidth{6.5cm}
		\input{Figures/bone_ct_mesh_cut.pdf_tex}
	\captionof{figure}{Bone geometry with density mapped from CT using MWLS. Initial crack introduced by cutting the mesh with a circular surface.}
	\label{fig:bone_ct_mesh_cut}
	\end{minipage}%
	\hspace{0.5cm}
	\begin{minipage}{.45\textwidth}
		\def\svgwidth{6.5cm}
		\input{Figures/crack_front_force.pdf_tex}
		\captionof{figure}{Crack surface and configurational forces at the crack front.}
		\label{fig:crackfrontforce}
	\end{minipage} \\
	\end{figure*}
% 
% 
\begin{figure}[h!]
	\centering
	\input{Figures/tikz/max_g1_convergece.tex}
	\caption{Convergence plot of fracture energy release rate versus no of DOF (log10) for subsequent discretisations and $p$~-~refinements.}
	\label{fig:max_g1_convergece}
\end{figure}
A crack will propagate when the energy release rate rate equals the material's resistance to crack extension, $g_{\rm c}$. Assuming $g_{\rm c} = 2.0\,[\mathrm{ kN/m}]$~\cite{gasser2007numerical}, it can be estimated that for this particular metacarpal bone with this initial crack, loading can be increased by a factor of approximately 4.4 before a fracture starts to propagate. 
% 
% 
% 
% \subsubsection{Fracture energy release rate for adapted bone}
% The previous example is extended to investigate the likelihood of fracture in an equine metacarpal bone at different phases of adaptation during training.
% However, this time, densities from a bone adaptation analysis (Section~\ref{sec:numerical_examples:bone_adap}) are mapped onto the coarse mesh, as shown in Figure~\ref{fig:frackmeshcutting}. 
% \begin{figure}[h]
% 	\centering
% 			\def\svgwidth{7cm}
% 		\input{Figures/frack_mesh_cutting.pdf_tex}
% 	\caption{Density distribution from bone adaptation analysis mapped onto fracture analysis mesh. Initial crack created using the cutting plane shown.}
% 	\label{fig:frackmeshcutting}
% \end{figure}
% The resulting energy release rate at different points in time of bone adaptation are illustrated in Figure~\ref{fig:crackmc3release} for three different local $p$~-~refinements. It can be seen that the variation in energy release rate for increased orders of approximation at the crack front is very small. 
% \begin{figure}[h!]
% 	\centering
% %	\includegraphics[width=1\linewidth]{Figures/tikz/crack_mc3_release.png}
% 		\begin{tikzpicture}
% 			\node at(0,0){	\input{Figures/tikz/crack_mc3_release.tex}};
% 			\node at(0.2,0){ \includegraphics[width=5cm]{Figures/tikz/density_for_g1_conv.png}};
% 			\node at(1.5,-0.5){                    	\def\svgwidth{2.5cm} 	\input{Figures/scale_bars/scale_bar_density_rainbow.pdf_tex}  } ;
% 		\end{tikzpicture}
% 	\caption{Fracture energy release rate over time during bone adaptation for three local $p$~-~refinements.}
% 	\label{fig:crackmc3release}
% \end{figure}
% It can be seen that there is a trend of increasing release energy rate over time and that by introducing a notch in the resorption zone, where no loading is applied, the configurational force attains larger values. This indicates that over time the bone becomes more prone to fracture in this specific region. 
% 
\subsection{Crack propagation in bone}
In this section, we take the analysis further by simulating the full process of crack propagation in equine bone. 
The magnitude of applied forces (Figure \ref{fig:mc3_BC}) is controlled by the increment in crack area during each load step using an arc-length technique. 
The initial finite element mesh is the same as previously, although it is locally refined as the crack front advances. 
The heterogeneous density distribution is mapped from CT scan data. 
The mesh comprises 2nd order tetrahedral elements.
The numerically predicted crack path is shown in Figure~\ref{fig:crack_snapshots}. 
It can be seen that the crack shape is initially planar before curving towards the lateral side of the bone. This simulated crack path compares well with fractures observed in radiographs \cite{whitton2010third}, especially considering the simplified loading conditions. 
The load factor versus crack area plot is shown in Figure~\ref{fig:load_factor1}a). 
% Consistent with the previous analysis in Section~\ref{sec:mc3_release_eng}, the metacarpal bone shows a decreased resistance to fracture - i.e. for the same crack area, the remodelled bone requires much lower force (load factor) to induce crack propagation. Low density levels at biological equilibrium ($t=90$ and $t=200$) also influences the crack path, with the crack curving earlier than in the initial stages of remodelling. 
% \begin{figure}[h!]
% 	\centering
% 	\begin{tikzpicture}
% 	\node at(0.,0){  	\input{Figures/tikz/fracture/remodel_frac_compar.tex} };
% 	\node at (0.9,1) {	\includegraphics[width=4.5cm]{Figures/pngs/crack_surfaces_adapt.png}};
% 	\node at (1.8,-0.3) {	Crack surfaces};
% 	\end{tikzpicture}
% 	\caption{Load factor versus crack area for different moments in time during bone adaptation analysis. Bone density distribution influenced both load factor and the resulting crack surface.}
% 	\label{fig:crack_remodel_frac_compar}
% \end{figure}
% 
\begin{figure*}[h!]
	\centering
	\begin{centering}
			\begin{tikzpicture}
				\node at (0,0) {			\includegraphics[width=10cm]{Figures/pngs/crack_spatial_conf.png} };
				% \node at(1,-2.5){a) \hspace{2.5cm} b)  \hspace{2.5cm}  c)  \hspace{2.5cm}  d)  \hspace{2.5cm}  };
		\end{tikzpicture}
	\end{centering}		
		\caption{Crack surface evolution in equine 3rd metacarpal \textcolor{red}{based on an addaptive $h$~-~~$p$~-~refinement mesh cutting scheme}.}
		\label{fig:crack_snapshots}
\end{figure*}
% 
% 
Figure~\ref{fig:load_factor1}(a) compares results with and without using singularity element. Although the singularity element improves the accuracy of stresses at the crack front, as previously demonstrated (Figure~\ref{fig:plate_conv}(b)), it is evident that it has negligible influence on the overall response. Figure~\ref{fig:load_factor1}(b) compares the results with heterogeneous material properties to results with homogeneous properties. From the load-crack area curves, it can be observed that the heterogeneous nature of bone has a significant impact on the predicted response and crack path. 
% 
\begin{figure*}[h]
	\centering
	\begin{minipage}{.45\textwidth}
	\begin{tikzpicture}
		\node at(0.,0){  	\input{Figures/tikz/fracture/remod_heter_singular.tex} };
	\end{tikzpicture}
\end{minipage}%
\quad
\begin{minipage}{.45\textwidth}
	\begin{tikzpicture}
	\node at(0.,0){  	\input{Figures/tikz/fracture/homo_vs_het.tex} };
	\node at (1.1,0.35) {	\includegraphics[width=3.5cm]{Figures/pngs/crack_surf_heter_compar.png}};
	\end{tikzpicture}
\end{minipage} \\
(a)\hspace{5cm} (b)
	\caption{Load factor versus crack area for (a) with and without singularity element and (b) homogeneous versus heterogeneous density distribution.}
	\label{fig:load_factor1}
\end{figure*}

% 
% 
Finally, we investigated $h$ and $p$ convergence. The results presented on the Figures \ref{fig:load_factor2}(a) and \ref{fig:load_factor2}(b) show good numerical convergence for consecutive refinements. It can be concluded that our formulation predicts the crack path accurately with minimal effect from the original mesh or order of approximation. 
% 
\begin{figure*}[h]
	\centering
	\begin{minipage}{.45\textwidth}
		\begin{tikzpicture}
			\node at(0.,0){ \input{Figures/tikz/fracture/real_fract_ct_h_ref.tex} };
		 \end{tikzpicture}
	\end{minipage}%
	\begin{minipage}{.45\textwidth}
		\begin{tikzpicture}
			\node at(0,0){         \input{Figures/tikz/fracture/real_fract_ct_p_ref.tex} };
		\end{tikzpicture}
	\end{minipage} \\
	(a)\hspace{5cm} (b)
			 \caption{Load factor versus crack area (a) $h$~-~refinement). (b) $p$~-~refinement.}
		 \label{fig:load_factor2}
	\end{figure*}
% 
% The simulated crack path using density data from CT scans compare well with fractures observed in radiographs \cite{whitton2010third}, especially considering oversimplified loading conditions. The direct comparison of the numerically predicted crack with a crack segmented from a different CT scan data, with developed MC3 fracture, fracture can be found in Figure~\ref{fig:real_fractures}
% % 
% \begin{figure}
% 	\centering
% 	\begin{tikzpicture}
% 		\node at(0.,0){\includegraphics[width=4cm]{Figures/ct_vs_fem_rad} };
% 		\node at(-0.5, -1.2){  a) \hspace{1.8cm} b) \hspace{1cm} };
% \end{tikzpicture} \\%
% 	\caption{a) Numerically predicted crack. b)~Bone with fracture segmented from CT scan data. }
% \label{fig:real_fractures}
% \end{figure}
% 
It is important to note that bone is generally regarded as a quasi-brittle material \cite{gasser2007numerical}. Therefore, the assumption of linear fracture mechanics has limited applicability and further developments should include cohesive effects, such as collagen fibre bridging. 

% 
\section{Discussion}\label{sec:discussion}
This paper has presented a mathematical formulation and computational modelling framework to investigate the 
influence of heterogeneous material properties on fracture resistance and fracture propagation. 
This was achieved through an extension of the authors' previous work on configurational mechanics for fracture, based on the assumption of maximal dissipation of energy and utilising the Griffith criterion. With no additional physical equations or material laws, this has been shown to be sufficient for modelling this class of problem.
Configurational forces are the driver for crack propagation and it was shown that in order to evaluate correctly these forces at the crack front it is necessary to have a spatially smooth density field, with higher regularity than if the field is directly approximated on the finite element mesh. 
Therefore, density data is approximated as a smooth field using a Moving Weighted Least Squares method. 
In this paper, the density fields were generated analytically, for FGMs, and from clinically available CT scan data for equine bone.
It is important to note that the adoption of configurational mechanics avoids the need for post-processing, since configurational forces are expressed exclusively in terms of nodal quantities.

% The constitutive model for bone adaptation included a bell function to define the rate of adaptation. 
% This did not enforce rigid bounds on density levels, but merely slowed down the rate of convergence to biological equilibrium. 
% This approach will be useful when trying fit model parameters to the actual density data from CT scans in defined periods of time. 
% It is also possible to enforce bounds on density levels by introducing and calibrating mass influx in the mass balance equation~\cite{sharma2013adaptive}. 

Numerical examples demonstrated the performance and accuracy of the proposed framework. 
Numerical convergence was demonstrated and the use of singularity elements was shown to further improve the rate of convergence. 
However, it was also confirmed that improved accuracy of the stress at the crack front had no impact on the crack propagation analysis and the resulting crack path. 
Analyses of functionally graded materials showed the ability of the proposed method to simulate experimental crack paths. 
The final example, demonstrated how mechanical loading influence the resistances to bone fracture while using experimental material data. 
Therefore, this framework will be a useful tool in understanding fractures in bone and ultimately preventing catastrophic fractures. 

All analyses were undertaken using the MoFEM library \cite{mofemJoss2020} that has been developed to support computational scalability and ensure robustness. 
The entire framework can be executed on parallel computer systems. Supplementary data (CT scans, mesh files, command lines) 
necessary to reproduce the results of all numerical examples can be found in~\cite{karol_lewandowski_2019_dataset}. 
The fracture submodule in MoFEM~\cite{mofemJoss2020}, can be installed using the flexible package manager, Spack~\cite{spack2015}. 

% \newpage
\bibliographystyle{abbrv}
%\bibliographystyle{numeric}
%\bibliographystyle{spbasic}

\bibliography{bibfile}

\end{document}
